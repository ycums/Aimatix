# M5Stack Fire 集中タイマー 仕様書

## 概要
M5Stack Fire用の集中タイマーアプリケーション。アラーム機能付きのタイマーで、複数のアラーム時刻を管理できる。

## ハードウェア仕様
- **デバイス**: M5Stack Fire v2.7
- **SoC**: ESP32-D0WDQ6（240MHz デュアルコア、600 DMIPS、520KB SRAM）
- **フラッシュメモリ**: 16MB
- **PSRAM**: 8MB
- **画面**: 2.0インチ 320×240 ILI9342C IPSパネル（最大輝度 853nit、ガラスカバーパネル）
- **ボタン**: カスタム物理ボタン ×3（A, B, C）
- **RGB LED**: SK6812 ×10（通知機能として活用可能）
- **スピーカー**: 1W-0928（音声アラーム用）
- **マイク**: アナログ BSE3729（将来の音声入力機能用）
- **WiFi**: 内蔵（NTP同期用）
- **Bluetooth**: 内蔵（将来の連携機能用）
- **電源**: 内蔵リチウムイオンバッテリー 500mAh 3.7V
- **サイズ**: 54.0 × 54.0 × 28.6 mm
- **重量**: 88.8g

### ハードウェア制限事項
- **振動機能**: 非搭載（代替としてRGB LEDで通知）
- **外部振動モーター**: 未接続（Groveポート経由で追加可能）

### 将来拡張可能な機能
- **RGB LED通知**: アラーム時の色変更・点滅パターン
- **音声入力**: マイクを使用した音声コマンド
- **外部振動**: Groveポート経由での振動モーター接続
- **SDカード**: 設定データの永続化
- **Bluetooth連携**: スマートフォンアプリとの連携

## UI/UX仕様

### テーマ
- **Amber CRTテーマ**: 黒背景、アンバー文字のモノクロ風
  - メイン文字色: アンバー (`#FB20`, RGB565: R=31, G=22, B=0) - 確定
  - 背景色: 黒 (`#0000`) - 確定
  - 警告色: フラッシュオレンジ (`#F000`, RGB565: R=31, G=0, B=0) - バッテリー20%以下、アラーム画面（確定）
  - ハイライト: ネガポジ反転（選択項目の背景をアンバー、文字を黒）

### フォント
- **Font7**: 主要要素（時刻表示など）
- **Font4**: 二次要素
- **Font2**: ヒント・タイトルバー・ボタンヒント

### レイアウト
- **グリッドシステム**: 8x6グリッド（40x40px）
- **タイトルバー**: 上部固定（モード名 + バッテリー情報）
- **ボタンヒント**: 下部固定（物理ボタン位置に合わせて配置）

## データ永続化
- **Flash保存**: SSID/パスワード、LCD明度、音/振動設定
- **揮発性**: アラーム時刻（電源OFFでリセット）

## 画面仕様

### 1. メイン画面 (MAIN_DISPLAY)
- **表示内容**:
  - 日付（上部中央）
  - 現在時刻（中央上部）
  - 次のアラームまでの残り時間（中央、Font7）
  - プログレスバー（残り時間の視覚化）
  - アラームリスト（下部）
- **ボタン操作**:
  - A: 絶対時刻入力モード
  - B短押し: 相対時刻追加モード
  - B長押し: 相対時刻減算モード
  - C短押し: スケジュール選択
  - C長押し: 設定メニュー

### 2. 入力モード (ABS_TIME_INPUT, REL_PLUS_TIME_INPUT, REL_MINUS_TIME_INPUT)
- **表示内容**:
  - タイトルバー（モード名）
  - 時刻入力（中央、Font7、水平中央寄せ）
  - プレビュー表示（下部）
- **入力方式**: 桁ごと編集
  - カーソル位置: 0=時十, 1=時一, 2=分十, 3=分一
  - 初期値: 00:00
- **ボタン操作**:
  - A短押し: +1
  - A長押し: +5（0.5秒経過時点で1回）
  - B短押し: 桁送り
  - B長押し: リセット（1秒）
  - C: セット（確定）

### 3. スケジュール選択画面 (SCHEDULE_SELECT)
- **表示内容**:
  - アラームリスト（選択可能）
  - "SETTINGS"項目（最後）
- **ボタン操作**:
  - A: アラーム削除
  - B: 次項目
  - C: 前項目
  - A長押し: メイン画面に戻る
  - B/C長押し: 選択確定

### 4. 設定メニュー (SETTINGS_MENU)
- **メニュー項目**:
  - Sound（音ON/OFF）
  - Vibration（振動設定、未実装）
  - LCD Brightness（明度調整）
  - All Clear（全削除）
  - Info（情報表示）
- **ボタン操作**:
  - A: 前項目
  - B: 次項目
  - C: 選択確定
  - C長押し: メイン画面に戻る

### 5. アラーム鳴動画面 (ALARM_ACTIVE)
- **表示内容**:
  - "TIME UP!"メッセージ
  - オーバータイム表示
  - 画面点滅（0.5秒間隔）
- **動作**:
  - 最大5秒間鳴動
  - 音ON/OFF切り替え
  - 任意のボタンで停止

### 6. 情報画面 (INFO_DISPLAY)
- **表示内容**:
  - アプリ名、バージョン
  - MACアドレス
- **ボタン操作**:
  - C: 設定メニューに戻る

## ボタン処理仕様

### 短押し・長押し判定
- **短押し**: 離した瞬間に判定
- **長押し**: 押し続け中に一定時間経過で判定
- **デバウンス**: モード遷移時に200ms

### 入力モードのボタン処理
- **Aボタン**:
  - 短押し: +1（離した瞬間）
  - 長押し: +5（0.5秒経過時点で1回のみ）
- **Bボタン**:
  - 短押し: 桁送り
  - 長押し: リセット（1秒）
- **Cボタン**: セット（確定）

## アラーム機能
- **最大数**: 5個
- **重複チェック**: 同一時刻は追加不可
- **自動ソート**: 時刻順に並び替え
- **過去時刻チェック**: 現在時刻以前は追加不可

## 時刻入力方式
- **絶対時刻**: 指定時刻にアラーム
- **相対時刻追加**: 現在時刻 + 入力値
- **相対時刻減算**: 現在時刻 - 入力値

## 設定項目
- **音**: ON/OFF
- **振動**: 未実装
- **LCD明度**: 50-250（50刻み）
- **全削除**: アラーム全削除（確認ダイアログ付き）

## 技術仕様
- **動作周波数**: 100Hz（10ms間隔）
- **画面更新**: 100ms間隔（ボタン押下時は即時）
- **WiFi**: NTP同期用（現在はスキップ）
- **フレームワーク**: Arduino (ESP32)

## 制限事項
- アラーム時刻は揮発性（電源OFFでリセット）
- 振動機能は未実装
- WiFi機能は現在無効化
