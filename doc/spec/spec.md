# M5Stack Fire 集中タイマー 仕様書

## 概要
M5Stack Fire用の集中タイマーアプリケーション。アラーム機能付きのタイマーで、複数のアラーム時刻を管理できる。

## ハードウェア仕様
- **デバイス**: M5Stack Fire v2.7
- **SoC**: ESP32-D0WDQ6（240MHz デュアルコア、600 DMIPS、520KB SRAM）
- **フラッシュメモリ**: 16MB
- **PSRAM**: 8MB
- **画面**: 2.0インチ 320×240 ILI9342C IPSパネル（最大輝度 853nit、ガラスカバーパネル）
- **ボタン**: カスタム物理ボタン ×3（A, B, C）
- **RGB LED**: SK6812 ×10（通知機能として活用可能）
- **スピーカー**: 1W-0928（音声アラーム用）
- **マイク**: アナログ BSE3729（将来の音声入力機能用）
- **WiFi**: 内蔵（NTP同期用）
- **Bluetooth**: 内蔵（将来の連携機能用）
- **電源**: 内蔵リチウムイオンバッテリー 500mAh 3.7V
- **サイズ**: 54.0 × 54.0 × 28.6 mm
- **重量**: 88.8g

### ハードウェア制限事項
- **振動機能**: 非搭載（代替としてRGB LEDで通知）
- **外部振動モーター**: 未接続（Groveポート経由で追加可能）

### 将来拡張可能な機能
- **RGB LED通知**: アラーム時の色変更・点滅パターン
- **音声入力**: マイクを使用した音声コマンド
- **外部振動**: Groveポート経由での振動モーター接続
- **SDカード**: 設定データの永続化
- **Bluetooth連携**: スマートフォンアプリとの連携

## UI/UX仕様

### テーマ
- **Amber CRTテーマ**: 黒背景、アンバー文字のモノクロ風
  - メイン文字色: アンバー (`#FB20`, RGB565: R=31, G=22, B=0) - 確定
  - 背景色: 黒 (`#0000`) - 確定
  - 警告色: フラッシュオレンジ (`#F000`, RGB565: R=31, G=0, B=0) - バッテリー20%以下、アラーム画面（確定）
  - ハイライト: ネガポジ反転（選択項目の背景をアンバー、文字を黒）

### フォント
- **Font7**: 主要要素（時刻表示など、高さ48px）
- **Font4**: 二次要素（高さ26px）
- **Font2**: ヒント・タイトルバー・ボタンヒント（高さ16px）

### レイアウト
- **グリッドシステム**: 16x12グリッド（20x20px）
  - 全体: 16x12グリッド（320×240px）
  - タイトルバー: 上部固定（1グリッド高さ、20px）
  - コンテンツエリア: 16x10グリッド（座標系: (0,0)-(15,9)）
  - ボタンヒント: 下部固定（1グリッド高さ、20px）
  - Font7配置: 3グリッド高さ（60px）で配置し、余白6pxを上下に配置

## データ永続化
- **Flash保存**: SSID/パスワード、LCD明度、音/振動設定
- **揮発性**: アラーム時刻（電源OFFでリセット）

## 画面仕様

### 1. メイン画面 (MAIN_DISPLAY)
- **表示内容**:
  - 日付表示（グリッドセル(0,0)-(15,0)、Font2、書式: YYYY/MM/DD (ddd)）
  - 現在時刻（グリッドセル(0,1)-(15,2)、Font4、書式: HH:MM、垂直中央寄せ）
  - 次のアラームまでの残り時間（グリッドセル(0,3)-(15,5)、Font7、書式: HH:MM:SS、垂直中央寄せ）
  - プログレスバー（グリッドセル(0,6)-(15,7)）
    - 基準: 直前のアラーム解除時刻～次のアラーム時刻
    - 進捗済み: アンバー色
    - 未進捗: 黒
    - 境界線: アンバー色
  - アラームリスト（グリッドセル(0,8)-(15,9)、Font2）
    - 最大5件表示
    - 未来のアラームのみ表示
    - 時刻順にソート
    - 水平配置（等間隔）
- **レイアウト詳細**:
  - コンテンツエリア: 16x10グリッド（座標系: (0,0)-(15,9)）
  - 日付: 水平中央寄せ
  - 現在時刻: 水平・垂直中央寄せ（Y方向2グリッド使用）
  - 残り時間: 水平・垂直中央寄せ（Y方向3グリッド使用、Font7配置）
  - プログレスバー: 全幅使用（Y方向2グリッド使用）
  - アラームリスト: 最大5件、水平配置（Y方向2グリッド使用）
- **ボタン操作**:
  - A: 絶対時刻入力
  - B: 現在時刻 + 入力値
  - C短押し: アラーム管理
  - C長押し: 設定メニュー
- **アラーム鳴動時variant**:
  - オーバータイム表示（グリッドセル(0,3)-(15,5)、Font7、フラッシュオレンジ、書式: "+HH:MM:SS"、水平中央寄せ）
  - ステータスバー点滅（0.5秒間隔、アンバー⇔フラッシュオレンジ）
  - 音: 設定に応じて鳴動
  - 任意のボタンで鳴動停止（通常のメイン画面に戻る）

### 2. 入力モード (ABS_TIME_INPUT, REL_PLUS_TIME_INPUT)
- **モード種類**:
  - ABS_TIME_INPUT: 絶対時刻入力
  - REL_PLUS_TIME_INPUT: 現在時刻 + 入力値
- **表示内容**:
  - タイトルバー（モード名 + バッテリー情報、Font2、アンバー色）
  - 時刻入力表示（グリッドセル(0,3)-(15,5)、Font7、水平中央寄せ）
    - 書式: "HH:MM"
    - カーソル位置の桁はハイライト表示（ネガポジ反転）
  - プレビュー表示（グリッドセル(2,6)-(13,6)、Font2、水平中央寄せ）
    - 絶対時刻入力: "Set: HH:MM"
    - 相対時刻追加: "Now + HH:MM = HH:MM"
- **プレビュー表示詳細**:
  - 更新タイミング: 入力値変更時即座に更新
  - 時刻計算: 現在時刻を基準に計算
  - 日付跨ぎ処理: 24時間を超える場合は翌日として計算
  - 過去時刻処理: 絶対時刻入力時、現在時刻以前の場合は翌日の時刻として表示
  - 表示例:
    - 絶対時刻: "Set: 14:30"
    - 絶対時刻（過去）: "Set: 14:30 (tomorrow)"（現在15:00の場合）
    - 相対追加: "Now + 02:15 = 16:45"（現在14:30の場合）
  - ボタンヒント（全体グリッド最下部、Font2、アンバー色）
    - A: "+1/+5" B: "Next/Reset" C: "Set"
- **レイアウト詳細**:
  - コンテンツエリア: 16x10グリッド（座標系: (0,0)-(15,9)）
  - 時刻入力: 中央配置（グリッドセル(0,3)-(15,5)、Font7配置、メイン画面の残り時間と同じ位置）
  - プレビュー: 下部配置（グリッドセル(2,6)-(13,6)）
  - ボタンヒント: コンテンツエリア外（全体グリッドの最下部）
- **入力方式**: 桁ごと編集
  - カーソル位置: 0=時十, 1=時一, 2=分十, 3=分一
  - 初期値: 00:00
  - カーソル初期位置: 0（時十の位）
- **カーソル表示仕様**:
  - 表示方法: ネガポジ反転（背景アンバー、文字黒）
  - 点滅: なし（常時ハイライト表示）
  - 桁送り方向: 左から右（0→1→2→3→0）
  - 桁送り時の音: なし
  - カーソル移動時の視覚的フィードバック: 即座にハイライト切り替え
- **入力値検証・制限**:
  - 時刻範囲: 00:00-23:59
  - 時十の位: 0-2（0,1,2のみ有効）
  - 時一の位: 0-9（時十が2の場合、0-3のみ有効）
  - 分十の位: 0-5（0,1,2,3,4,5のみ有効）
  - 分一の位: 0-9（0-9すべて有効）
  - 無効値入力時: 最大値に制限（例：時十に3を入力→2に制限）
  - 制限時のフィードバック: 音なし、視覚的フィードバックなし
- **ボタン操作詳細**:
  - **Aボタン**:
    - 短押し: +1（離した瞬間に判定）
    - 長押し: +5（0.5秒経過時点で1回のみ）
    - 連続入力制限: なし（連続押下可能）
    - 最大値到達時: 0に戻る（循環）
  - **Bボタン**:
    - 短押し: 桁送り（離した瞬間に判定）
    - 長押し: リセット（1秒経過時点で実行）
    - 桁送り方向: 左から右（0→1→2→3→0）
    - リセット内容: 入力値を00:00に戻し、カーソル位置を0に戻す
  - **Cボタン**:
    - 短押し: セット（確定）
    - 長押し: メイン画面に戻る（1秒）
    - 確定時の処理: アラーム追加（重複・過去時刻チェック付き）
    - エラー時: エラーメッセージ表示（1秒間）

### 3. アラーム管理画面 (ALARM_MANAGEMENT)
- **表示内容**:
  - アラームリスト（確認・削除）
- **ボタン操作**:
  - A: アラーム削除
  - B: 次項目
  - C: 前項目
  - C長押し: メイン画面に戻る

### 4. 設定メニュー (SETTINGS_MENU)
- **メニュー項目**:
  - Sound（音ON/OFF）
  - LCD Brightness（明度調整）
  - WARNING COLOR TEST
  - All Clear（全削除）
  - Info（情報表示）
- **ボタン操作**:
  - **項目選択モード**:
    - A: 前項目
    - B: 次項目
    - C: 選択確定（値変更モードに入る）
    - C長押し: メイン画面に戻る
  - **値変更モード**:
    - A: 値減少/切り替え
    - B: 値増加/切り替え
    - C: 確定（設定メニューに戻る）
    - C長押し: メイン画面に戻る

### 5. 情報画面 (INFO_DISPLAY)
- **表示内容**:
  - アプリ名、バージョン
  - MACアドレス
- **ボタン操作**:
  - C: 設定メニューに戻る
  - C長押し: メイン画面に戻る

## ボタン処理仕様

### 統一された操作
- **C長押し**: メイン画面に戻る（全画面共通）

### 短押し・長押し判定
- **短押し**: 離した瞬間に判定
- **長押し**: 押し続け中に一定時間経過で判定
- **デバウンス**: モード遷移時に200ms

### 入力モードのボタン処理
- **Aボタン**:
  - 短押し: +1（離した瞬間）
  - 長押し: +5（0.5秒経過時点で1回のみ）
- **Bボタン**:
  - 短押し: 桁送り
  - 長押し: リセット（1秒）
- **Cボタン**: セット（確定）

## アラーム機能
- **最大数**: 5個
- **重複チェック**: 同一時刻は追加不可
- **自動ソート**: 時刻順に並び替え
- **過去時刻処理**: 絶対時刻入力時、現在時刻以前の場合は翌日の時刻として設定

## 時刻入力方式
- **絶対時刻**: 指定時刻にアラーム
- **相対時刻追加**: 現在時刻 + 入力値（基準選択不要）

## 設定項目
- **音**: ON/OFF
- **LCD明度**: 50-250（50刻み）
- **全削除**: アラーム全削除（確認ダイアログ付き）

## 技術仕様
- **動作周波数**: 100Hz（10ms間隔）
- **画面更新**: 100ms間隔（ボタン押下時は即時）
- **WiFi**: NTP同期用（現在はスキップ）
- **フレームワーク**: Arduino (ESP32)

### 電源管理仕様
- **バッテリー動作時**: 1Hz動作（ユーザー非操作時かつタイマーカウントダウン動作時）
- **有線電源供給時**: 100Hz動作維持（電力消費削減の制限なし）
- **充電状態**: タイトルバーに⚡アイコン表示
- **低バッテリー警告**: 20%以下でフラッシュオレンジ表示（充電中は除く）

## 制限事項
- アラーム時刻は揮発性（電源OFFでリセット）
- 振動機能は未実装
- WiFi機能は現在無効化
