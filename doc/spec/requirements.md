# Aimatix 要件定義書

## 1. 概要

Aimatixは、M5Stack Fireを使用した集中タイマーシステムです。ユーザーが効率的に時間管理を行えるよう、シンプルで直感的なインターフェースを提供します。

## 2. 機能要件

### 2.1 基本タイマー機能

#### 2.1.1 現在時刻表示
- **要件**: 現在時刻を1秒間隔で正確に表示
- **表示形式**: HH:MM（※秒は一切表示しない。理由：描画更新頻度を下げるため、またアクティブなタイマーと誤認させないため）
- **表示位置**: グリッドセル(0,1)-(15,2)
- **フォント**: Font4（高さ26px）
- **色**: アンバー色（#FB20）
- **配置**: 水平中央寄せ

#### 2.1.2 アラーム設定・削除
- **最大アラーム数**: 5件
- **重複チェック**: 同一時刻の追加を拒否
- **過去時刻削除**: 現在時刻以前のアラームを自動削除
- **自動削除タイミング**: アラーム鳴動モードが解除された時点で表示上から削除（内部的には次のアラームへのカウントダウンが始まっている点に注意）
- **自動ソート**: 時刻順での自動ソート

#### 2.1.3 画面遷移
- **全モード間遷移**: 8つのモード間の安定した遷移（モード一覧・遷移仕様は `spec/state_transition.md` 参照。確定済み）
- **デバウンス処理**: 200msのボタンデバウンス
- **警告メッセージ**: エラー時の適切な表示

### 2.2 入力機能

#### 2.2.1 時刻入力
- **初期値**: __:__ 
- **入力形式**: HH:MM（4桁）
- **入力範囲**: 00:00-23:59
- **入力方法**: 桁ごと編集
- **バリデーション**: 時刻範囲チェック

#### 2.2.2 ボタン操作
- **短押し**: 数字入力、選択
- **長押し**: 特殊操作（+5、リセット等）
- **同時押し**: 将来的な拡張対応（現時点で予約操作・IDなし）

### 2.3 アラーム機能

#### 2.3.1 アラーム鳴動
- **フラッシュ点滅**: 0.5秒間隔、オレンジ⇔黒
- **オーバータイム表示**: +HH:MM:SS形式
- **音制御**: 880Hz、500ms間隔
- **停止条件**: ボタン押下、5秒経過

#### 2.3.2 アラーム管理
- **アラームリスト表示**: 選択・削除機能
- **並び替え機能**: 時刻順・追加順
- **一括操作**: 全削除機能

### 2.4 設定機能

#### 2.4.1 基本設定
- **LCD明度**: 調整可能
- **音設定**: 有効/無効
- **電源設定**: スリープ時間、動作周波数

#### 2.4.2 確認ダイアログ
- **設定変更時**: 確認ダイアログ表示
- **デフォルト復元**: 設定のリセット機能

### 2.5 電源管理機能

#### 2.5.1 アイドル時間監視
- **デフォルト時間**: 5分間の無操作でスリープ
- **設定範囲**: 1分-30分（設定可能）
- **例外条件**: タイマーカウントダウン中はスリープしない

#### 2.5.2 スリープ復帰
- **復帰方法**: 任意ボタン押下
- **状態保持**: 復帰後は直前の画面に戻る

#### 2.5.3 動作周波数制御
- **通常時**: 100Hz（10ms間隔）
- **アイドル時**: 1Hz（1秒間隔）
- **有線電源**: 常時100Hz

#### 2.5.4 バッテリー監視
- **警告閾値**: 20%以下で警告色表示
- **充電表示**: 充電中は緑色表示
- **精度**: バッテリー残量の1%精度表示

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **メインループ**: 100Hz維持
- **RAM使用量**: 0.5%以下
- **Flash使用量**: 10%以下
- **バッテリー持続時間**: 8時間以上（ディープスリープ時。画面ON・LCD輝度25%時は2.5時間を目標）

### 3.2 品質要件
- **Unit Testカバレッジ**: 純粋ロジック80%以上
- **統合テストカバレッジ**: 全体（UI/アダプタ含む）65%以上
- **ビルド成功率**: 100%
- **残り時間表示精度**: ±1秒以内
- **進捗バー精度**: ±1%以内
- **アラーム鳴動精度**: ±0.1秒以内

### 3.3 信頼性要件
- **エラーハンドリング**: 適切なエラーメッセージ表示
- **復旧機能**: 自動復旧機能
- **データ永続化**: 設定の永続化（LCD明度、音設定、Wi-Fi設定のみ）

### 3.4 保守性要件
- **モジュール化**: 機能ごとの分離
- **テスト容易性**: モック注入によるテスト
- **拡張性**: 将来的な機能追加への対応

## 4. 制約事項

### 4.1 ハードウェア制約
- **M5Stack Fire**: ターゲットハードウェア
- **ディスプレイ**: 320x240 TFT LCD
- **ボタン**: A、B、Cボタン
- **スピーカー**: 内蔵スピーカー
- **メモリ**: ESP32の制限

### 4.2 ソフトウェア制約
- **フレームワーク**: Arduino
- **ライブラリ**: M5Stack、WiFiProv、NTPClient
- **テストフレームワーク**: Unity

### 4.3 開発制約
- **開発言語**: C++
- **ビルドシステム**: PlatformIO
- **テスト環境**: native環境（Windows）、M5Stack Fire (実機)

## 5. 成功指標

### 5.1 機能指標
- [ ] 全仕様の100%実装
- [ ] 残り時間表示精度±1秒以内
- [ ] 進捗バー精度±1%以内
- [ ] アラーム鳴動精度±0.1秒以内
- [ ] DIパターンの正しい活用確認

### 5.2 品質指標
- [ ] Unit Testカバレッジ80%以上（純粋ロジック）
- [ ] 統合テストカバレッジ65%以上（全体）
- [ ] ビルド成功率100%
- [ ] メモリ使用量最適化達成
- [ ] 純粋ロジックテストの100%成功

### 5.3 パフォーマンス指標
- [ ] メインループ100Hz維持
- [ ] RAM使用量0.5%以下
- [ ] Flash使用量10%以下
- [ ] バッテリー持続時間8時間以上（ディープスリープ時）／2.5時間（画面ON・LCD輝度25%時）

---

**作成日**: 2025年1月  
**バージョン**: 1.0.0  
**更新日**: 2025年1月 
// 実機テストの合格基準・必須シナリオ：現状特になし 