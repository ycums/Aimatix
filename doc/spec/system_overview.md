# Aimatix システム概要書

## 1. システム概要

Aimatixは、M5Stack Fireを使用した集中タイマーシステムです。ユーザーが効率的に時間管理を行えるよう、シンプルで直感的なインターフェースを提供します。

### 1.1 システムの目的
- 集中作業のためのタイマー機能
- 複数のアラーム管理
- 直感的なボタン操作
- 省電力設計

### 1.2 主要機能
- **基本タイマー機能**: 現在時刻表示、アラーム設定・削除
- **入力機能**: 時刻入力、ボタン操作
- **アラーム機能**: アラーム鳴動、アラーム管理
- **設定機能**: 基本設定、確認ダイアログ
- **電源管理機能**: アイドル時間監視、スリープ復帰

## 2. システム構成

### 2.1 ハードウェア構成
- **M5Stack Fire**: メインボード
- **ディスプレイ**: 320x240 TFT LCD
- **ボタン**: A、B、Cボタン
- **スピーカー**: 内蔵スピーカー
- **バッテリー**: 内蔵リチウムイオン電池

### 2.2 ソフトウェア構成

#### 2.2.1 アーキテクチャ
```
┌─────────────────────────────────────┐
│              UI Layer               │
├─────────────────────────────────────┤
│           Business Logic            │
├─────────────────────────────────────┤
│         Hardware Adapters           │
├─────────────────────────────────────┤
│           M5Stack Hardware          │
└─────────────────────────────────────┘
```

#### 2.2.2 レイヤー説明
- **UI Layer**: 画面表示、ユーザーインターフェース
- **Business Logic**: 純粋ロジック、ビジネスルール
- **Hardware Adapters**: ハードウェア抽象化層
- **M5Stack Hardware**: 物理ハードウェア

### 2.3 モジュール構成

#### 2.3.1 純粋ロジック（lib/libaimatix/src/）
- **TimeLogic**: 時刻計算、時間管理
- **AlarmLogic**: アラーム管理、鳴動制御
- **InputLogic**: 入力処理、バリデーション
- **SettingsLogic**: 設定管理、永続化
- **ButtonManager**: ボタン状態管理
- **DebounceManager**: デバウンス処理

#### 2.3.2 M5Stack依存（src/）
- **main.cpp**: メインループ、システム制御
- **ui.cpp/h**: 画面表示、UI制御
- **state_transition/**: 状態遷移システム
- **m5stack_adapters.cpp/h**: ハードウェアアダプター
- **wifi_manager.cpp/h**: Wi-Fi管理
- **time_sync.cpp/h**: 時刻同期

## 3. 動作モード

### 3.1 メインディスプレイ（MAIN_DISPLAY）
- 現在時刻の表示
- 次のアラームまでの残り時間表示
- アラームリストの表示

### 3.2 絶対時刻入力（ABS_TIME_INPUT）
- 時刻の入力（HH:MM形式）
- 桁ごとの編集
- バリデーション

### 3.3 相対時刻加算入力（REL_PLUS_TIME_INPUT）
- 現在時刻からの相対時間入力
- 加算時間の設定

### 3.4 相対時刻減算入力（REL_MINUS_TIME_INPUT）
- 現在時刻からの相対時間入力
- 減算時間の設定

### 3.5 アラーム管理（ALARM_MANAGEMENT）
- アラームリストの表示
- アラームの選択・削除
- アラームの並び替え

### 3.6 設定メニュー（SETTINGS_MENU）
- 各種設定の変更
- 確認ダイアログ
- デフォルト復元

### 3.7 アラーム鳴動（ALARM_ACTIVE）
- アラーム音の再生
- フラッシュ点滅表示
- オーバータイム表示

### 3.8 警告表示（WARNING_DISPLAY）
- エラーメッセージの表示
- 警告の自動消去

## 4. データフロー

### 4.1 時刻データフロー
```
NTP Server → WiFi → TimeSync → TimeLogic → UI Display
```

### 4.2 アラームデータフロー
```
User Input → InputLogic → AlarmLogic → Settings → EEPROM
AlarmLogic → UI Display → Speaker
```

### 4.3 ボタンデータフロー
```
Hardware Button → ButtonManager → StateTransition → UI Update
```

## 5. 技術仕様

### 5.1 開発環境
- **開発言語**: C++
- **フレームワーク**: Arduino
- **ビルドシステム**: PlatformIO
- **テストフレームワーク**: Unity

### 5.2 ライブラリ依存
- **M5Stack**: ハードウェア制御
- **WiFiProv**: Wi-Fi設定
- **NTPClient**: 時刻同期
- **Preferences**: 設定永続化

### 5.3 設計パターン
- **Dependency Injection**: 依存性注入
- **Adapter Pattern**: ハードウェア抽象化
- **State Pattern**: 状態遷移管理
- **Observer Pattern**: イベント通知

## 6. パフォーマンス仕様

### 6.1 動作周波数
- **通常時**: 100Hz（10ms間隔）
- **アイドル時**: 1Hz（1秒間隔）
- **有線電源**: 常時100Hz

### 6.2 メモリ使用量
- **RAM使用量**: 0.5%以下
- **Flash使用量**: 10%以下

### 6.3 バッテリー持続時間
- **目標**: 8時間以上
- **スリープ機能**: 省電力設計

## 7. セキュリティ・信頼性

### 7.1 エラーハンドリング
- **入力値バリデーション**: 境界値チェック
- **例外処理**: 適切なエラーメッセージ
- **復旧機能**: 自動復旧

### 7.2 データ永続化
- **設定データ**: EEPROM/Preferences保存
- **アラームデータ**: 揮発性（電源OFFでリセット）
- **Wi-Fi設定**: 永続化

### 7.3 テスト戦略
- **Unit Test**: 純粋ロジックのテスト
- **統合テスト**: モジュール間の連携テスト
- **実機テスト**: ハードウェア動作確認

---

**作成日**: 2025年1月  
**バージョン**: 1.0.0  
**更新日**: 2025年1月 