# M5Stack集中タイマー 統合作業計画書

## 1. 目的
M5Stack Fire用集中タイマーの完全実装を、テスト駆動開発により段階的に進める。
実機テストを最小限に留め、各フェーズで十分なテストカバレッジを確保する。

## 2. 開発方針

### 2.1 テスト駆動開発（TDD）
- **各機能実装前にテスト作成**: 期待動作を明確化
- **Unit Testカバレッジ**: 各フェーズで80%以上を維持
- **統合テスト**: フェーズ完了時に全シナリオテスト
- **実機テスト**: 統合テスト通過後の最終確認のみ

### 2.2 段階的実装
- **基盤技術**: インフラ機能を先に整備
- **UI/UX機能**: 基盤完成後に詳細実装
- **統合・最適化**: 全機能完成後の調整

### 2.3 品質保証
- **ビルド成功**: 各コミットでビルド成功を保証
- **テスト自動化**: ローカルでの自動テスト実行
- **ドキュメント更新**: 実装と並行して仕様書更新

## 3. 実装フェーズ

### Phase 0: 実行前準備・現状確認（1週間）

#### 0.1 現状確認と問題点特定
**目標**: 現在の実装状況と問題点を明確化
**確認項目**:
- [x] 既存テストの実行状況確認
- [x] 現在のビルド状況確認
- [x] 既存バグの特定と修正
- [x] 実装済み機能の動作確認
- [x] 未実装機能の特定

**確認ファイル**:
- `test/` ディレクトリ内の全テストファイル
- `src/` ディレクトリ内の全ソースファイル
- `platformio.ini` の設定確認
- 既存のドキュメント類

**成果物**:
- 現状レポート（実装済み機能、未実装機能、既知バグ）
- テスト実行結果レポート
- ビルド状況レポート

#### 0.2 仕様確定と優先順位調整
**目標**: 実装計画の具体的な仕様を確定
**確定項目**:
- [x] Phase 1.4の具体的な完成基準の確定
- [x] 電源管理機能の詳細仕様の確定
- [x] UI/UX改善の優先順位の確定
- [x] 実装ファイルの修正範囲の明確化
- [x] テスト戦略の具体化

**参照ファイル**:
- `doc/spec/` ディレクトリ内の詳細仕様書
- 既存の実装コード
- ユーザー要求事項

**成果物**:
- 修正版統合作業計画書
- 詳細実装仕様書
- テスト戦略文書

**確定された仕様**:

**Phase 1.4 基本タイマー機能の完成基準**:
1. **現在時刻表示の正確性確認**
   - 1秒間隔での更新
   - HH:MM形式での表示
   - グリッドセル(0,1)-(15,2)にFont4で中央配置

2. **アラーム設定・削除の基本動作確認**
   - 最大5件のアラーム管理
   - 重複チェック機能
   - 過去時刻の自動削除
   - 時刻順での自動ソート

3. **画面遷移の安定性確認**
   - 全モード間の遷移動作
   - ボタンデバウンス処理（200ms）
   - 警告メッセージ表示機能

4. **既存バグの修正**
   - ⚡アイコン問題の解決
   - ヘッダー競合の解決
   - リンクエラーの解決

5. **基本的なバリデーションの実装**
   - 時刻入力値の妥当性チェック（00:00-23:59）
   - アラーム数の上限チェック
   - 入力値の境界値チェック

**電源管理機能の詳細仕様**:
1. **アイドル時間監視**
   - デフォルト: 5分間の無操作でスリープ
   - 設定可能範囲: 1分-30分
   - タイマーカウントダウン中はスリープしない

2. **スリープ復帰方法**
   - 任意ボタン押下で復帰
   - 復帰後は直前の画面に戻る
   - 状態保持機能

3. **動作周波数制御**
   - 通常時: 100Hz（10ms間隔）
   - アイドル時: 1Hz（1秒間隔）
   - 有線電源供給時: 常時100Hz

4. **バッテリー監視**
   - 20%以下で警告色表示
   - 充電中は緑色表示
   - バッテリー残量の1%精度表示

**UI/UX改善の優先順位**:
1. **高優先度（Phase 1.4で実装）**
   - メイン表示画面の完成（残り時間、進捗バー、アラームリスト）
   - 入力モードの完成（桁ごと編集、バリデーション）
   - アラーム鳴動画面の完成（フラッシュ点滅、オーバータイム表示）

2. **中優先度（Phase 2で実装）**
   - アラーム管理画面の完成
   - 設定メニューの完成
   - 警告メッセージシステムの改善

3. **低優先度（Phase 3で実装）**
   - 電源管理機能の詳細実装
   - パフォーマンス最適化
   - エラーハンドリングの統合

**実装ファイルの修正範囲**:
1. **既存ファイルの修正**
   - `src/main.cpp`: ループ処理の最適化、エラーハンドリング追加
   - `src/ui.cpp`: メイン表示画面の完成、進捗バー実装
   - `src/input.cpp`: バリデーション強化、エラー処理改善
   - `src/alarm.cpp`: アラーム管理機能の完成
   - `src/settings.cpp`: Preferences移行、設定項目追加

2. **新規作成ファイル**
   - `src/power_manager.cpp`: 電源管理機能
   - `src/wifi_manager.cpp`: Wi-Fi設定管理
   - `src/time_sync.cpp`: NTP同期機能
   - `src/error_handler.cpp`: エラーハンドリング統合

**テスト戦略の具体化**:
1. **Unit Test戦略**
   - 各機能の純粋ロジックテスト（M5Stack依存なし）
   - カバレッジ目標: 80%以上
   - テスト実行環境: Windows native環境

2. **統合テスト戦略**
   - モード間遷移テスト
   - エラーケース統合テスト
   - パフォーマンステスト

3. **実機テスト戦略**
   - 統合テスト通過後の最終確認のみ
   - ハードウェア連携確認
   - 長時間動作確認

#### 0.3 Unityテスト環境の改善
**目標**: 既存のUnity環境を完全に動作させる
**問題点**:
- [ ] モック環境の不備（Arduino関数未定義）
- [ ] ヘッダー競合（Windows環境での型定義競合）
- [ ] テストファイルの不整合（未実装関数の呼び出し）

**改善項目**:
- [ ] `mock_m5stack.h`の完全実装
- [ ] Windows環境でのヘッダー競合解決
- [ ] テストファイルの実装状況確認・修正
- [ ] テスト実行環境の安定化

**実装ファイル**:
- `test/mocks/mock_m5stack.h` (大幅修正)
- `test/mocks/mock_m5stack.cpp` (新規作成)
- `platformio.ini` (native環境の修正)

**Unit Testカバレッジ目標**: 既存テストの100%実行成功

#### 0.4 テスト戦略の確立
**目標**: 効率的なテスト実行環境の構築
**改善項目**:
- [ ] テスト実行の自動化
- [ ] 簡易カバレッジ測定の導入（gcovベース）
- [ ] テスト結果の可視化
- [ ] ローカルテスト環境の最適化

**実装ファイル**:
- `scripts/run_tests.py` (改善)
- `scripts/test_coverage.py` (新規作成)

### Phase 1: 基盤技術の整備（1-2週間）

#### 1.1 Wi-Fi設定のSmartConfig対応
**目標**: SmartConfigによるWi-Fi設定、Preferences保存
**テスト項目**:
- [ ] SmartConfig接続テスト
- [ ] Preferences保存・読み込みテスト
- [ ] 起動時自動接続テスト
- [ ] 接続失敗時のエラーハンドリングテスト

**実装ファイル**:
- `src/wifi_manager.cpp` (新規作成)
- `src/wifi_manager.h` (新規作成)
- `test/test_wifi_manager.cpp` (新規作成)

**Unit Testカバレッジ目標**: 90%

#### 1.2 NTP同期機能の改善
**目標**: NTP同期後のWi-Fi自動OFF、時刻精度向上
**テスト項目**:
- [ ] NTP同期成功テスト
- [ ] 同期後のWi-Fi OFFテスト
- [ ] 時刻精度テスト（±1秒以内）
- [ ] 同期失敗時のエラーハンドリングテスト

**実装ファイル**:
- `src/time_sync.cpp` (新規作成)
- `src/time_sync.h` (新規作成)
- `test/test_time_sync.cpp` (新規作成)

**Unit Testカバレッジ目標**: 85%

#### 1.3 設定管理のPreferences移行
**目標**: EEPROMからPreferencesへの完全移行
**テスト項目**:
- [ ] 設定保存・読み込みテスト
- [ ] デフォルト値復元テスト
- [ ] 設定整合性チェックテスト
- [ ] 移行処理テスト（EEPROM→Preferences）

**実装ファイル**:
- `src/settings.cpp` (大幅修正)
- `src/settings.h` (大幅修正)
- `test/test_settings.cpp` (大幅修正)

**Unit Testカバレッジ目標**: 95%

#### 1.4 基本タイマー機能の完成
**目標**: 現在実装済みの基本機能の動作確認とバグ修正
**具体的な実装項目**:
- [ ] 現在時刻表示の正確性確認
- [ ] アラーム設定・削除の基本動作確認
- [ ] 画面遷移の安定性確認
- [ ] 既存バグの修正（⚡アイコン問題など）
- [ ] 基本的なバリデーションの実装
- [ ] 入力値の妥当性チェック強化
- [ ] エラーハンドリングの改善

**テスト項目**:
- [ ] 既存機能の動作確認テスト
- [ ] 画面表示の正確性テスト
- [ ] 基本的なバリデーションテスト
- [ ] エラーハンドリングテスト
- [ ] 画面遷移の安定性テスト

**実装ファイル**:
- `src/input.cpp` (既存バグ修正、バリデーション強化)
- `src/ui.cpp` (表示バグ修正、UI改善)
- `src/alarm.cpp` (基本動作確認、エラーハンドリング改善)
- `test/test_timer_basic.cpp` (新規作成)

**Unit Testカバレッジ目標**: 85%

### Phase 2: UI/UX機能の詳細実装（2-3週間）

#### 2.1 メイン表示画面の詳細作り込み
**目標**: 残り時間計算、進捗バー、アラームリスト表示
**テスト項目**:
- [ ] 残り時間計算テスト（正負値、日付跨ぎ）
- [ ] 進捗率計算テスト（境界値、異常値）
- [ ] アラームリスト表示テスト（最大5件制御）
- [ ] 画面更新頻度テスト（1秒間隔）

**実装ファイル**:
- `src/alarm.cpp` (大幅修正)
- `src/ui.cpp` (大幅修正)
- `test/test_alarm_display.cpp` (新規作成)
- `test/test_ui_main_display.cpp` (新規作成)

**Unit Testカバレッジ目標**: 85%

#### 2.2 入力モードの詳細ロジック
**目標**: 桁ごと編集、プレビュー表示、バリデーション
**テスト項目**:
- [ ] 桁ごと編集テスト（4桁、カーソル移動）
- [ ] 入力値バリデーションテスト（00:00-23:59）
- [ ] プレビュー計算テスト（絶対・相対時刻）
- [ ] エラー処理テスト（重複、無効値）

**実装ファイル**:
- `src/input.cpp` (大幅修正)
- `src/ui.cpp` (入力UI部分修正)
- `test/test_input_logic.cpp` (大幅修正)
- `test/test_ui_input.cpp` (新規作成)

**Unit Testカバレッジ目標**: 90%

#### 2.3 アラーム鳴動状態の詳細
**目標**: フラッシュ点滅、オーバータイム表示、音制御
**テスト項目**:
- [ ] フラッシュ点滅テスト（0.5秒間隔）
- [ ] オーバータイム計算テスト（+HH:MM:SS）
- [ ] 音制御テスト（880Hz、500ms間隔）
- [ ] 停止条件テスト（ボタン押下、5秒経過）

**実装ファイル**:
- `src/alarm.cpp` (鳴動制御部分修正)
- `src/ui.cpp` (鳴動表示部分修正)
- `test/test_alarm_activation.cpp` (新規作成)
- `test/test_ui_alarm_display.cpp` (新規作成)

**Unit Testカバレッジ目標**: 85%

#### 2.4 SETTINGSサブメニューの詳細
**目標**: 設定変更、確認ダイアログ、INFO画面
**テスト項目**:
- [ ] 設定項目選択・変更テスト
- [ ] 確認ダイアログテスト（ALL CLEAR）
- [ ] INFO画面表示テスト（バージョン、MACアドレス）
- [ ] 設定永続化テスト

**実装ファイル**:
- `src/settings.cpp` (UI部分追加)
- `src/ui.cpp` (設定画面部分修正)
- `test/test_settings_ui.cpp` (新規作成)
- `test/test_ui_settings.cpp` (新規作成)

**Unit Testカバレッジ目標**: 80%

#### 2.5 電源管理機能の基本実装
**目標**: 基本的な電源管理機能の実装
**前提条件**:
- Phase 0.2で仕様が確定していること
- ユーザー要求が明確になっていること

**仕様確定項目**:
- [ ] アイドル時間の定義（推奨: 5分）
- [ ] スリープ復帰方法の定義（推奨: 任意ボタン）
- [ ] スリープ時の状態保持方法の定義
- [ ] 電源設定のユーザー変更可否の定義
- [ ] 1Hz動作の実装方法の定義（ユーザー非操作時かつタイマーカウントダウン動作時）
- [ ] 有線電源供給時の動作定義（100Hz動作維持）

**テスト項目**:
- [ ] アイドル時間監視テスト
- [ ] ディープスリープ移行テスト
- [ ] スリープ復帰処理テスト
- [ ] 電源状態管理テスト
- [ ] 1Hz動作切り替えテスト
- [ ] 有線電源供給時の動作テスト

**実装ファイル**:
- `src/power_manager.cpp` (新規作成)
- `src/power_manager.h` (新規作成)
- `src/main.cpp` (loop関数の修正)
- `test/test_power_manager.cpp` (新規作成)

**Unit Testカバレッジ目標**: 80%

### Phase 3: 統合・最適化（1週間）

#### 3.1 統合テストの実行
**目標**: 全機能の統合動作確認
**テスト項目**:
- [ ] 全モード間遷移テスト
- [ ] エラーケース統合テスト
- [ ] パフォーマンステスト（100Hz動作維持）
- [ ] メモリ使用量テスト

**実装ファイル**:
- `test/test_integration.cpp` (大幅拡張)
- `test/test_performance.cpp` (新規作成)

**統合テストカバレッジ目標**: 95%

#### 3.2 エラーハンドリングの統合
**目標**: 全エラーケースの適切な処理
**テスト項目**:
- [ ] Wi-Fi/NTP失敗時の表示テスト
- [ ] 入力エラー時の警告表示テスト
- [ ] 設定保存失敗時の処理テスト
- [ ] システムエラー時の復旧テスト

**実装ファイル**:
- `src/error_handler.cpp` (新規作成)
- `src/error_handler.h` (新規作成)
- `test/test_error_handling.cpp` (新規作成)

**Unit Testカバレッジ目標**: 90%

#### 3.3 電源管理機能の詳細実装
**目標**: バッテリー監視の改善、電源設定の追加
**前提条件**:
- Phase 2.5で基本実装が完了していること
- Phase 0.2で詳細仕様が確定していること
- ユーザー要求が明確になっていること

**テスト項目**:
- [ ] バッテリー残量表示テスト（既存機能の改善）
- [ ] 低バッテリー警告テスト（既存機能の改善）
- [ ] 電源設定メニューテスト（仕様確定後）
- [ ] スリープ設定テスト（仕様確定後）

**実装ファイル**:
- `src/ui.cpp` (バッテリー表示部分改善)
- `src/settings.cpp` (電源設定追加)
- `test/test_power_ui.cpp` (新規作成)
- `test/test_power_settings.cpp` (新規作成)

**Unit Testカバレッジ目標**: 85%

#### 3.4 最終最適化
**目標**: パフォーマンス、メモリ使用量の最適化
**テスト項目**:
- [ ] メインループ100Hz維持テスト
- [ ] メモリ使用量最適化テスト
- [ ] バッテリー消費最適化テスト
- [ ] UI応答性テスト

**実装ファイル**:
- 全ファイルの最適化
- `test/test_optimization.cpp` (新規作成)

**最適化目標**: RAM 0.5%以下、Flash 10%以下

## 4. テスト戦略

### 4.1 Unity Test環境
- **テストフレームワーク**: Unity（既存環境を改善）
- **モック**: 既存のmock_m5stackを完全実装
- **カバレッジ測定**: gcov（簡易版）、必要に応じてlcov追加
- **自動実行**: ローカルでの自動テスト実行

### 4.2 統合テスト環境
- **シミュレーション**: 時間経過、ボタン操作
- **状態遷移**: 全モード間の遷移パターン
- **エラーシナリオ**: 各種失敗ケース

### 4.3 実機テスト戦略
- **最小限の実機テスト**: 統合テスト通過後の最終確認のみ
- **テスト項目**:
  - 基本動作確認（各モードの画面表示）
  - ハードウェア連携確認（ボタン、スピーカー、LED）
  - 実環境での安定性確認（長時間動作）

## 5. 品質指標

### 5.1 機能指標
- [ ] 全仕様の100%実装
- [ ] 残り時間表示精度±1秒以内
- [ ] 進捗バー精度±1%以内
- [ ] アラーム鳴動精度±0.1秒以内

### 5.2 品質指標
- [ ] Unit Testカバレッジ80%以上
- [ ] 統合テストカバレッジ95%以上
- [ ] ビルド成功率100%
- [ ] メモリ使用量最適化達成

### 5.3 パフォーマンス指標
- [ ] メインループ100Hz維持
- [ ] RAM使用量0.5%以下
- [ ] Flash使用量10%以下
- [ ] バッテリー持続時間8時間以上

## 6. 実行手順

### 6.1 Phase 0: 実行前準備
1. **現状確認**: 既存テスト・ビルド状況の確認
2. **問題点特定**: 既存バグ・未実装機能の特定
3. **仕様確定**: 実装計画の具体的な仕様確定
4. **テスト環境改善**: Unity環境の完全動作化
5. **計画修正**: 統合作業計画書の最終調整

### 6.2 各フェーズの実行
1. **テスト作成**: フェーズ開始時にテストコード作成
2. **実装**: テストを満たす実装
3. **Unit Test実行**: カバレッジ確認
4. **統合テスト実行**: 既存機能との整合性確認
5. **実機テスト**: 必要最小限の確認

### 6.3 コミット・レビュー
- **コミット単位**: 機能単位でのコミット
- **レビュー**: 各コミットでのコードレビュー
- **マージ**: テスト通過後のマージ

### 6.4 ドキュメント更新
- **仕様書更新**: 実装と並行して更新
- **API仕様**: 新規作成・修正したAPIの文書化
- **使用方法**: ユーザー向けガイドの更新

## 7. リスク管理

### 7.1 技術リスク
- **M5Stackライブラリの制限**: 代替実装の検討
- **メモリ不足**: 最適化手法の適用
- **パフォーマンス劣化**: 段階的な最適化

### 7.2 スケジュールリスク
- **実装遅延**: 優先度の調整
- **テスト遅延**: 並行作業の推進
- **統合問題**: 早期統合テストの実施

## 8. 成功指標

### 8.1 短期指標（各フェーズ完了時）
- [ ] 全テスト通過
- [ ] カバレッジ目標達成
- [ ] ビルド成功
- [ ] 基本動作確認

### 8.2 長期指標（プロジェクト完了時）
- [ ] 全仕様の100%実装
- [ ] 品質指標の達成
- [ ] パフォーマンス指標の達成
- [ ] 実機テストの成功

## 9. 実行前チェックリスト

### 9.1 Phase 0開始前の確認事項
- [ ] 既存テストの実行状況確認
- [ ] 現在のビルド状況確認
- [ ] 既存バグの特定
- [ ] 実装済み機能の動作確認
- [ ] 未実装機能の特定

### 9.2 Phase 0完了時の確認事項
- [ ] 現状レポートの作成完了
- [ ] 仕様確定の完了
- [ ] Unityテスト環境の改善完了
- [ ] 統合作業計画書の最終修正完了
- [ ] 実行可能な状態の確認

### 9.3 各フェーズ開始前の確認事項
- [ ] 前フェーズの完了確認
- [ ] テストコードの作成完了
- [ ] 実装仕様の明確化
- [ ] 依存関係の解決

---

この計画に沿って、Phase 0から順次実装を開始します。
各フェーズで十分なテストカバレッジを確保し、実機テストを最小限に留めます。
**重要**: Phase 0の完了確認後、Phase 1以降の実装を開始してください。 