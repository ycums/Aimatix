# 状態遷移ロジック修正・分離・テスト自動化 全体的対応計画書

## 1. プロジェクト概要

### 1.1 目的
- **最終目標**: 状態遷移周りのテストカバレッジ向上（20%台到達）
- **中間目標**: 状態遷移ロジックの分離・自動テスト化
- **前提作業**: 仕様の正規化・基盤修正

### 1.2 背景・課題
- 現状のmain.cppに400行以上の複雑な状態遷移ロジックが埋め込まれている
- ソースコードから導出した仕様が実際の仕様と異なる
- 状態遷移ロジックがM5Stack依存でテスト困難
- ボタン押下による画面遷移・モード遷移が壊れやすい

### 1.3 全体アーキテクチャ
```
┌─────────────────────────────────────┐
│ Phase 0: 仕様正規化・基盤修正        │ ← 前提作業
│ - 仕様の正規化                       │
│ - 不要なモードの削除                 │
│ - 長押し処理の追加                   │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│ Phase 1-3: 状態遷移ロジック分離      │ ← 主要作業
│ - 状態遷移ロジックの分離             │
│ - テストカバレッジ向上               │
│ - native環境での自動テスト           │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│ Phase 4: 後処理・クリーンアップ      │ ← 後処理
│ - 古いコードの削除                   │
│ - リファクタリング                   │
└─────────────────────────────────────┘
```

## 2. 詳細スケジュール

### Phase 0: 仕様正規化・基盤修正（1日目）

#### 2.1 実施内容
- [x] **現状分析の完了**
  - main.cppの状態遷移ロジック分析
  - 問題点の特定（責務の混在、テスト困難、保守性の低下）
  - 現在の状態遷移ロジック分布の把握

- [x] **状態遷移表・遷移マトリクスの作成**
  - 完全な状態遷移表の作成
  - ButtonEvent型の設計
  - 無効遷移とエッジケースの定義

- [x] **分離方針の決定**
  - 新しいファイル構成の設計
  - 責務の明確な分離
  - テスト戦略の設計

- [x] **インターフェース設計の完了**
  - ButtonEvent型、SystemState型、TransitionResult型、TransitionAction型の設計
  - 純粋関数としての状態遷移ロジックの設計

- [x] **基盤修正の実施**
  - `src/types.h`のMode列挙型修正
  - 状態遷移表の最終確認・修正

#### 2.2 成果物
- doc/state_transition_matrix.md（修正済み）
- doc/state_transition_separation_plan.md（修正済み）
- src/types.h（修正済み）

#### 2.3 成功指標
- [x] 状態遷移ロジックの分析完了
- [x] 分離方針の決定
- [x] インターフェース設計の完了
- [x] 基盤修正の完了

### Phase 1: 基盤構築（2日目）

#### 2.4 実施内容
- [x] **新しいファイル構成の作成**
  ```
  src/state_transition/
  ├── button_event.h/cpp        # ボタンイベント定義・変換
  ├── system_state.h/cpp        # システム状態管理
  ├── state_transition.h/cpp    # 純粋な状態遷移ロジック
  └── transition_validator.h/cpp # 遷移妥当性チェック
  ```

- [x] **型定義の実装**
  - ButtonEvent型の完全実装
  - SystemState型の完全実装
  - TransitionResult型の完全実装
  - TransitionAction型の完全実装

- [x] **基本的な状態遷移関数の実装**
  - StateTransitionManagerクラスの基本構造
  - 各モード用の遷移ハンドラー（基本版）
  - 遷移妥当性チェックの基本実装

#### 2.5 成果物
- src/state_transition/button_event.h/cpp ✅
- src/state_transition/system_state.h/cpp ✅
- src/state_transition/state_transition.h/cpp（基本版）✅
- src/state_transition/transition_validator.h/cpp（基本版）✅

#### 2.6 成功指標
- [x] 新しいファイル構成の作成完了
- [x] 型定義の実装完了
- [x] 基本的な状態遷移関数の実装完了
- [x] ビルドエラーなし

### Phase 2: 詳細実装（3-4日目）

#### 2.7 実施内容
- [ ] **全状態遷移パターンの実装**
  - メイン画面の遷移ハンドラー（完全版）
  - 絶対時刻入力の遷移ハンドラー（完全版）
  - 相対時刻加算入力の遷移ハンドラー（完全版）
  - アラーム管理の遷移ハンドラー（完全版）
  - 設定メニューの遷移ハンドラー（完全版）

- [ ] **長押し処理の実装**
  - A長押し: 数字+5の処理
  - B長押し: 入力値リセットの処理
  - C長押し: 各モードでの適切な処理

- [ ] **エッジケースの処理**
  - 警告表示中の遷移抑止
  - アラーム鳴動中の遷移抑止
  - 境界値チェック（選択インデックス、アラーム数等）

- [ ] **エラーハンドリングの強化**
  - 無効遷移の適切な処理
  - エラーメッセージの明確化
  - デバッグ情報の出力

#### 2.8 成果物
- src/state_transition/state_transition.cpp（完全版）
- src/state_transition/transition_validator.cpp（完全版）
- 全状態遷移パターンの実装完了

#### 2.9 成功指標
- [ ] 全状態遷移パターンの実装完了
- [ ] 長押し処理の実装完了
- [ ] エッジケースの処理完了
- [ ] エラーハンドリングの強化完了

### Phase 3: テスト・統合（5-6日目）

#### 2.10 実施内容
- [ ] **テスト基盤の構築**
  - 単体テストの作成
  - 統合テストの作成
  - エッジケーステストの作成
  - テスト自動化スクリプトの作成

- [ ] **テストケースの実装**
  - 典型パターンのテスト（メイン→入力、入力→メイン等）
  - エッジケースのテスト（連打、長押し、無効遷移）
  - 境界値のテスト（最大アラーム数、選択インデックス等）

- [ ] **main.cppのリファクタリング**
  - 既存のhandleButtons()関数を新しいシステムで置き換え
  - 段階的な移行によるリスク最小化
  - 既存機能の動作確認

- [ ] **テスト実行・カバレッジ測定**
  - native環境でのテスト実行
  - テストカバレッジの測定
  - カバレッジレポートの生成

#### 2.11 成果物
- test/test_state_transition.cpp
- test/test_integration.cpp
- test/test_edge_cases.cpp
- テスト自動化スクリプト
- カバレッジレポート

#### 2.12 成功指標
- [ ] テスト基盤の構築完了
- [ ] 全テストケースの実装完了
- [ ] main.cppのリファクタリング完了
- [ ] テストカバレッジ20%台到達

### Phase 4: 後処理・クリーンアップ（7日目）

#### 2.13 実施内容
- [ ] **古いコードの削除**
  - main.cppから不要な状態遷移ロジックを削除
  - REL_MINUS_TIME_INPUT関連の処理を削除
  - SCHEDULE_SELECT関連の処理を削除
  - Bボタン長押しの無効化処理を削除

- [ ] **コードの最適化**
  - 不要な変数・関数の削除
  - コメントの整理・更新
  - コードスタイルの統一

- [ ] **ドキュメントの更新**
  - 実装完了報告書の作成
  - API仕様書の更新
  - 使用方法のドキュメント作成

- [ ] **CI/CD連携**
  - テストスクリプトのCI/CD連携
  - 自動ビルド・テストの設定
  - カバレッジレポートの自動生成

#### 2.14 成果物
- クリーンアップされたmain.cpp
- 実装完了報告書
- API仕様書
- CI/CD設定ファイル

#### 2.15 成功指標
- [ ] 古いコードの削除完了
- [ ] コードの最適化完了
- [ ] ドキュメントの更新完了
- [ ] CI/CD連携完了

## 3. リスク管理

### 3.1 技術的リスク
- **ビルドエラー**: 段階的移行により最小化
- **機能退行**: テストケースで検出
- **パフォーマンス**: プロファイリングで確認

### 3.2 スケジュールリスク
- **Phase 0の遅延**: 基盤修正が遅れると全体に影響
- **Phase 2の複雑化**: 詳細実装が予想より複雑になる可能性
- **テストの不備**: テストケースが不十分で品質問題が発生

### 3.3 対策
- **段階的移行**: 各Phaseで動作確認を実施
- **テスト駆動開発**: 実装前にテストケースを作成
- **継続的統合**: 各段階でビルド・テストを実行

## 4. 成功指標

### 4.1 技術的指標
- [ ] main.cppの行数削減（400行 → 100行以下）
- [ ] 状態遷移ロジックの100%分離
- [ ] テストカバレッジ20%台到達
- [ ] ビルド時間の短縮

### 4.2 品質指標
- [ ] 全状態遷移パターンのテスト通過
- [ ] エッジケースの適切な処理
- [ ] エラーメッセージの明確化
- [ ] コードの可読性向上

### 4.3 保守性指標
- [ ] 新機能追加時の変更箇所の明確化
- [ ] バグ修正時の影響範囲の限定
- [ ] テスト実行時間の短縮（native環境）
- [ ] デバッグの容易性向上

## 5. 今後の展開

### 5.1 短期目標（1週間）
- 状態遷移ロジックの完全分離
- テストカバレッジ20%台到達
- 既存機能の動作保証

### 5.2 中期目標（1ヶ月）
- 他のモジュール（UI、入力処理等）の分離
- テストカバレッジ50%台到達
- CI/CD環境の完全構築

### 5.3 長期目標（3ヶ月）
- 全体的なアーキテクチャの改善
- テストカバレッジ80%台到達
- 開発効率の大幅向上

## 6. 結論

この計画により、状態遷移ロジックの修正からテストカバレッジ向上まで、段階的かつ確実に実現できます。

**重要なポイント**:
1. **Phase 0の重要性**: 基盤修正が全体の成功を左右
2. **段階的アプローチ**: リスクを最小化しつつ確実に進歩
3. **テスト駆動**: 品質を保証しながら開発を進める
4. **継続的改善**: 各Phaseでの振り返りと改善

この計画に従って進めることで、堅牢で保守性の高い状態遷移システムを構築し、テストカバレッジの大幅な向上を実現できます。 