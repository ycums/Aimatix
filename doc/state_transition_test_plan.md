# 状態遷移ロジック分離・テスト自動化計画書

## 目的

- ボタン押下による状態遷移の壊れやすさを根本的に改善し、堅牢なイベントハンドリングを実現する。
- 状態遷移ロジックを純粋ロジックとして分離し、native環境で自動テスト可能にする。
- イベントハンドリング階層化の価値（堅牢性・保守性・テスト容易性）を最大化する。

## 背景

- 現状、main.cppやinput.cppに状態遷移ロジックが分散・埋め込みとなっており、
  ボタン押下による画面遷移・モード遷移が壊れやすい。
- イベントハンドリングの階層化（ButtonManager/DebounceManager/ModeManager）は導入済みだが、
  状態遷移自体の自動テストが困難な構造となっている。
- UIやM5Stack依存部分は実機テストに頼らざるを得ないが、
  状態遷移ロジック自体は純粋ロジックとして分離・自動テスト可能。

## 目標

- 状態遷移ロジックを関数/クラスとして分離し、native環境で自動テスト可能にする。
- 主要な画面遷移・モード遷移パターンを網羅的にテストする。
- エッジケース（連打・長押し・同時押し・無効遷移）もテストする。
- テストカバレッジを20%台まで引き上げる。

## 実施方針

1. **状態遷移ロジックの分離**
    - 例: `Mode nextMode = handleButtonEvent(Mode current, ButtonEvent event);`
    - 状態遷移表・遷移マトリクスを明文化
    - main.cpp/input.cppから状態遷移ロジックを抽出
2. **テスト用インターフェースの設計**
    - ButtonEvent型（A/B/C, 短押し/長押し/同時押し など）を定義
    - 状態遷移関数をテストから直接呼び出せる形に
3. **状態遷移テストケースの作成**
    - 典型パターン（例: メイン→時刻入力、メイン→設定、入力→メイン など）
    - エッジケース（連打、長押し、同時押し、無効遷移）
    - 境界値（最大アラーム数、警告表示中の遷移抑止 など）
4. **テスト自動化・カバレッジ測定**
    - g++/clang++でnativeビルド・自動実行
    - テストスクリプトに組み込み、CI/CDにも対応
5. **main.cpp等のリファクタリング**
    - 分離したロジックを呼び出す形に整理
    - 実装とテストの一貫性を維持

## スケジュール

- **1日目**: 状態遷移表・遷移マトリクスの作成、分離方針決定
- **2-3日目**: 状態遷移ロジックの分離・関数化、ButtonEvent型設計
- **4-5日目**: テストケース作成・自動テスト実装
- **6日目**: main.cpp等のリファクタリング、テスト組み込み
- **7日目**: カバレッジ測定・レポート、CI/CD連携

## 成功指標

- 状態遷移ロジックの100%自動テスト化
- 主要な画面遷移・モード遷移パターンの網羅
- エッジケース・異常系のテスト通過
- テストカバレッジ20%台到達
- main.cpp等の可読性・保守性向上

## 参考: 状態遷移表（例）

| 現在モード         | ボタンイベント         | 次モード           |
|--------------------|------------------------|--------------------|
| MAIN_DISPLAY       | A短押し                | ABS_TIME_INPUT     |
| MAIN_DISPLAY       | B短押し                | REL_PLUS_TIME_INPUT|
| MAIN_DISPLAY       | B長押し                | REL_MINUS_TIME_INPUT|
| MAIN_DISPLAY       | C短押し                | SCHEDULE_SELECT    |
| MAIN_DISPLAY       | C長押し                | SETTINGS_MENU      |
| ABS_TIME_INPUT     | C短押し                | MAIN_DISPLAY       |
| ...                | ...                    | ...                |

## 今後のタスク

- [ ] 状態遷移表・遷移マトリクスの詳細化
- [ ] ButtonEvent型・遷移関数の設計
- [ ] テストケースの洗い出し・実装
- [ ] main.cpp等のリファクタリング
- [ ] テストスクリプト・CI/CD連携 