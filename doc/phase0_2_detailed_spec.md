# Phase 0.2 詳細実装仕様書

## 1. 概要

Phase 0.2で確定した実装計画の具体的な仕様を定義する。各フェーズの完成基準、実装範囲、テスト戦略を明確化する。

## 2. Phase 1.4 基本タイマー機能の完成基準

### 2.1 現在時刻表示の正確性確認

#### 実装要件
- **更新頻度**: 1秒間隔
- **表示形式**: HH:MM
- **表示位置**: グリッドセル(0,1)-(15,2)
- **フォント**: Font4（高さ26px）
- **色**: アンバー色（#FB20）
- **配置**: 水平中央寄せ

#### 実装ファイル
- `src/ui.cpp`: `drawMainDisplay()`関数の修正
- `src/main.cpp`: 時刻更新処理の最適化

#### テスト項目
- [ ] 1秒間隔での正確な更新
- [ ] 時刻形式の正確性（HH:MM）
- [ ] 表示位置の正確性
- [ ] フォント・色の正確性

### 2.2 アラーム設定・削除の基本動作確認

#### 実装要件
- **最大アラーム数**: 5件
- **重複チェック**: 同一時刻の追加を拒否
- **過去時刻削除**: 現在時刻以前のアラームを自動削除
- **自動ソート**: 時刻順での自動ソート

#### 実装ファイル
- `src/alarm.cpp`: アラーム管理機能の完成
- `src/time_logic.cpp`: AlarmLogicクラスの活用

#### テスト項目
- [ ] 最大5件の制限確認
- [ ] 重複チェック機能
- [ ] 過去時刻の自動削除
- [ ] 時刻順での自動ソート

### 2.3 画面遷移の安定性確認

#### 実装要件
- **全モード間遷移**: 8つのモード間の安定した遷移
- **デバウンス処理**: 200msのボタンデバウンス
- **警告メッセージ**: エラー時の適切な表示

#### 実装ファイル
- `src/state_transition/`: 状態遷移システムの活用
- `src/button_manager.cpp`: ボタン管理の改善

#### テスト項目
- [ ] 全モード間の遷移動作
- [ ] デバウンス処理の効果
- [ ] 警告メッセージの表示

### 2.4 既存バグの修正

#### 修正対象
- **⚡アイコン問題**: 警告表示の不具合
- **ヘッダー競合**: Windows環境での型定義競合
- **リンクエラー**: テスト環境での未解決シンボル

#### 実装ファイル
- `test/mocks/mock_m5stack.h`: ヘッダー競合の解決
- `scripts/run_simple_tests.py`: リンクエラーの解決

#### テスト項目
- [ ] 警告表示の正常動作
- [ ] Windows環境でのビルド成功
- [ ] テスト環境での実行成功

### 2.5 基本的なバリデーションの実装

#### 実装要件
- **時刻入力値**: 00:00-23:59の範囲チェック
- **アラーム数**: 最大5件の上限チェック
- **境界値**: 入力値の境界値チェック

#### 実装ファイル
- `src/input.cpp`: バリデーション強化
- `src/time_logic.cpp`: InputLogicクラスの活用

#### テスト項目
- [ ] 時刻入力値の妥当性チェック
- [ ] アラーム数の上限チェック
- [ ] 境界値の正確な処理

## 3. 電源管理機能の詳細仕様

### 3.1 アイドル時間監視

#### 実装要件
- **デフォルト時間**: 5分間の無操作でスリープ
- **設定範囲**: 1分-30分（設定可能）
- **例外条件**: タイマーカウントダウン中はスリープしない

#### 実装ファイル
- `src/power_manager.cpp`: 新規作成
- `src/power_manager.h`: 新規作成

#### 設定項目
```cpp
struct PowerSettings {
    uint8_t idle_timeout_minutes;  // アイドルタイムアウト（分）
    bool enable_sleep;             // スリープ機能有効/無効
    bool keep_awake_during_timer;  // タイマー中はスリープしない
};
```

### 3.2 スリープ復帰方法

#### 実装要件
- **復帰方法**: 任意ボタン押下
- **状態保持**: 復帰後は直前の画面に戻る
- **復帰処理**: 画面状態の復元

#### 実装ファイル
- `src/power_manager.cpp`: スリープ・復帰処理
- `src/main.cpp`: スリープ状態の管理

### 3.3 動作周波数制御

#### 実装要件
- **通常時**: 100Hz（10ms間隔）
- **アイドル時**: 1Hz（1秒間隔）
- **有線電源**: 常時100Hz

#### 実装ファイル
- `src/main.cpp`: ループ処理の最適化
- `src/power_manager.cpp`: 周波数制御

### 3.4 バッテリー監視

#### 実装要件
- **警告閾値**: 20%以下で警告色表示
- **充電表示**: 充電中は緑色表示
- **精度**: バッテリー残量の1%精度表示

#### 実装ファイル
- `src/ui.cpp`: バッテリー表示の改善
- `src/power_manager.cpp`: バッテリー監視

## 4. UI/UX改善の優先順位

### 4.1 高優先度（Phase 1.4で実装）

#### メイン表示画面の完成
- **残り時間表示**: HH:MM:SS形式、Font7、中央配置
- **進捗バー**: 高さ12px、アンバー色、背景黒
- **アラームリスト**: 最大5件、水平配置、Font2

#### 入力モードの完成
- **桁ごと編集**: 4桁の個別編集
- **バリデーション**: 時刻範囲チェック
- **カーソル表示**: ネガポジ反転

#### アラーム鳴動画面の完成
- **フラッシュ点滅**: 0.5秒間隔、オレンジ⇔黒
- **オーバータイム表示**: +HH:MM:SS形式
- **音制御**: 880Hz、500ms間隔

### 4.2 中優先度（Phase 2で実装）

#### アラーム管理画面の完成
- **アラームリスト表示**: 選択・削除機能
- **並び替え機能**: 時刻順・追加順
- **一括操作**: 全削除機能

#### 設定メニューの完成
- **設定項目**: LCD明度、音設定、電源設定
- **確認ダイアログ**: 設定変更時の確認
- **デフォルト復元**: 設定のリセット機能

#### 警告メッセージシステムの改善
- **メッセージ種類**: エラー、警告、情報
- **表示時間**: 設定可能な表示時間
- **自動消去**: タイムアウト時の自動消去

### 4.3 低優先度（Phase 3で実装）

#### 電源管理機能の詳細実装
- **詳細設定**: スリープ時間、動作周波数
- **統計情報**: バッテリー使用量、動作時間
- **最適化**: 電力消費の最適化

#### パフォーマンス最適化
- **メモリ使用量**: RAM 0.5%以下、Flash 10%以下
- **処理速度**: メインループ100Hz維持
- **バッテリー持続時間**: 8時間以上

#### エラーハンドリングの統合
- **エラー分類**: システム、ユーザー、ハードウェア
- **復旧処理**: 自動復旧機能
- **ログ機能**: エラー履歴の記録

## 5. 実装ファイルの修正範囲

### 5.1 既存ファイルの修正

#### src/main.cpp
- **ループ処理の最適化**: 100Hz動作の維持
- **エラーハンドリング追加**: 例外処理の強化
- **電源管理統合**: スリープ・復帰処理

#### src/ui.cpp
- **メイン表示画面の完成**: 残り時間、進捗バー、アラームリスト
- **バッテリー表示改善**: 警告色、充電表示
- **警告メッセージ改善**: 表示システムの強化

#### src/input.cpp
- **バリデーション強化**: 時刻範囲、境界値チェック
- **エラー処理改善**: 適切なエラーメッセージ
- **カーソル表示改善**: 視覚的フィードバック

#### src/alarm.cpp
- **アラーム管理機能の完成**: 追加・削除・ソート
- **重複チェック**: 同一時刻の検出
- **過去時刻削除**: 自動クリーンアップ

#### src/settings.cpp
- **Preferences移行**: EEPROMからPreferencesへの移行
- **設定項目追加**: 電源設定、音設定
- **設定検証**: 設定値の妥当性チェック

### 5.2 新規作成ファイル

#### src/power_manager.cpp
```cpp
class PowerManager {
public:
    static void initialize();
    static void update();
    static void enterSleep();
    static void wakeUp();
    static bool isIdle();
    static void resetIdleTimer();
    
private:
    static unsigned long lastActivityTime;
    static bool isSleeping;
    static PowerSettings settings;
};
```

#### src/wifi_manager.cpp
```cpp
class WiFiManager {
public:
    static bool connect(const char* ssid, const char* password);
    static bool isConnected();
    static void disconnect();
    static void saveCredentials(const char* ssid, const char* password);
    static bool loadCredentials(char* ssid, char* password);
};
```

#### src/time_sync.cpp
```cpp
class TimeSync {
public:
    static bool syncWithNTP();
    static bool isTimeValid();
    static void setTime(time_t timestamp);
    static time_t getCurrentTime();
};
```

#### src/error_handler.cpp
```cpp
class ErrorHandler {
public:
    static void handleError(ErrorType type, const char* message);
    static void showErrorMessage(const char* message);
    static void logError(const char* message);
    static bool hasErrors();
};
```

## 6. テスト戦略の具体化

### 6.1 Unit Test戦略

#### テスト環境
- **実行環境**: Windows native環境
- **フレームワーク**: Unity
- **カバレッジ目標**: 80%以上
- **実行頻度**: 各コミット時

#### テスト対象
- **純粋ロジック**: M5Stack依存なしの機能
- **バリデーション**: 入力値チェック機能
- **計算ロジック**: 時刻計算、進捗計算

#### テストファイル
- `test/test_time_logic_simple.cpp`: 時刻計算テスト
- `test/test_alarm_logic_simple.cpp`: アラーム管理テスト
- `test/test_input_logic_simple.cpp`: 入力処理テスト
- `test/test_settings_logic_simple.cpp`: 設定管理テスト

### 6.2 統合テスト戦略

#### テスト対象
- **モード間遷移**: 全モード間の遷移パターン
- **エラーケース**: 各種エラーシナリオ
- **パフォーマンス**: 動作周波数、メモリ使用量

#### テストファイル
- `test/test_integration.cpp`: 統合テスト
- `test/test_state_transition.cpp`: 状態遷移テスト
- `test/test_performance.cpp`: パフォーマンステスト

### 6.3 実機テスト戦略

#### テスト条件
- **実行タイミング**: 統合テスト通過後の最終確認
- **テスト時間**: 最小限（基本動作確認のみ）
- **テスト項目**: ハードウェア連携、長時間動作

#### テスト項目
- **基本動作確認**: 各モードの画面表示
- **ハードウェア連携**: ボタン、スピーカー、LED
- **実環境での安定性**: 長時間動作確認

## 7. 成功指標

### 7.1 機能指標
- [ ] 全仕様の100%実装
- [ ] 残り時間表示精度±1秒以内
- [ ] 進捗バー精度±1%以内
- [ ] アラーム鳴動精度±0.1秒以内

### 7.2 品質指標
- [ ] Unit Testカバレッジ80%以上
- [ ] 統合テストカバレッジ95%以上
- [ ] ビルド成功率100%
- [ ] メモリ使用量最適化達成

### 7.3 パフォーマンス指標
- [ ] メインループ100Hz維持
- [ ] RAM使用量0.5%以下
- [ ] Flash使用量10%以下
- [ ] バッテリー持続時間8時間以上

## 8. リスク管理

### 8.1 技術リスク
- **M5Stackライブラリの制限**: 代替実装の検討
- **メモリ不足**: 最適化手法の適用
- **パフォーマンス劣化**: 段階的な最適化

### 8.2 スケジュールリスク
- **実装遅延**: 優先度の調整
- **テスト遅延**: 並行作業の推進
- **統合問題**: 早期統合テストの実施

## 9. 次のステップ

### 9.1 Phase 0.3: Unityテスト環境の改善
- モック環境の完全実装
- ヘッダー競合の解決
- テストファイルの修正

### 9.2 Phase 0.4: テスト戦略の確立
- テスト実行の自動化
- カバレッジ測定の導入
- テスト結果の可視化

### 9.3 Phase 1: 基盤技術の整備
- Wi-Fi設定のSmartConfig対応
- NTP同期機能の改善
- 設定管理のPreferences移行
- 基本タイマー機能の完成 