# 入力モード詳細仕様書

## 概要
M5Stack Fire集中タイマーの時刻入力機能に関する詳細仕様。2つの入力モード（絶対時刻、相対時刻追加）の動作とUI仕様を定義する。

## 入力モード種類

### 1. 絶対時刻入力 (ABS_TIME_INPUT)
- **目的**: 指定した時刻にアラームを設定
- **入力値**: HH:MM形式の時刻
- **計算**: 入力値そのものをアラーム時刻として使用

### 2. 相対時刻追加 (REL_PLUS_TIME_INPUT)
- **目的**: 現在時刻から指定時間後にアラームを設定
- **入力値**: HH:MM形式の時間間隔
- **計算**: 現在時刻 + 入力値 = アラーム時刻



## UIレイアウト仕様

### 画面構成
```
┌─────────────────────────────────────┐
│ タイトルバー: モード名 + バッテリー │ ← Font2, アンバー色
├─────────────────────────────────────┤
│                                     │
│                                     │
│                                     │
│        時刻入力表示 (HH:MM)         │ ← Font7, 中央配置
│        カーソルハイライト           │   グリッド(0,3)-(15,5)
│                                     │
│                                     │
│        プレビュー表示               │ ← Font2, 中央配置
│                                     │   グリッド(2,6)-(13,6)
│                                     │
│                                     │
├─────────────────────────────────────┤
│ A:+1/+5  B:Next/Reset  C:Set       │ ← Font2, アンバー色
└─────────────────────────────────────┘
```

### レイアウト詳細
- **全体グリッド**: 16×12（320×240px）
- **タイトルバー**: 上部固定（1グリッド高さ、20px）
- **コンテンツエリア**: 16×10グリッド（座標系: (0,0)-(15,9)）
- **ボタンヒント**: 下部固定（1グリッド高さ、20px）

### 要素配置
- **時刻入力表示**: グリッドセル(0,3)-(15,5)
  - Font7使用（高さ48px）
  - 水平中央寄せ
  - メイン画面の残り時間表示と同じ位置
- **プレビュー表示**: グリッドセル(2,6)-(13,6)
  - Font2使用（高さ16px）
  - 水平中央寄せ
- **ボタンヒント**: 全体グリッド最下部
  - Font2使用（高さ16px）
  - アンバー色

## 入力方式仕様

### 桁ごと編集方式
- **カーソル位置**: 4桁の時刻を個別に編集
  - 位置0: 時十の位（0-2）
  - 位置1: 時一の位（0-9、時十が2の場合は0-3）
  - 位置2: 分十の位（0-5）
  - 位置3: 分一の位（0-9）

### 初期状態
- **初期値**: 00:00
- **カーソル初期位置**: 0（時十の位）
- **モード**: メイン画面のボタン操作で決定

### カーソル表示
- **表示方法**: ネガポジ反転
  - 背景: アンバー色（#FB20）
  - 文字: 黒色（#0000）
- **点滅**: なし（常時ハイライト表示）
- **移動方向**: 左から右（0→1→2→3→0）

## 入力値検証・制限

### 時刻範囲制限
- **全体範囲**: 00:00-23:59
- **時十の位**: 0-2（0,1,2のみ有効）
- **時一の位**: 0-9（時十が2の場合、0-3のみ有効）
- **分十の位**: 0-5（0,1,2,3,4,5のみ有効）
- **分一の位**: 0-9（0-9すべて有効）

### 制限処理
- **無効値入力時**: 最大値に制限
  - 例：時十に3を入力→2に制限
- **制限時のフィードバック**: 
  - 音: なし
  - 視覚的フィードバック: なし

## ボタン操作仕様

### Aボタン（値変更）
- **短押し**: +1
  - 判定タイミング: 離した瞬間
  - 最大値到達時: 0に戻る（循環）
- **長押し**: +5
  - 判定タイミング: 0.5秒経過時点で1回のみ
- **連続入力**: 制限なし（連続押下可能）

### Bボタン（移動・リセット）
- **短押し**: 桁送り
  - 判定タイミング: 離した瞬間
  - 移動方向: 左から右（0→1→2→3→0）
- **長押し**: リセット
  - 判定タイミング: 1秒経過時点で実行
  - 処理内容: 入力値を00:00に戻し、カーソル位置を0に戻す

### Cボタン（確定・戻る）
- **短押し**: セット（確定）
  - 処理: アラーム追加（重複・過去時刻チェック付き）
  - エラー時: エラーメッセージ表示（1秒間）
- **長押し**: メイン画面に戻る
  - 判定タイミング: 1秒経過時点で実行

## プレビュー表示仕様

### 表示内容
- **絶対時刻入力**: "Set: HH:MM"
- **相対時刻追加**: "Now + HH:MM = HH:MM"


### 更新タイミング
- **更新条件**: 入力値変更時即座に更新
- **計算基準**: 現在時刻を基準に計算

### 時刻計算仕様
- **日付跨ぎ処理**: 24時間を超える場合は翌日として計算
- **過去時刻処理**: 絶対時刻入力時、現在時刻以前の場合は翌日の時刻として計算

### 表示例
- **絶対時刻**: "Set: 14:30"
- **絶対時刻（過去）**: "Set: 14:30 (tomorrow)"（現在15:00の場合）
- **相対追加**: "Now + 02:15 = 16:45"（現在14:30の場合）

## エラー処理

### アラーム追加時のエラー
- **重複チェック**: 同一時刻は追加不可
- **過去時刻処理**: 絶対時刻入力時、現在時刻以前の場合は翌日の時刻として設定
- **エラー表示**: エラーメッセージを1秒間表示
- **エラー後の状態**: 入力モードに戻る（入力値は保持）

### エラーメッセージ例
- 重複時: "Already exists"

## 技術仕様

### 動作周波数
- **メインループ**: 100Hz（10ms間隔）
- **画面更新**: 100ms間隔（ボタン押下時は即時）

### デバウンス処理
- **モード遷移時**: 200ms
- **ボタン判定**: 離した瞬間（短押し）、一定時間経過時点（長押し）

### メモリ使用
- **入力値**: 4バイト（時十、時一、分十、分一）
- **カーソル位置**: 1バイト
- **モード状態**: 1バイト

## 制限事項

### 機能制限
- **最大アラーム数**: 5個
- **入力範囲**: 00:00-23:59
- **カーソル移動**: 4桁固定

### ハードウェア制限
- **振動機能**: 非搭載（代替としてRGB LEDで通知）
- **音声入力**: 未実装（将来拡張予定）

## 将来拡張予定

### 機能拡張
- **音声入力**: マイクを使用した音声コマンド
- **外部振動**: Groveポート経由での振動モーター接続
- **Bluetooth連携**: スマートフォンアプリとの連携

### UI改善
- **RGB LED通知**: アラーム時の色変更・点滅パターン
- **アニメーション**: カーソル移動時の視覚的フィードバック
