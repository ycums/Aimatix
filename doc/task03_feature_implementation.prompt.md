# task03_feature_implementation.prompt.md

## 目的

M5Stack集中タイマーの「未実装機能・詳細ロジックの実装」フェーズに着手する。主に以下の内容を段階的に実装・検証する。

## 現在の実装状況（2024年12月時点）

### 完了済み機能 ✅
- ✅ **統一されたボタン管理システム**: ButtonManagerによる一元管理
- ✅ **階層化されたデバウンス管理**: DebounceManagerによる3段階デバウンス
- ✅ **状態遷移システム**: 完全な状態遷移システムが実装済み
- ✅ **警告メッセージ機能**: Amber CRTテーマ準拠の警告表示
- ✅ **基本的なUIシステム**: グリッドレイアウト、フォント階層
- ✅ **設定管理**: EEPROMベースの設定保存・読み込み
- ✅ **アラーム管理**: 基本的なアラーム機能

### 未実装・改善が必要な機能 ❌
- ❌ **メイン表示画面の詳細作り込み**: 残り時間計算、進捗バー、プレビュー表示
- ❌ **入力モードの詳細ロジック**: 桁ごと編集、プレビュー表示、バリデーション
- ❌ **アラーム鳴動状態の詳細**: フラッシュ点滅、オーバータイム表示
- ❌ **SETTINGSサブメニューの詳細**: 設定変更、永続化、確認ダイアログ

## 実装計画（仕様書準拠版）

### 1. メイン表示画面の詳細作り込み
**仕様**: `main_display_detailed_spec.md`に基づく

#### 1.1 残り時間の正確な計算・表示
- **表示形式**: HH:MM:SS
- **計算ロジック**: 次アラーム時刻 - 現在時刻
- **更新頻度**: 1秒間隔
- **表示位置**: グリッドセル(0,3)-(15,5)、Font7、中央配置

#### 1.2 進捗バーの進捗率計算と描画
- **計算基準**: 直前の解除時刻～次アラーム時刻
- **表示位置**: グリッドセル(0,6)-(15,7)、高さ12px
- **進捗率**: (現在時刻 - 解除時刻) / (次アラーム時刻 - 解除時刻)
- **視覚効果**: アンバー色のプログレスバー

#### 1.3 鳴動時刻リスト
- **表示位置**: グリッドセル(0,8)-(15,9)、Font2
- **最大表示数**: 5件（水平配置）
- **フォーマット**: HH:MM形式

### 2. 入力モードのロジック実装
**仕様**: `time_inpt_detailed_spec.md`に基づく

#### 2.1 数字入力UI（桁ごと編集方式）
- **カーソル位置**: 4桁（時十、時一、分十、分一）
- **表示方法**: ネガポジ反転（背景:アンバー、文字:黒）
- **初期値**: 00:00、カーソル位置:0
- **移動方向**: 左から右（0→1→2→3→0）

#### 2.2 入力値のバリデーション
- **時刻範囲**: 00:00-23:59
- **制限処理**: 無効値は最大値に制限
- **エラー処理**: 重複チェック、過去時刻処理

#### 2.4 ボタン操作の詳細実装
- **Aボタン**: 短押し(+1)、長押し(+5、0.5秒)
- **Bボタン**: 短押し(桁送り)、長押し(リセット、1秒)
- **Cボタン**: 短押し(確定)、長押し(キャンセル、1秒)

### 3. アラーム鳴動状態の詳細
**仕様**: `alarm_active_detailed_spec.md`に基づく

#### 3.1 フラッシュオレンジ点滅
- **点滅間隔**: 0.5秒
- **色**: フラッシュオレンジ(#F000)⇔黒
- **表示時間**: 最大5秒間

#### 3.2 オーバータイム表示
- **表示形式**: +HH:MM:SS
- **計算**: 現在時刻 - アラーム時刻
- **表示位置**: グリッドセル(0,3)-(15,5)、Font7

#### 3.3 音の間欠制御
- **音**: 880Hz、500ms間隔（設定で無効化可能）
- **停止条件**: 任意ボタン押下または5秒経過

### 4. SETTINGSサブメニューの作り込み
**仕様**: 設定メニュー構造体に基づく

#### 4.1 各設定項目の選択・変更・永続化
- **SOUND**: ON/OFF切り替え、EEPROM保存
- **LCD BRIGHTNESS**: 0-100%調整、EEPROM保存
- **WARNING COLOR TEST**: テスト画面遷移
- **ALL CLEAR**: 二重確認ダイアログ
- **INFO**: 情報画面遷移

#### 4.2 選択項目のネガポジ反転表示
- **表示方法**: 水平方向全体を反転
- **フォント**: Font4
- **色**: 背景:アンバー、文字:黒

#### 4.3 二重確認ダイアログ
- **ALL CLEAR確認**: "DELETE ALL DATA?"表示
- **YES/NO選択**: A:YES、C:NO
- **実行内容**: 全アラーム削除、設定リセット

### 5. エラーハンドリング・UI改善
**仕様**: 警告メッセージ機能を活用

#### 5.1 入力エラー時の警告表示
- **重複エラー**: "Already exists"
- **無効時刻**: "Invalid time"
- **最大数エラー**: "Max 5 alarms"
- **表示時間**: 3秒間
- **バイブレーション**: 1回（100ms）

#### 5.2 Wi-Fi/NTP失敗時の表示
- **接続失敗**: "WiFi Failed"
- **同期失敗**: "NTP Failed"
- **自動復旧**: 30秒後に再試行

### 6. Unit Testの追加
**仕様**: 既存のテスト環境を活用

#### 6.1 時刻計算テスト
- **残り時間計算**: 正負値、日付跨ぎ
- **進捗率計算**: 境界値、異常値
- **アラーム時刻計算**: 絶対・相対時刻

#### 6.2 入力処理テスト
- **バリデーション**: 範囲チェック、制限処理
- **プレビュー計算**: 絶対・相対時刻の計算
- **エラー処理**: 重複、無効値の処理

#### 6.3 設定管理テスト
- **EEPROM保存**: 設定の永続化
- **チェックサム**: 整合性チェック
- **デフォルト値**: 初期化処理

## 実行手順

### Phase 1: メイン表示画面の詳細作り込み
1. **残り時間計算ロジック実装** (`alarm.cpp`)
2. **進捗バー描画実装** (`ui.cpp`)
3. **アラームリスト表示改善** (`ui.cpp`)
4. **ビルド・実機確認**

### Phase 2: 入力モードの詳細実装
1. **桁ごと編集UI実装** (`ui.cpp`)
2. **プレビュー表示実装** (`ui.cpp`)
3. **バリデーション強化** (`input.cpp`)
4. **ビルド・実機確認**

### Phase 3: アラーム鳴動状態の詳細
1. **フラッシュ点滅実装** (`ui.cpp`)
2. **オーバータイム表示実装** (`ui.cpp`)
3. **音制御改善** (`alarm.cpp`)
4. **ビルド・実機確認**

### Phase 4: SETTINGSサブメニューの詳細
1. **設定変更ロジック実装** (`settings.cpp`)
2. **確認ダイアログ実装** (`ui.cpp`)
3. **永続化処理強化** (`settings.cpp`)
4. **ビルド・実機確認**

### Phase 5: エラーハンドリング・テスト
1. **エラーメッセージ追加** (`ui.cpp`)
2. **Unit Test追加** (`test/`フォルダ)
3. **統合テスト実行**
4. **最終ビルド・実機確認**

## 技術仕様

### ハードウェア仕様（M5Stack Fire v2.7）
- **ディスプレイ**: 2.0インチ 320×240 ILI9342C IPSパネル
- **ボタン**: カスタム物理ボタン ×3
- **RGB LED**: SK6812 ×10（通知用）
- **スピーカー**: 1W-0928（アラーム音用）
- **バッテリー**: 500mAh 3.7V

### ソフトウェア仕様
- **動作周波数**: メインループ100Hz（10ms間隔）
- **画面更新**: 100ms間隔（ボタン押下時は即時）
- **デバウンス**: モード遷移200ms、ボタン判定50ms
- **メモリ使用**: RAM 0.7%、Flash 8.1%（現在の実績）

### UI/UX仕様
- **Amber CRTテーマ**: 黒/ダークグレー背景、アンバー文字、オレンジ警告
- **グリッドレイアウト**: 16×12グリッド（320×240px）
- **フォント階層**: Font7（主要）、Font4（補助）、Font2（ヒント）
- **色定義**: アンバー(#FB20)、フラッシュオレンジ(#F000)、黒(#0000)

## 成功指標

### 機能指標
- [ ] 残り時間の正確な表示（±1秒以内）
- [ ] 進捗バーの正確な進捗率表示
- [ ] 入力モードの完全な桁ごと編集
- [ ] プレビュー表示の正確な計算
- [ ] アラーム鳴動の適切な制御

### 品質指標
- [ ] 全エラーケースの適切な処理
- [ ] UI/UXの一貫性維持
- [ ] パフォーマンスの維持（100Hz動作）
- [ ] メモリ使用量の最適化

### テスト指標
- [ ] Unit Testカバレッジ80%以上
- [ ] 統合テストの全パターン通過
- [ ] 実機テストの成功

---

次は「Phase 1: メイン表示画面の詳細作り込み」から着手する。
- `alarm.cpp`/`alarm.h` に残り時間計算ロジックを実装
- `ui.cpp`/`ui.h` に進捗バー・アラームリスト表示を改善
- `main.cpp` でこれらを呼び出す

この内容で進めます。
