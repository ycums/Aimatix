# 実装計画書 3-0-11: アラーム管理画面（AlarmDisplay）雛形追加・遷移

## 1. 概要

### 1.1 実装目標
- メイン画面C短押しでアラーム管理画面（ALARM_MANAGEMENT）に遷移
- アラームリストの表示・選択・削除機能の実装
- 既存のAlarmLogicとの連携
- 品質基準（カバレッジ、静的解析）の達成

### 1.2 主要機能
- **画面遷移**: メイン画面 → アラーム管理画面
- **リスト表示**: 時刻順でアラーム一覧表示
- **ナビゲーション**: A/Bボタンで上下移動（端で停止）
- **削除機能**: C短押しで選択中のアラーム削除
- **戻り機能**: C長押しでメイン画面に戻る

### 1.3 完成条件
- [ ] メイン画面C短押しでアラーム管理画面に遷移できる
- [ ] アラームリストが正しく表示される（時刻順）
- [ ] アラームが存在しない場合は"NO ALARMS"が表示される
- [ ] A/Bボタンで選択位置を上下移動できる（端で停止）
- [ ] A/B長押しで選択位置を一番上/下に移動できる
- [ ] C短押しで選択中のアラームを削除できる
- [ ] C長押しでメイン画面に戻れる
- [ ] 削除後の選択位置が適切に調整される
- [ ] 最後のアラーム削除後は"NO ALARMS"が表示される
- [ ] カバレッジが品質ゲートを上回っている
- [ ] 静的解析実行（Clang-Tidy）

---

## 2. 設計・アーキテクチャ

### 2.1 既存コンポーネントの活用
- **AlarmLogic**: 既存のgetAlarms()、deleteAlarm()メソッドを活用
- **StateManager**: 既存の状態管理システムにAlarmDisplayStateを追加
- **IDisplay**: 既存の描画インターフェースを活用

### 2.2 新規作成コンポーネント
- **AlarmDisplayState**: アラーム管理画面の状態管理
- **AlarmDisplayViewImpl**: アラーム管理画面の描画実装

### 2.3 責務分離
- **AlarmDisplayState**: 選択位置管理、AlarmLogic連携
- **AlarmDisplayViewImpl**: UI描画、ボタンイベント処理
- **AlarmLogic**: アラームデータ管理（既存）

---

## 3. 実装手順

### Phase 1: 基本構造・インターフェース作成

#### 1.1 AlarmDisplayStateクラス作成
**ファイル**: `lib/libaimatix/src/AlarmDisplayState.h/cpp`

**実装内容**:
- 選択位置管理（selectedIndex）
- AlarmLogicとの連携
- ボタンイベントハンドラー
- 状態遷移処理

**テスト**: `test/pure/test_alarm_display_pure/`

#### 1.2 AlarmDisplayViewImplクラス作成
**ファイル**: `lib/libaimatix/src/AlarmDisplayViewImpl.h/cpp`

**実装内容**:
- IDisplayインターフェース実装
- アラームリスト描画
- 選択表示（背景色反転）
- 空リスト表示（"NO ALARMS"）

**テスト**: `test/pure/test_alarm_display_view_pure/`

#### 1.3 StateManagerへの登録
**ファイル**: `lib/libaimatix/src/StateManager.cpp`

**実装内容**:
- AlarmDisplayStateの登録
- ALARM_MANAGEMENTモードの処理追加

### Phase 2: 基本機能実装

#### 2.1 画面遷移機能
**実装内容**:
- メイン画面C短押しでALARM_MANAGEMENTに遷移
- 状態遷移テーブルの実装確認

**テスト観点**:
- 遷移の正常動作
- ボタンデバウンス処理

#### 2.2 アラームリスト表示
**実装内容**:
- AlarmLogic.getAlarms()でリスト取得
- 時刻順での表示
- Font4、アンバー色での描画

**テスト観点**:
- 空リスト表示
- 複数アラーム表示
- 時刻順ソート

#### 2.3 ナビゲーション機能
**実装内容**:
- A/Bボタンで上下移動
- A/B長押しで一番上/下に移動
- 端で停止（循環なし）

**テスト観点**:
- 境界値テスト（最初/最後）
- 長押し処理
- 選択位置の適切な管理

### Phase 3: 削除機能実装

#### 3.1 アラーム削除
**実装内容**:
- C短押しで選択中のアラーム削除
- AlarmLogic.deleteAlarm()の呼び出し
- 削除後の選択位置調整

**テスト観点**:
- 削除の正常動作
- 選択位置の適切な調整
- 最後のアラーム削除後の処理

#### 3.2 戻り機能
**実装内容**:
- C長押しでメイン画面に戻る
- 状態遷移の確認

**テスト観点**:
- 戻り遷移の正常動作
- 状態の適切なクリーンアップ

### Phase 4: UI・表示仕様実装

#### 4.1 選択表示
**実装内容**:
- 選択中のアラームの背景色反転
- アンバー背景、黒文字の表示

**テスト観点**:
- 選択表示の視認性
- 反転処理の正確性

#### 4.2 ボタンヒント
**実装内容**:
- 下部にA: "UP" B: "DOWN" C: "DEL"表示

**テスト観点**:
- ヒント表示の正確性
- フォント・色の適切性

#### 4.3 空リスト表示
**実装内容**:
- "NO ALARMS"の中央表示
- 適切なフォント・色での表示

**テスト観点**:
- 空リスト時の表示
- 中央配置の正確性

### Phase 5: 品質保証・テスト

#### 5.1 単体テスト
**テスト対象**:
- AlarmDisplayState
- AlarmDisplayViewImpl
- 状態遷移処理

**テスト観点**:
- 正常系・異常系・境界値
- エラーハンドリング
- メモリリーク

#### 5.2 統合テスト
**テスト対象**:
- StateManagerとの連携
- AlarmLogicとの連携
- UI描画の一貫性

**テスト観点**:
- 画面遷移の一貫性
- データの整合性
- 副作用の適切な管理

#### 5.3 品質チェック
**実行項目**:
- カバレッジ測定（品質ゲート上回り）
- 静的解析（Clang-Tidy）
- ビルド成功率100%

---

## 4. ファイル構成

### 4.1 新規作成ファイル
```
lib/libaimatix/src/
├── AlarmDisplayState.h
├── AlarmDisplayState.cpp
├── AlarmDisplayViewImpl.h
└── AlarmDisplayViewImpl.cpp

test/pure/
├── test_alarm_display_pure/
│   └── test_main.cpp
└── test_alarm_display_view_pure/
    └── test_main.cpp
```

### 4.2 修正ファイル
```
lib/libaimatix/src/
├── StateManager.h
└── StateManager.cpp

src/
└── main.cpp
```

---

## 5. テスト戦略

### 5.1 単体テスト（TDD方針）
**AlarmDisplayState**:
- 選択位置の管理
- ナビゲーション処理
- 削除処理
- 境界値テスト

**AlarmDisplayViewImpl**:
- 描画処理
- ボタンイベント処理
- 表示形式の正確性

### 5.2 統合テスト
**StateManager連携**:
- 状態遷移の正確性
- モード切り替えの一貫性

**AlarmLogic連携**:
- データ取得の正確性
- 削除処理の整合性

### 5.3 実機テスト
**UI動作確認**:
- 画面遷移の視認性
- ボタン操作の応答性
- 表示の視認性

---

## 6. 品質基準

詳細な品質ゲート基準については [品質ゲート基準](../operation/quality_gates.md) を参照してください。

### 6.1 カバレッジ目標
- **Unit Test**: 85%以上（純粋ロジック）
- **統合テスト**: 80%以上
- **全体**: 品質ゲート上回り

### 6.2 静的解析
- **Clang-Tidy**: 中重要度警告80件以下
- **ビルド成功率**: 100%
- **メモリ使用量**: 最適化

### 6.3 パフォーマンス
- **画面更新**: 100Hz維持
- **応答性**: ボタン操作200ms以内
- **メモリ**: 効率的な使用

---

## 7. リスク・対策

### 7.1 技術的リスク
**リスク**: 既存AlarmLogicとの連携不具合
**対策**: 段階的な統合テスト、モック活用

**リスク**: UI描画のパフォーマンス問題
**対策**: 描画最適化、フレームレート監視

### 7.2 品質リスク
**リスク**: カバレッジ不足
**対策**: TDD方針での実装、継続的な測定

**リスク**: 静的解析警告増加
**対策**: 早期対応、コーディング規約遵守

---

## 8. スケジュール

### Week 1: 基本構造・インターフェース
- [ ] AlarmDisplayStateクラス作成
- [ ] AlarmDisplayViewImplクラス作成
- [ ] 基本テスト作成

### Week 2: 基本機能実装
- [ ] 画面遷移機能
- [ ] アラームリスト表示
- [ ] ナビゲーション機能

### Week 3: 削除機能・UI実装
- [ ] アラーム削除機能
- [ ] 選択表示・ボタンヒント
- [ ] 空リスト表示

### Week 4: 品質保証・最終調整
- [ ] 統合テスト
- [ ] 品質チェック
- [ ] 実機テスト
- [ ] ドキュメント更新

---

## 9. 成功指標

### 9.1 機能指標
- [ ] 全仕様の100%実装
- [ ] 画面遷移の安定性
- [ ] アラーム管理機能の正確性

### 9.2 品質指標
詳細な品質ゲート基準については [品質ゲート基準](../operation/quality_gates.md) を参照してください。

- [ ] Unit Testカバレッジ85%以上
- [ ] 統合テストカバレッジ80%以上
- [ ] 静的解析警告80件以下

### 9.3 パフォーマンス指標
- [ ] 画面更新100Hz維持
- [ ] ボタン応答200ms以内
- [ ] メモリ使用量最適化

---

**作成日**: 2025年1月  
**バージョン**: 1.0.0  
**更新日**: 2025年1月  
**責任者**: 開発チーム  
**承認者**: プロジェクトマネージャー 