# DebounceManager リファクタリング計画

## 概要
DebounceManagerをstaticクラスからインスタンス化クラスへリファクタリングし、設計原則に従った依存性注入パターンを適用する。

## 背景
- 現在のDebounceManagerはstaticメソッド・static変数を使用
- テスト時にstatic状態の共有により問題が発生
- 設計原則（依存性注入、単一責任、テスト容易性）に反する実装

## リファクタリング目標
1. **static→インスタンス化**: テスト容易性の向上
2. **依存性注入パターン適用**: 設計原則の遵守
3. **インターフェース分離**: 抽象に依存する設計
4. **責務の明確化**: Business Logic Layerとしての位置づけ

## 実装手順

### ✅ 1. クラス定義の修正
- [x] staticメソッド・static変数を非staticに変更
- [x] コンストラクタを追加し、状態をインスタンス変数で管理
- [x] コピー禁止（delete）を追加
- [x] テスト用reset()はインスタンスメソッドとして残す

### ✅ 2. インターフェース定義
- [x] `IDebounceManager.h`を作成
- [x] 仮想関数でインターフェースを定義
- [x] 依存性注入パターンに従った設計

### ✅ 3. クラス実装の修正
- [x] `IDebounceManager`インターフェースを実装
- [x] overrideキーワードを追加
- [x] コンストラクタで状態初期化

### ✅ 4. ハードウェアアダプター層の実装
- [x] `M5StackDebounceManagerAdapter`を作成
- [x] `m5stack_adapters.h/cpp`に統合
- [x] 依存性注入による抽象化

### ✅ 5. 呼び出し側の修正
- [x] main.cppから直接的なインスタンスを削除
- [x] アダプター経由でのアクセスに変更
- [x] 設計原則に従った統合

### ✅ 6. テストコードの修正
- [x] インターフェースを使用するように修正
- [x] インスタンス化によるテスト分離
- [x] 設計原則に従ったテスト実装

## 設計原則の遵守

### ✅ 依存性注入パターン
- **抽象に依存**: `IDebounceManager`インターフェース
- **具象に依存しない**: 実装詳細の隠蔽
- **テスト容易性**: モック注入による単体テスト

### ✅ 単一責任原則
- **DebounceManager**: デバウンス処理のみ
- **M5StackDebounceManagerAdapter**: ハードウェア抽象化のみ
- **明確な責務分離**: 各クラスの役割が明確

### ✅ 開放閉鎖原則
- **拡張に対して開いている**: 新しいデバウンス実装の追加可能
- **修正に対して閉じている**: 既存コードの変更不要

### ✅ インターフェース分離原則
- **必要最小限のインターフェース**: 使用しない機能に依存しない
- **クリーンなAPI**: 明確で理解しやすいインターフェース

## アーキテクチャ統合

### ✅ Business Logic Layer
- **位置**: `lib/libaimatix/src/debounce_manager.h/cpp`
- **責務**: 純粋なデバウンスロジック
- **依存**: インターフェース（抽象）

### ✅ Hardware Adapters Layer
- **位置**: `src/m5stack_adapters.h/cpp`
- **責務**: M5Stackハードウェアの抽象化
- **依存**: Business Logic Layer

### ✅ UI Layer
- **位置**: `src/main.cpp`
- **責務**: ユーザーインターフェース
- **依存**: Hardware Adapters Layer経由でBusiness Logic Layer

## テスト戦略

### ✅ Unit Test
- **環境**: native環境
- **対象**: 純粋ロジック（DebounceManager）
- **モック**: 時間関数のモック
- **分離**: インスタンス化によるテスト分離

### ✅ 統合テスト
- **環境**: test-m5stack-fire環境
- **対象**: アダプターとロジックの連携
- **検証**: 実際のハードウェア動作

## 完了状況

### ✅ リファクタリング完了
- [x] static→インスタンス化の変換
- [x] 依存性注入パターンの適用
- [x] インターフェース分離の実装
- [x] アーキテクチャ統合の完了
- [x] テストコードの修正完了

### ✅ 設計原則の遵守
- [x] 依存性逆転原則の実装
- [x] 単一責任原則の遵守
- [x] 開放閉鎖原則の適用
- [x] インターフェース分離原則の実装

### ✅ 品質保証
- [x] テスト容易性の向上
- [x] 保守性の向上
- [x] 拡張性の確保
- [x] 再利用性の向上

## 次のステップ

### 🔄 テスト実行
- [ ] native環境でのテスト実行
- [ ] テスト結果の確認
- [ ] 必要に応じた修正

### 🔄 統合確認
- [ ] 実機での動作確認
- [ ] パフォーマンス確認
- [ ] メモリ使用量確認

### 🔄 ドキュメント更新
- [ ] アーキテクチャ設計書の更新
- [ ] API仕様書の更新
- [ ] 開発者ガイドの更新

---

**作成日**: 2025年1月  
**完了日**: 2025年1月  
**バージョン**: 1.0.0  
**ステータス**: リファクタリング完了 