# Phase 2.4.4 詳細作業計画書・手順書

## 目的
- UI層とロジック層（InputLogic/SettingsLogic等）の責務を明確に分離し、  
  「入力確定/設定保存イベントをUI層で受けて画面遷移・反映する」設計へリファクタする。
- テスト容易性・拡張性・保守性の向上。

---

## 1. 現状把握・課題抽出

### 1-1. 現状の責務分担を調査
- InputLogic/SettingsLogicのAPI・責務を確認
- UI層（ui.cpp, main.cpp等）での呼び出し・画面遷移処理の流れを確認

### 1-2. 問題点の洗い出し
- ロジック層がUI遷移や画面制御まで担当していないか
- UI層で「入力確定/保存」イベントを明示的に受けていない箇所がないか

---

## 2. 新設計方針の策定

### 2-1. 責務分離の原則
- ロジック層（InputLogic/SettingsLogic）は「値の検証・変換・保存」などの純粋ロジックのみ担当
- UI層が「入力確定/保存」イベントを受けて、画面遷移やUI反映を制御

### 2-2. イベント通知方式の設計
- ロジック層のAPIは「確定/保存の成否」や「必要な情報」を戻り値やイベントでUI層に通知
- UI層はその通知を受けて画面遷移・UI反映を行う

---

## 3. 実装・リファクタ手順

### 3-1. テストケースの作成・更新（TDD推奨）
- test/pure/配下で新API・新責務分離方針に沿ったテストケースを作成・更新
  - test/pure/test_input_logic_pure/test_main.cpp
    - InputLogicのAPIがUI遷移や画面制御を行わないことを検証するテストを追加・修正
  - test/pure/test_settings_logic_pure/test_main.cpp
    - SettingsLogicのAPIがUI遷移や画面制御を行わないことを検証するテストを追加・修正
  - 必要に応じてモックやテストダブルを拡充
    - UI描画呼び出しやモード変更の有無を検証できるようにする
  - テスト実行
    - pio test -e nativeで全テストがパスすることを確認

### 3-2. ロジック層のリファクタ
1. InputLogic/SettingsLogicのAPIからUI遷移・画面制御に関する処理を排除
  - 必要な場合、戻り値やコールバックで「確定/保存イベント」をUI層に通知
2. InputLogic/SettingsLogicの実装（lib/libaimatix/src/）を確認
-   UI遷移や画面制御に関する処理が残っていないか再点検
-    万一残っていれば、責務分離方針に従い削除・リファクタ
3. API設計の見直し
-    UI層に通知すべき情報は「戻り値」や「構造体」「イベント」で返す設計に統一
    - 例：エラー時はエラーメッセージやステータスを返す
4. 副作用の抽象化
    - EEPROM書き込み等は必ずインターフェース（IEEPROM等）経由で行う
    - UI描画やモード変更などの副作用は一切持たない
5. テストの再実行
  - pio test -e native で全テストがパスすることを確認

### 3-3. UI層のリファクタ
- 設定保存・入力確定などのイベントをUI層で受けて、画面遷移・UI反映を制御
  - 例：設定保存後に`currentMode = MAIN_DISPLAY`など
- 必要に応じて、イベントハンドラや状態遷移処理を整理

### 3-4. コマンド/イベント駆動方式への拡張（任意・推奨）
- 状態遷移の結果として「UI更新」「設定保存」などのコマンド/イベントリストを返す設計に拡張
- Effect/Command Dispatcherで副作用を一元管理

---

## 4. 動作確認・テスト

### 4-1. ビルド・テスト
- 全ビルドが通ることを確認
- test/pure/配下のテストがすべてパスすることを確認

### 4-2. 実機・統合テスト
- UI遷移・設定保存・入力確定などの一連動作が正しく分離・反映されているか実機で確認

---

## 5. ドキュメント・設計書の更新

- 設計思想・責務分離方針・API仕様を設計書（architecture.md, interface_design.md等）に反映
- 実装例・クラス図・イベントシーケンス図なども必要に応じて追加

---

## 6. フォローアップ・レビュー

- コードレビュー・設計レビューを実施
- 必要に応じて追加改善・リファクタを行う

---

# 参考AA（流れのイメージ）

```
[UI層] ──(値編集/保存指示)──▶ [ロジック層]
  ▲                                 │
  │                                 │
  └───(確定/保存完了通知)───────┘
      │
      ▼
  [画面遷移・UI反映]
```

---

ご要望に応じて、  
- 具体的なAPI設計例  
- クラス図やシーケンス図  
- テストケース例  
なども追加可能です。必要な場合はご指示ください！