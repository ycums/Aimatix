# 【質問票】3-0-10: 相対値入力ができる 実装前確認

本質問票は「3-0-10: 相対値入力ができる」の実装に先立ち、仕様・要件・テスト基準の明確化と合意を目的としています。

---

## 1. 仕様・要件の確認

### 1-1. 相対値入力画面への遷移
- [ ] メイン画面のB短押しで相対値入力画面（REL_PLUS_TIME_INPUT）に遷移するのは正しいですか？
    - [x] はい
    - [ ] いいえ（【自由記述】）
- [ ] 相対値入力画面のタイトル表示は？
    - [x] "REL+"（相対値追加の意）
    - [ ] "RELATIVE"
    - [ ] その他（【自由記述】）

### 1-2. 相対値計算の仕様
- [ ] 相対値計算は「現在時刻 + 入力値」で正しいですか？
    - [x] はい
    - [ ] いいえ（【自由記述】）
- [ ] 入力値の解釈方法は？
    - 例: 現在時刻 14:35分
      - `__:_1` の 状態で 確定 → `14:36`
      - `__:1_` の 状態で 確定 → `14:45`
      - `__:12` の 状態で 確定 → `14:47`
      - `__:99` の 状態で 確定 → `16:39` (14:134 → 16:14)
      - `_9:9_` の 状態で 確定 → `23:125` → `+1d 00:05`

### 1-3. プレビュー表示の仕様
- [ ] プレビュー表示は「現在時刻 + 入力値」の結果を表示するのは正しいですか？
    - [x] はい
    - [ ] いいえ（【自由記述】）
- [ ] プレビュー表示の更新タイミングは？
    - [x] 入力値変更時即座に更新
    - [ ] 確定時のみ更新
    - [ ] その他（【自由記述】）
- [ ] プレビュー表示の具体例は正しいですか？
    - [x] 現在14:30、入力`__:30` → プレビュー"15:00"
    - [x] 現在14:30、入力`_2:45` → プレビュー"17:15"
    - [x] 現在23:45、入力`_0:30` → プレビュー"+1d 00:15"
    - [ ] その他（【自由記述】）

### 1-4. アラーム設定の仕様
- [ ] C短押しで相対値計算結果をアラームとして追加するのは正しいですか？
    - [x] はい
    - [ ] いいえ（【自由記述】）
- [ ] 相対値計算結果が過去時刻になった場合の処理は？
    - [x] エラー表示（相対値なので過去になることはない）
    - [ ] 翌日として設定
    - [ ] その他（【自由記述】）
- [ ] 相対値入力でのアラーム追加制約は絶対時刻入力と同じですか？
    - [x] はい（重複・上限・未入力チェック）
    - [ ] いいえ（【自由記述】）

### 1-5. 入力値の不正値処理
- [ ] 相対値入力でも不正値（99:99等）は補正されますか？
    - [x] はい（絶対時刻入力と同じ補正ルール）
    - [ ] いいえ（エラー表示）
    - [ ] その他（【自由記述】）
- [ ] 補正後の相対値計算は？
    - [x] 補正された値で相対値計算を実行
    - [ ] 補正前の値で計算
    - [ ] その他（【自由記述】）

---

## 2. UI・表示仕様

### 2-1. 画面表示の違い
- [ ] 相対値入力画面と絶対時刻入力画面の表示違いは？
    - [x] タイトルバーのみ（"INPUT" → "REL+"）
    - [ ] プレビュー表示の文言も変更
    - [ ] その他（【自由記述】）
- [ ] ボタンヒント表示は？
    - [x] 絶対時刻入力と同じ（A: "INC" B: "NEXT" C: "SET"）
    - [ ] 相対値用に変更
    - [ ] その他（【自由記述】）

### 2-2. プレビュー表示の詳細
- [ ] プレビュー表示の位置・フォントは？
    - [x] 絶対時刻入力と同じ（グリッドセル(2,6)-(13,6)、Font2）
      - [ ] 設計時に InputDisplayViewImpl.h 等の共通化を視野に入れてください。
    - [ ] 相対値用に変更
    - [ ] その他（【自由記述】）
- [ ] 日付跨ぎ時のプレビュー表示は？
    - [x] "+1d HH:MM"形式
    - [ ] "HH:MM"のみ
    - [ ] その他（【自由記述】）

### 2-3. エラー表示
- [ ] 相対値入力でのエラー表示は？
    - [x] 絶対時刻入力と同じ（英語メッセージ、効果音/バイブ）
    - [ ] 相対値特有のエラーメッセージ
    - [ ] その他（【自由記述】）

---

## 3. 実装・設計仕様

### 3-1. 既存コンポーネントの活用
- [ ] 相対値入力画面は既存のInputDisplayStateを拡張しますか？
    - [x] はい（モード切り替えで対応）
    - [ ] いいえ（新規作成）
    - [ ] その他（【自由記述】）
- [ ] InputLogicの拡張は必要ですか？
    - [x] いいえ（既存のgetValue()等をそのまま使用）
    - [ ] はい（相対値計算用メソッド追加）
    - [ ] その他（【自由記述】）

### 3-2. 相対値計算の実装場所
- [ ] 相対値計算はどこで実装しますか？
    - [x] InputDisplayState内（現在時刻取得 + 入力値計算）
    - [ ] TimeLogicに新規メソッド追加
    - [ ] その他（【自由記述】）
- [ ] 現在時刻の取得方法は？
    - [x] time(nullptr)で直接取得
    - [ ] TimeLogic経由で取得
    - [ ] その他（【自由記述】）

### 3-3. 状態管理
- [ ] 相対値入力モードの状態管理は？
    - [x] StateManagerでREL_PLUS_TIME_INPUT状態として管理
    - [ ] InputDisplayState内でフラグ管理
    - [ ] その他（【自由記述】）

---

## 4. テスト・完成条件

### 4-1. 完成判定
- [ ] 以下の条件を満たせば「完成」としてよいですか？
    - [x] メイン画面B短押しで相対値入力画面に遷移できる
    - [x] 相対値計算が正しく動作する（現在時刻 + 入力値）
    - [x] プレビュー表示が正しく更新される
    - [x] C短押しでアラームが設定できる
    - [x] 日付跨ぎ処理が正しく動作する
    - [x] 不正値の補正が正しく動作する
    - [x] エラー処理が正しく動作する
    - [x] カバレッジが品質ゲートを上回っている
    - [x] 静的解析実行（Clang-Tidy）
    - [ ] その他（【自由記述】）

### 4-2. テスト観点
- [ ] テストで特に重視すべき観点・パターンがあればご記入ください
    - 【自由記述】
      - 日付跨ぎの境界値テスト（23:59 + 1分、23:59 + 1時間等）
      - 部分入力状態での相対値計算
      - 不正値補正後の相対値計算
      - 現在時刻の変化に対するプレビュー更新
      - エラーケース（重複・上限・未入力）

---

## 5. その他・ご要望
- [ ] その他、実装・UI・テストに関するご要望・注意点があればご記入ください
    - MUST: 設計は `doc/design/` に準拠させること
    - MUST: 仕様は `doc/spec/` に準拠させること
    - SHOULD: 進行に関しては `guide/developer_guide.md` を参照のこと
    - SHOULD: 可能な限りTDDで進めること
    - 【自由記述】
    - 相対値計算は純粋ロジックとして実装し、UI依存を避けること
    - 既存のInputLogicの設計を活用し、重複実装を避けること
    - プレビュー表示の更新頻度に注意（パフォーマンス考慮）

---

## 【仕様転記】
過去の質問票（3-0-8, 3-0-9）から転記：

### エラーメッセージの言語
- エラー時に表示するメッセージは英語にすること。
  - 実機に日本語フォントが導入されていないため。

### 設計原則
- 純粋ロジック（InputLogic）はUI遷移や画面制御を一切持たず、値の検証・変換のみを担当する。
- UI層は「相対値計算」イベントを受けて、ロジック層APIを呼び出し、戻り値やイベント通知をもとにUI反映を行う。
- 必要に応じて、APIの戻り値として「成否」「エラー内容」等を構造体やenumで返す。

### テスト方針
- 可能な限りTDDで進めること
- テストは `pio test -e native` で実行すること
- カバレッジは品質ゲートを上回ること

### 部分的な入力状態の解釈ルール
入力画面での部分的な入力状態は以下のルールで解釈する：

#### 基本ルール
- 時、分それぞれで独立して解釈する
- 右側の桁が入力済みで左側が未入力の場合、左側を0として補完
- 左側の桁が入力済みで右側が未入力の場合、右側を0として補完

#### 具体例
- `__:01` → 分のみ入力（01分）
- `_0:1_` → 時十桁と分十桁のみ入力（`_0` → `00`、`1_` → `10`）→ `00:10`
- `1_:__` → 時十桁のみ入力（`1_` → `10`）→ `10:00`
- `_1:__` → 時一桁のみ入力（`_1` → `01`）→ `01:00`
- `99:99` → 全桁入力（99:99）

#### 補正ロジック
1. 部分的な入力状態を上記ルールで完全な時分に変換
2. 不正値はspec.mdに従って補正（99:99 → +4d 05:39等）
3. 相対値計算：現在時刻 + 補正後の入力値 