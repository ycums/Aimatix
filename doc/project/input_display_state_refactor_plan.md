# InputDisplayState リファクタ工程手順書

## 概要
プレビューのバグ修正計画の続行として、InputDisplayState.hのリファクタ工程を実行します。
品質保証工程も含めた段階的な改善を行います。

## 目標
- デバッグコードの削除
- 重複ロジックの統合
- コードの可読性向上
- 品質ゲート基準（中重要度警告85件以下）の達成
- テストカバレッジ85%以上の維持

## 前提条件
- 現在のコードが正常にビルド・テストできる状態
- 既存の機能が正常に動作している状態

## リファクタ工程の詳細手順

### Phase 1: 準備段階

#### 1.1 現在の品質状態確認
```bash
# 静的解析実行
pio check -e native

# テスト実行
pio test -e native

# カバレッジ測定
python scripts/test_coverage.py
```

#### 1.2 バックアップ作成
```bash
# 現在の状態をバックアップ
git add .
git commit -m "Before InputDisplayState refactor"
```

### Phase 2: デバッグコードの削除

#### 2.1 printf文の削除
**対象ファイル**: `lib/libaimatix/src/InputDisplayState.h`

**削除対象**:
- 96行目: `printf("[DEBUG] now_tm: %04d-%02d-%02d %02d:%02d\n", ...)`
- その他のデバッグ用printf文（約20箇所）

**削除手順**:
1. ファイル内のすべての`printf("[DEBUG]`で始まる行を検索
2. 各printf文を削除
3. 必要に応じて適切なコメントに置き換え

#### 2.2 品質確認
```bash
# 静的解析
pio check -e native

# テスト実行
pio test -e native
```

### Phase 3: 時刻計算ロジックの共通化

#### 実施内容
- `generateAbsolutePreview`/`generateRelativePreview`の重複ロジックを`TimePreviewLogic`クラスに集約
- InputDisplayStateから時刻計算・日付跨ぎ判定・プレビュー生成ロジックを排除し、共通関数呼び出しに変更
- 静的バッファ問題（localtimeの多重呼び出しによるバグ）を回避するため、tm構造体の値コピーを徹底
- テストケース（特に日付跨ぎのプレビュー）も全てパス

#### 注意点
- localtime等の標準C関数は静的バッファを返すため、複数回呼び出す場合は必ず値をコピーして使うこと
- 共通化したロジックは他の画面やロジックでも再利用可能
- テスト失敗時はlocaltimeの使い方・tm構造体の扱いを重点的に見直すこと

#### 品質保証
- `pio test -e native`で全テストパス（バグ再発防止テストも含む）
- コードの可読性・保守性が向上

---

### Phase 4: 関数の分割・整理

#### 4.1 現状の問題点
- `onDraw()`関数: 約80行の長大な関数（UI更新・プレビュー生成・エラー表示・状態管理が混在）
- `onButtonC()`関数: 約50行の複雑な分岐（相対値/絶対値モード分岐・アラーム追加・エラーハンドリングが混在）
- エラーハンドリングが各所に散在

#### 4.2 分割・整理の方針
**原則**: 1関数1責務、認知複雑度削減、テスト容易性向上

**分割対象**:
1. `onDraw()`関数 → `updateDigitDisplay()`, `updatePreviewDisplay()`, `updateErrorDisplay()`, `updateColonDisplay()`
2. `onButtonC()`関数 → `handleRelativeModeSubmit()`, `handleAbsoluteModeSubmit()`
3. エラーハンドリング → 共通エラー処理関数の作成

#### 4.3 実施手順

##### 4.3.1 準備段階
```bash
# 現在の品質状態を確認
pio check -e native
pio test -e native
```

##### 4.3.2 第1段階: onDraw()関数の分割
**対象**: `onDraw()`関数（約80行）
**分割内容**:
- `updateDigitDisplay()`: 数字表示の更新
- `updatePreviewDisplay()`: プレビュー表示の更新
- `updateErrorDisplay()`: エラー表示の更新
- `updateColonDisplay()`: コロン表示の更新
- `hasInputChanged()`: 入力値変化の判定
- `generatePreviewText()`: プレビューテキスト生成

**確認**: 分割後にテスト実行 ✅ **完了**

##### 4.3.3 第2段階: onButtonC()関数の分割
**対象**: `onButtonC()`関数（約50行）
**分割内容**:
- `handleRelativeModeSubmit()`: 相対値モードの確定処理
- `handleAbsoluteModeSubmit()`: 絶対値モードの確定処理
- `addAlarmAtTime()`: アラーム追加処理
- `showError()`: エラー表示処理
- `transitionToMainDisplay()`: メイン画面への遷移

**確認**: 分割後にテスト実行 ✅ **完了**

##### 4.3.4 第3段階: エラーハンドリングの統一
**対象**: 各所に散在するエラー処理
**統一内容**:
- `validateInputLogic()`: InputLogicの妥当性チェック
- `validateTimeProvider()`: TimeProviderの妥当性チェック
- `handleError()`: 共通エラー処理

**確認**: 統一後にテスト実行 ✅ **完了**

#### 4.4 品質確認
```bash
# 各段階でテスト確認
pio test -e native

# 静的解析確認
pio check -e native
```

#### 4.5 期待される効果
- **可読性向上**: 関数名から処理内容が明確
- **保守性向上**: バグ修正時の影響範囲が限定
- **テスト容易性向上**: 各関数を個別にテスト可能
- **認知複雑度削減**: ネストしたif文の削減

#### 4.6 注意点
- **段階的実施**: 一度に大きな変更を避け、小さな単位で分割・テスト
- **テスト優先**: 各分割後に必ずテストを実行
- **命名規則**: 関数名は処理内容を明確に表現
- **責務分離**: UI更新・ビジネスロジック・エラーハンドリングを明確に分離

#### 4.7 完了状況
✅ **Phase 4: 関数の分割・整理 - 完了**

**実施内容**:
- `onDraw()`関数を8つの関数に分割
- `onButtonC()`関数を5つの関数に分割
- エラーハンドリングを統一
- すべてのテストが通過（114テストケース）

**成果**:
- 認知複雑度の削減
- 単一責任の原則に基づく整理
- 可読性・保守性の向上
- テスト容易性の向上

---

### Phase 5: 依存性注入の改善

#### 5.1 ITimeProviderの使用改善
**改善内容**:
- 直接的な`timeProvider_`使用を最小化
- 適切なインターフェース設計
- テスト容易性の向上

#### 5.2 品質確認
```bash
# ビルド確認
pio run -e native

# 静的解析
pio check -e native

# テスト実行
pio test -e native
```

### Phase 6: エラーハンドリングの統一

#### 6.1 エラーハンドリングの統合
**改善内容**:
- 散在するエラーハンドリングを統一的に管理
- エラーメッセージの標準化
- エラー状態の適切な管理

#### 6.2 品質確認
```bash
# 静的解析
pio check -e native

# テスト実行
pio test -e native
```

### Phase 7: 品質保証工程

#### 7.1 静的解析
```bash
# 詳細な静的解析実行
pio check -e native --verbose

# 結果確認
# 目標: 中重要度警告85件以下
```

#### 7.2 テスト実行
```bash
# 全テスト実行
pio test -e native

# カバレッジ測定
python scripts/test_coverage.py

# 結果確認
# 目標: テストカバレッジ85%以上
```

#### 7.3 品質ゲート確認
**確認項目**:
- [ ] 中重要度警告85件以下
- [ ] テストカバレッジ85%以上
- [ ] すべてのテストが通過
- [ ] ビルドが正常に完了

### Phase 8: 最終確認

#### 8.1 機能確認
```bash
# ビルド確認
pio run -e native
pio run -e m5stack-fire

# テスト確認
pio test -e native
```

#### 8.2 ドキュメント更新
**更新対象**:
- この手順書の完了報告
- 必要に応じて関連ドキュメントの更新

## 品質ゲート基準

### 静的解析基準
- **High**: 高重要度の警告は0件以下
- **Medium**: 中重要度の警告は85件以下（ゲート基準）
- **Low**: 低重要度の警告は50件以下

### テスト基準
- **カバレッジ**: 85%以上
- **通過率**: 100%
- **実行時間**: 30秒以内

### ビルド基準
- **Native環境**: 正常ビルド
- **M5Stack環境**: 正常ビルド
- **警告**: 最小限

## リスク管理

### 高リスク項目
1. **時刻計算ロジックの変更**
   - 影響: プレビュー機能全体
   - 対策: 段階的な変更とテスト

2. **関数の大幅な分割**
   - 影響: 既存テストの修正が必要
   - 対策: テストファーストアプローチ

### 中リスク項目
1. **デバッグコードの削除**
   - 影響: デバッグ情報の損失
   - 対策: 必要に応じてログシステム導入

2. **依存性注入の変更**
   - 影響: テストコードの修正
   - 対策: 既存テストの維持

## 進捗管理

### チェックポイント
- [ ] Phase 1: 準備段階完了
- [ ] Phase 2: デバッグコード削除完了
- [ ] Phase 3: 時刻計算ロジック共通化完了
- [ ] Phase 4: 関数分割・整理完了
- [ ] Phase 5: 依存性注入改善完了
- [ ] Phase 6: エラーハンドリング統一完了
- [ ] Phase 7: 品質保証工程完了
- [ ] Phase 8: 最終確認完了

### 品質ゲート通過確認
- [ ] 静的解析基準達成
- [ ] テスト基準達成
- [ ] ビルド基準達成

## 完了条件

### 必須条件
1. すべてのテストが通過
2. 中重要度警告85件以下
3. テストカバレッジ85%以上
4. 正常にビルド可能

### 推奨条件
1. コードの可読性向上
2. 関数サイズの適正化
3. 認知複雑度の削減
4. 保守性の向上

## 参考資料

- `doc/guide/developer_guide.md`: 開発者ガイド
- `doc/design/architecture.md`: アーキテクチャ設計
- `doc/operation/testing_strategy.md`: テスト戦略
- `doc/operation/quality_gates.md`: 品質ゲート基準

---

**作成日**: 2025年1月  
**バージョン**: 1.0.0  
**対象ファイル**: `lib/libaimatix/src/InputDisplayState.h`  
**品質ゲート基準**: 中重要度警告85件以下、テストカバレッジ85%以上 