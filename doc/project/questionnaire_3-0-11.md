# 【質問票】3-0-11: アラーム管理画面（AlarmDisplay）雛形追加・遷移 実装前確認

本質問票は「3-0-11: アラーム管理画面（AlarmDisplay）雛形追加・遷移（AlarmLogic連携、リスト表示・選択）」の実装に先立ち、仕様・要件・テスト基準の明確化と合意を目的としています。

---

## 1. 仕様・要件の確認

### 1-1. アラーム管理画面への遷移
- [ ] メイン画面のC短押しでアラーム管理画面（ALARM_MANAGEMENT）に遷移するのは正しいですか？
    - [x] はい
    - [ ] いいえ（【自由記述】）
- [ ] アラーム管理画面のタイトル表示は？
    - [x] "ALARMS"（アラーム一覧の意）
    - [ ] "ALARM LIST"
    - [ ] その他（【自由記述】）

### 1-2. アラームリスト表示の仕様
- [ ] アラームリストの表示形式は？
    - [x] 時刻順（早い順）で表示
    - [ ] 追加順で表示
    - [ ] その他（【自由記述】）
- [ ] アラームが存在しない場合の表示は？
    - [x] "NO ALARMS"（中央表示）
    - [ ] 空の画面
    - [ ] その他（【自由記述】）
- [ ] アラームリストの最大表示件数は？
    - [x] 画面に収まる限り（5件程度）
    - [ ] 固定件数（例：3件）
    - [ ] その他（【自由記述】）

### 1-3. 選択・ナビゲーション機能
- [ ] 選択中のアラームの表示方法は？
    - [x] 背景色を反転（アンバー⇔黒）
    - [ ] 矢印記号で表示
    - [ ] その他（【自由記述】）
- [ ] 初期選択位置は？
    - [x] リストの先頭（インデックス0）
    - [ ] 最後に追加されたアラーム
    - [ ] その他（【自由記述】）
- [ ] リストの端でのナビゲーションは？
    - [ ] 循環（最後→最初、最初→最後）
    - [x] 端で停止
    - [ ] その他（【自由記述】）

### 1-4. ボタン操作の仕様
- [ ] A短押しの動作は？
    - [x] 選択位置を上に移動
    - [ ] アラーム削除
    - [ ] その他（【自由記述】）
- [ ] A長押しの動作は？
    - [x] 選択位置を一番上に移動
    - [ ] 全アラーム削除
    - [ ] その他（【自由記述】）
- [ ] B短押しの動作は？
    - [x] 選択位置を下に移動
    - [ ] アラーム編集
    - [ ] その他（【自由記述】）
- [ ] B長押しの動作は？
    - [x] 選択位置を一番下に移動
    - [ ] アラーム複製
    - [ ] その他（【自由記述】）
- [ ] C短押しの動作は？
    - [x] 選択中のアラームを削除
    - [ ] アラーム編集
    - [ ] その他（【自由記述】）
- [ ] C長押しの動作は？
    - [x] メイン画面に戻る
    - [ ] アラーム追加
    - [ ] その他（【自由記述】）

### 1-5. アラーム削除機能
- [ ] アラーム削除時の確認は？
    - [x] 確認なし（即座に削除）
    - [ ] 確認ダイアログ表示
    - [ ] その他（【自由記述】）
- [ ] 削除後の選択位置は？
    - [x] 削除されたアラームがあった位置（最後の場合は前の位置）
    - [ ] 常に先頭
    - [ ] その他（【自由記述】）
- [ ] 最後のアラームを削除した場合の処理は？
    - [x] "NO ALARMS"表示、選択位置なし
    - [ ] メイン画面に自動遷移
    - [ ] その他（【自由記述】）

---

## 2. UI・表示仕様

### 2-1. 画面レイアウト
- [ ] タイトルバーの表示位置・内容は？
    - [x] 上部、モード名とバッテリー残量
    - [ ] 中央上部、モード名のみ
    - [ ] その他（【自由記述】）
- [ ] アラームリストの表示位置は？
    - [x] タイトルバー下の中央部分
    - [ ] 画面全体
    - [ ] その他（【自由記述】）
- [ ] ボタンヒントの表示位置・内容は？
    - [x] 下部、A: "UP" B: "DOWN" C: "DEL"
    - [ ] 中央下部、A: "PREV" B: "NEXT" C: "DELETE"
    - [ ] その他（【自由記述】）

### 2-2. アラーム表示形式
- [ ] アラーム時刻の表示形式は？
    - [x] "HH:MM"形式（例：14:30）
    - [ ] "HH:MM:SS"形式
    - [ ] その他（【自由記述】）
- [ ] 複数アラームの表示方法は？
    - [x] 縦に並べて表示（1行1アラーム）
    - [ ] 横に並べて表示
    - [ ] その他（【自由記述】）
- [ ] フォント・色は？
    - [x] Font4、アンバー色（#FB20）
    - [ ] Font7、アンバー色
    - [ ] その他（【自由記述】）

### 2-3. 選択表示の詳細
- [ ] 選択中のアラームの背景色は？
    - [x] アンバー背景、黒文字（反転）
    - [ ] オレンジ背景、黒文字
    - [ ] その他（【自由記述】）
- [ ] 選択表示の範囲は？
    - [x] アラーム時刻部分のみ
    - [ ] 行全体
    - [ ] その他（【自由記述】）

---

## 3. 実装・設計仕様

### 3-1. 既存コンポーネントの活用
- [ ] アラーム管理画面は新規のAlarmDisplayStateを作成しますか？
    - [x] はい（新規作成）
    - [ ] いいえ（既存のStateを拡張）
    - [ ] その他（【自由記述】）
- [ ] AlarmLogicとの連携方法は？
    - [x] AlarmLogicのgetAlarms()でリスト取得、deleteAlarm()で削除
    - [ ] AlarmLogicに新規メソッド追加
    - [ ] その他（【自由記述】）

### 3-2. 状態管理
- [ ] 選択位置の管理は？
    - [x] AlarmDisplayState内でselectedIndexとして管理
    - [ ] StateManagerで管理
    - [ ] その他（【自由記述】）
- [ ] アラームリストの更新タイミングは？
    - [x] 画面表示時毎回AlarmLogicから取得
    - [ ] 状態変更時のみ更新
    - [ ] その他（【自由記述】）

### 3-3. 削除処理の実装
- [ ] アラーム削除の実装場所は？
    - [x] AlarmDisplayState内でAlarmLogic.deleteAlarm()を呼び出し
    - [ ] AlarmLogicに新規メソッド追加
    - [ ] その他（【自由記述】）
- [ ] 削除後の画面更新は？
    - [x] 即座に再描画
    - [ ] 次のフレームで更新
    - [ ] その他（【自由記述】）

---

## 4. テスト・完成条件

### 4-1. 完成判定
- [ ] 以下の条件を満たせば「完成」としてよいですか？
    - [x] メイン画面C短押しでアラーム管理画面に遷移できる
    - [x] アラームリストが正しく表示される（時刻順）
    - [x] アラームが存在しない場合は"NO ALARMS"が表示される
    - [x] A/Bボタンで選択位置を上下移動できる
    - [x] A/B長押しで選択位置を一番上/下に移動できる
    - [x] C短押しで選択中のアラームを削除できる
    - [x] C長押しでメイン画面に戻れる
    - [x] 削除後の選択位置が適切に調整される
    - [x] 最後のアラーム削除後は"NO ALARMS"が表示される
    - [x] カバレッジが品質ゲートを上回っている
    - [x] 静的解析実行（Clang-Tidy）
    - [ ] その他（【自由記述】）

### 4-2. テスト観点
- [ ] テストで特に重視すべき観点・パターンがあればご記入ください
    - 【自由記述】
      - アラーム0件時の表示・操作
      - アラーム1件時の削除・選択
      - アラーム複数件時のナビゲーション
      - リスト端での循環ナビゲーション
      - 削除後の選択位置調整
      - アラーム追加後のリスト更新
      - 境界値テスト（最大5件、0件等）

---

## 5. その他・ご要望
- [ ] その他、実装・UI・テストに関するご要望・注意点があればご記入ください
    - MUST: 設計は `doc/design/` に準拠させること
    - MUST: 仕様は `doc/spec/` に準拠させること
    - SHOULD: 進行に関しては `guide/developer_guide.md` を参照のこと
    - SHOULD: 可能な限りTDDで進めること
    - 【自由記述】
    - アラーム管理は純粋ロジックとして実装し、UI依存を避けること
    - 既存のAlarmLogicの設計を活用し、重複実装を避けること
    - 選択位置の管理は適切な境界チェックを行うこと
    - 削除処理は副作用として適切に管理すること

---

## 【仕様転記】
過去の質問票（3-0-8, 3-0-9, 3-0-10）から転記：

### エラーメッセージの言語
- エラー時に表示するメッセージは英語にすること。
  - 実機に日本語フォントが導入されていないため。

### 設計原則
- 純粋ロジック（AlarmLogic）はUI遷移や画面制御を一切持たず、アラーム管理のみを担当する。
- UI層は「アラーム削除」イベントを受けて、ロジック層APIを呼び出し、戻り値やイベント通知をもとにUI反映を行う。
- 必要に応じて、APIの戻り値として「成否」「エラー内容」等を構造体やenumで返す。

### テスト方針
- 可能な限りTDDで進めること
- テストは `pio test -e native` で実行すること
- カバレッジは品質ゲートを上回ること

### アラーム管理の仕様
- 最大アラーム数：5件
- 重複チェック：同一時刻の追加を拒否
- 過去時刻削除：現在時刻以前のアラームを自動削除
- 自動ソート：時刻順での自動ソート
- 削除処理：C短押しで選択中のアラームを削除

### 状態遷移テーブル（ALARM_MANAGEMENT）
| 現在モード         | ボタンイベント | アクション   | 次モード           |
|--------------------|----------------|-------------|--------------------|
| ALARM_MANAGEMENT   | A短押し        | 上へ        | (遷移なし)         |
| ALARM_MANAGEMENT   | A長押し        | 一番上へ    | (遷移なし)         |
| ALARM_MANAGEMENT   | B短押し        | 下へ        | (遷移なし)         |
| ALARM_MANAGEMENT   | B長押し        | 一番下へ    | (遷移なし)         |
| ALARM_MANAGEMENT   | C短押し        | 項目削除    | (遷移なし)         |
| ALARM_MANAGEMENT   | C長押し        | NOP         | MAIN_DISPLAY       |

### UI表示仕様
- タイトルバー：上部にモード名とバッテリー残量
- アラームリスト：中央部分に時刻順で表示
- 選択表示：背景色反転（アンバー⇔黒）
- ボタンヒント：下部にA: "UP" B: "DOWN" C: "DEL"
- フォント：Font4、アンバー色（#FB20）
- 空リスト表示："NO ALARMS"（中央表示）

### ナビゲーション仕様
- 初期選択：リスト先頭（インデックス0）
- 移動方向：A=上、B=下
- 長押し：A=一番上、B=一番下
- 循環：最後→最初、最初→最後
- 削除後：次の位置（最後の場合は前の位置） 