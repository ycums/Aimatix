# 3-0-13: 日時手動設定機能実装計画書

## 概要
EEPROM機能完成前に、最低限の日時設定機能を提供するため、揮発性の手動日時設定画面を実装する。

## 背景・課題
- 現在の実装では、システム時刻が設定されていないため、タイマーとして使用できない
- 3-0-14（EEPROM機能）完了前に、一時的な手動設定機能が必要
- WiFi設定機能が未実装のため、NTP同期ができない

## 実装方針
- **揮発性設定**: 電源OFFでリセット（EEPROM非依存）(最終的には永続化させるが、この時点では書き込み機能がないので省略)
- **手動入力**: 日付・時刻を手動で設定
- **バリデーション**: 有効な日付・時刻範囲のチェック
- **即時反映**: 確定時にシステム時刻を更新

## 実装内容

### 1. 新しい状態クラス
```cpp
// lib/libaimatix/src/DateTimeInputState.h
class DateTimeInputState : public IState {
    // 日付入力: YYYY/MM/DD
    // 時刻入力: HH:MM
    // バリデーション: 有効な日付・時刻範囲
    // 確定: システム時刻更新
};
```

### 2. 設定画面の拡張
```cpp
// 設定メニュー項目の追加
enum SettingsMenuItem {
    SOUND,
    LCD_BRIGHTNESS,
    SET_DATE_TIME,  // 新規追加
    WARNING_COLOR_TEST,
    ALL_CLEAR,
    INFO
};
```

### 3. 日時入力画面の仕様
- **入力形式**: YYYY/MM/DD HH:MM
- **入力方法**: 桁ごと編集（時刻入力と同様）
- **カーソル位置**: 0=年千, 1=年百, 2=年十, 3=年一, 4=月十, 5=月一, 6=日十, 7=日一, 8=時十, 9=時一, 10=分十, 11=分一
- **バリデーション**:
  - 年: 2020-2030
  - 月: 01-12
  - 日: 01-31（月に応じて調整）
  - 時: 00-23
  - 分: 00-59
- ファクトリ初期値: 2025/01/01 00:00

### 4. UI/UX仕様
- **タイトル**: "SET DATE/TIME"
- **表示形式**: "2025/01/15 14:30"
- **カーソル表示**: ネガポジ反転
- **ボタン操作**:
  - A: +1（短押し）
  - B: カーソルを右へ（短押し）
  - C: 確定（短押し）/ 戻る（長押し）
- **ボタンヒント**: A: "INC" B: "NEXT" C: "SET"

### 5. 実装順序
1. `DateTimeInputState`クラスの作成
2. `DateTimeInputView`インターフェースの作成
3. 設定画面からの遷移追加
4. 日付・時刻入力ロジックの実装
5. バリデーション機能の実装
6. システム時刻更新機能の実装
7. テスト作成・実行

## 技術的考慮事項

### 1. 依存関係
- **EEPROM非依存**: 揮発性設定のみ
- **既存機能との統合**: 設定画面からの遷移
- **時刻管理**: `ITimeProvider`インターフェースの活用

### 2. テスト戦略
- **Unit Test**: 日時入力ロジックのテスト
- **バリデーションテスト**: 境界値テスト
- **統合テスト**: 設定画面からの遷移テスト

### 3. 品質基準
- **カバレッジ**: 85%以上
- **静的解析**: Clang-Tidy合格
- **実機テスト**: 日時設定・反映の確認

## 後続フェーズとの関係

### 3-0-14（EEPROM機能）完了後
- 手動設定値をEEPROMに保存する機能を追加
- 起動時の設定値復元機能を追加

### 3-0-16-5（WiFi設定機能）完了後
- NTP同期機能との優先順位管理
- 手動設定 vs 自動同期の制御

## 成功指標
- [ ] 日時手動設定画面が正常に動作する
- [ ] 有効な日付・時刻のみ受け付ける
- [ ] 確定時にシステム時刻が正しく更新される
- [ ] 設定画面から正常に遷移できる
- [ ] 電源OFFでリセットされる（揮発性）
- [ ] Unit Testカバレッジ85%以上
- [ ] 静的解析実行（Clang-Tidy）合格

---

**作成日**: 2025年1月  
**バージョン**: 1.0.0  
**更新日**: 2025年1月 