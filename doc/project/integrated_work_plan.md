# M5Stack集中タイマー 統合作業計画書

## 1. プロジェクト概要

### 1.1 目的
M5Stack Fire用集中タイマーの完全実装を、テスト駆動開発により段階的に進める。
実機テストを最小限に留め、各フェーズで十分なテストカバレッジを確保する。

### 1.2 現在の状況（2025年1月時点）
- **基盤技術**: DIパターンによる純粋ロジック分離完了
- **テスト環境**: Unityテストフレームワーク安定化完了
- **ドキュメント**: 整理・統合完了
- **カバレッジ計測**: 以前の仕組みが破壊され、再構築が必要
- **次のステップ**: Phase 1.4（基本タイマー機能の完成）の開始準備完了

## 2. 開発方針

### 2.1 テスト駆動開発（TDD）
- **各機能実装前にテスト作成**: 期待動作を明確化
- **Unit Testカバレッジ**: 各フェーズで80%以上を維持
- **統合テスト**: フェーズ完了時に全シナリオテスト
- **実機テスト**: 統合テスト通過後の最終確認のみ

### 2.2 段階的実装
- **基盤技術**: インフラ機能を先に整備
- **UI/UX機能**: 基盤完成後に詳細実装
- **統合・最適化**: 全機能完成後の調整

### 2.3 品質保証
- **ビルド成功**: 各コミットでビルド成功を保証
- **テスト自動化**: ローカルでの自動テスト実行
- **ドキュメント更新**: 実装と並行して仕様書更新

## 3. アーキテクチャ概要

### 3.1 レイヤー構成
```
┌─────────────────────────────────────┐
│              UI Layer               │
├─────────────────────────────────────┤
│           Business Logic            │
├─────────────────────────────────────┤
│         Hardware Adapters           │
├─────────────────────────────────────┤
│           M5Stack Hardware          │
└─────────────────────────────────────┘
```

### 3.2 依存性注入（DI）パターン
- **純粋ロジック**: `lib/libaimatix/src/` - M5Stack依存なし
- **ハードウェアアダプター**: `src/m5stack_adapters.h/cpp` - M5Stack抽象化
- **インターフェース**: `lib/libaimatix/include/` - 抽象化定義

### 3.3 動作モード
1. **メインディスプレイ（MAIN_DISPLAY）**: 現在時刻、残り時間、アラームリスト
2. **絶対時刻入力（ABS_TIME_INPUT）**: 時刻入力（HH:MM形式）
3. **相対時刻加算入力（REL_PLUS_TIME_INPUT）**: 現在時刻からの相対時間入力
4. **アラーム管理（ALARM_MANAGEMENT）**: アラームリストの選択・削除
5. **設定メニュー（SETTINGS_MENU）**: 各種設定の変更
6. **アラーム鳴動（ALARM_ACTIVE）**: アラーム音の再生、フラッシュ点滅
7. **警告表示（WARNING_DISPLAY）**: エラーメッセージの表示

## 4. 完了済みフェーズ

### 4.1 Phase 0: 基盤整備（完了）
#### 0.1-0.3: 現状確認・仕様確定・テスト環境改善（完了）
- [x] 既存テスト・ビルド状況の確認
- [x] 実装計画の具体的な仕様確定
- [x] Unityテスト環境の完全動作化

#### 0.4: テスト戦略確立（完了）
- [x] テスト実行の自動化
- [x] カバレッジ測定の導入（gcovベース）
- [x] テスト結果の可視化
- [x] カバレッジ測定の仕組みが破壊され、再構築が必要

#### 0.5: 高優先度バグ修正（完了）
- [x] time_logicの基盤機能バグ修正
- [x] UnityライブラリのTEST_ASSERT_GREATER_THAN問題解決
- [x] 基盤機能の安定性確保

#### 0.6: Unityライブラリ問題解決（完了）
- [x] テストフレームワークの100%安定性確保
- [x] モック環境の完全分離・競合解決
- [x] テスト結果の100%信頼性確保

#### 0.7: テスト戦略再構築（完了）
- [x] 純粋ロジックテストの完全分離
- [x] 統合テスト環境の改善
- [x] カバレッジ測定の信頼性向上
- [x] カバレッジ測定の仕組みが破壊され、再構築が必要

#### 0.8: テストケース拡充（完了）
- [x] time_logicの100%カバレッジ達成
- [x] カバレッジ測定スクリプトの動作確認
- [x] テスト環境の基盤整備完了
- [x] カバレッジ測定の仕組みが破壊され、再構築が必要

#### 0.9: 全モジュールテスト環境整備（完了）
- [x] 全モジュールのテストカバレッジ80%以上達成
- [x] 純粋ロジックテストの完全分離
- [x] 依存関係の問題解決
- [x] Phase 1開発準備の完全完了
- [x] カバレッジ測定の仕組みが破壊され、再構築が必要

### 4.2 現在の課題
#### 4.2.1 テスト環境の課題
- **Button型の統一**: 設計方針の食い違いによる混在
- **状態遷移システム**: テスト対象化が未完了
- **一部テストの失敗**: ロジック不整合・境界値バグ・テストケース不備
- **カバレッジ計測の破壊**: DIパターン導入により以前のカバレッジ計測仕組みが機能しない
- **interface_design.mdとの整合性**: IButtonManagerインターフェースは実装済みだが、型の不統一が存在

#### 4.2.2 実装の課題
- **基本タイマー機能**: 現在時刻表示、アラーム設定・削除の動作確認が必要
- **画面遷移**: 全モード間の安定した遷移確認が必要
- **バリデーション**: 基本的な入力値チェックの実装が必要

## 5. 次のステップ

### 5.1 Phase 0.9.5: Button型完全統一（完了）
**目標**: Button型の完全統一とテスト戦略の整合性確保

**背景**:
- `interface_design.md`で定義されたIButtonManagerインターフェースは実装済み
- しかし、複数のButton型定義が混在している状況
- 状態遷移システムとIButtonManager間で型の不統一が発生

**整合性分析結果**:
- ✅ **IButtonManagerインターフェース**: 設計通りに実装済み
- ✅ **MockButtonManager**: IButtonManagerを正しく継承
- ✅ **DIパターン**: 設計方針通りに実装済み
- ✅ **Button型の統一**: 複数のButton型定義を統一完了
- ✅ **型の統一**: 異なるButton型の混在を解決

**課題**:
- ✅ Button型の混在（ButtonEvent構造体、ButtonType列挙型、int buttonId）を解決
- ✅ 状態遷移システムとIButtonManager間の型不統一を解決
- ✅ テスト戦略との不整合を解決
- ✅ 状態遷移システムのテスト対象化を完了

**統一方針**:
1. ✅ **IButtonManagerインターフェースの統一**: `int buttonId`を`ButtonType`列挙型に変更
2. ✅ **ButtonEvent構造体との統合**: 型統一による整合性確保
3. ✅ **テスト環境の統一**: 全テストファイルでの型統一

**対応項目**:
- ✅ IButtonManagerインターフェースの型統一（int buttonId → ButtonType）
- ✅ MockButtonManagerの型統一対応
- ✅ 状態遷移システムのButtonType依存修正
- ✅ 全テストファイルのButton型統一
- ✅ 独自MockButtonクラスの削除
- ✅ 全テストのビルド・実行成功確認

**実装ファイル**:
- ✅ `lib/libaimatix/include/IButtonManager.h` (型統一)
- ✅ `test/pure/test_button_manager_pure/mock_button_manager.h` (型統一)
- ✅ `src/state_transition/button_event.h` (型定義の統一)
- ✅ `src/state_transition/` (ButtonType依存修正)
- ✅ `test/pure/test_debounce_manager_pure/` (Button型統一)

**完了条件**:
- ✅ Button型の100%統一（IButtonManager、ButtonEvent、ButtonType）
- ✅ interface_design.mdとの完全整合性確保
- ✅ 全テストのビルド・実行成功
- ✅ テスト戦略との完全整合
- ✅ Phase 1開発の安定基盤確立

**完了日**: 2025年1月

### 5.1.5 Phase 0.9.6: カバレッジ計測の再構築（新規追加）
**目標**: DIパターンに対応した新しいカバレッジ計測システムの構築

**背景**:
- DIパターンによる純粋ロジック分離により、以前のカバレッジ計測仕組みが破壊
- 新しいアーキテクチャに対応したカバレッジ計測が必要
- 品質保証の基盤としてカバレッジ計測の復旧が重要

**課題**:
- 純粋ロジック（lib/libaimatix/src/）のカバレッジ計測
- M5Stack依存実装（src/）のカバレッジ計測
- 統合的なカバレッジレポートの生成
- 80%カバレッジ目標の再設定

**対応項目**:
- [ ] 新しいカバレッジ計測スクリプトの作成
- [ ] 純粋ロジックテストのカバレッジ計測設定
- [ ] M5Stack依存実装のカバレッジ計測設定
- [ ] 統合カバレッジレポートの生成
- [ ] カバレッジ目標の再設定と監視

**実装ファイル**:
- `scripts/test_coverage_new.py` (新規作成)
- `platformio.ini` (カバレッジ設定の更新)
- `test/` (各テストファイルのカバレッジ設定)

**完了条件**:
- [ ] 新しいカバレッジ計測システムの動作確認
- [ ] 純粋ロジックとM5Stack依存実装の両方でカバレッジ計測成功
- [ ] 統合カバレッジレポートの生成確認
- [ ] 80%カバレッジ目標の再設定完了

### 5.2 Phase 1: 基盤技術の整備（準備完了）

#### 1.4 基本タイマー機能の完成（優先度最高）
**目標**: 現在実装済みの基本機能の動作確認とバグ修正、DIパターン対応

**具体的な実装項目**:

**1.4.1 現在時刻表示の正確性確認**
- **更新頻度**: 1秒間隔
- **表示形式**: HH:MM
- **表示位置**: グリッドセル(0,1)-(15,2)
- **フォント**: Font4（高さ26px）
- **色**: アンバー色（#FB20）
- **配置**: 水平中央寄せ

**1.4.2 アラーム設定・削除の基本動作確認**
- **最大アラーム数**: 5件
- **重複チェック**: 同一時刻の追加を拒否
- **過去時刻削除**: 現在時刻以前のアラームを自動削除
- **自動ソート**: 時刻順での自動ソート

**1.4.3 画面遷移の安定性確認**
- **全モード間遷移**: 8つのモード間の安定した遷移
- **デバウンス処理**: 200msのボタンデバウンス
- **警告メッセージ**: エラー時の適切な表示

**1.4.4 既存バグの修正**
- **⚡アイコン問題**: 警告表示の不具合修正
- **ヘッダー競合**: Windows環境での型定義競合解決済み
- **リンクエラー**: テスト環境での未解決シンボル解決済み

**1.4.5 基本的なバリデーションの実装**
- **時刻入力値**: 00:00-23:59の範囲チェック
- **アラーム数**: 最大5件の上限チェック
- **境界値**: 入力値の境界値チェック

**実装ファイル**:
- `src/ui.cpp`: `drawMainDisplay()`関数の修正、表示バグ修正、UI改善
- `src/main.cpp`: 時刻更新処理の最適化
- `src/alarm.cpp`: アラーム管理機能の完成、基本動作確認、エラーハンドリング改善
- `src/input.cpp`: バリデーション強化、既存バグ修正、エラー処理改善
- `src/time_logic.cpp`: AlarmLogicクラスの活用（DIパターン対応）
- `src/state_transition/`: 状態遷移システムの活用
- `src/button_manager.cpp`: ボタン管理の改善（DIパターン対応）
- `src/settings.cpp`: 中優先度バグ修正

**DIパターン対応事項**:
- M5Stackアダプター（`src/m5stack_adapters.h/cpp`）の活用
- 純粋ロジック（`lib/libaimatix/src/`）との連携
- インターフェース（`lib/libaimatix/include/`）の活用

**品質保証項目**:
- [ ] 高優先度テストの100%成功維持
- [ ] 中優先度テストの修正完了
- [ ] テストカバレッジ80%以上達成
- [ ] 基盤機能の安定性確認
- [ ] DIパターンの正しい活用確認

**Unit Testカバレッジ目標**: 85%

#### 1.1-1.3: 基盤技術整備（Phase 1.4完了後）
- **1.1 Wi-Fi設定のSmartConfig対応**
- **1.2 NTP同期機能の改善**
- **1.3 設定管理のPreferences移行**

### 5.3 Phase 2: UI/UX機能の詳細実装（Phase 1完了後）

#### 2.1-2.3: 高優先度UI/UX機能
- **2.1 メイン表示画面の詳細作り込み**
- **2.2 入力モードの詳細ロジック**
- **2.3 アラーム鳴動状態の詳細**

#### 2.4-2.5: 中優先度UI/UX機能
- **2.4 SETTINGSサブメニューの詳細**
- **2.5 電源管理機能の基本実装**

### 5.4 Phase 3: 統合・最適化（Phase 2完了後）
- **3.1 統合テストの実行**
- **3.2 パフォーマンス最適化**
- **3.3 最終品質保証**

## 6. 成功指標

### 6.1 機能指標
- [ ] 全仕様の100%実装
- [ ] 残り時間表示精度±1秒以内
- [ ] 進捗バー精度±1%以内
- [ ] アラーム鳴動精度±0.1秒以内
- [ ] DIパターンの正しい活用確認

### 6.2 品質指標
- [ ] Unit Testカバレッジ80%以上
- [ ] 統合テストカバレッジ95%以上
- [ ] ビルド成功率100%
- [ ] メモリ使用量最適化達成
- [ ] 純粋ロジックテストの100%成功

### 6.3 パフォーマンス指標
- [ ] メインループ100Hz維持
- [ ] RAM使用量0.5%以下
- [ ] Flash使用量10%以下
- [ ] バッテリー持続時間8時間以上

## 7. リスク管理

### 7.1 技術リスク
- **M5Stackライブラリの制限**: 代替実装の検討
- **メモリ不足**: 最適化手法の適用
- **パフォーマンス劣化**: 段階的な最適化
- **既存バグの影響**: 段階的修正による軽減

### 7.2 スケジュールリスク
- **実装遅延**: 優先度の調整
- **テスト遅延**: 並行作業の推進
- **統合問題**: 早期統合テストの実施
- **後戻り作業**: 段階的バグ修正による最小化

### 7.3 品質リスク
- **テスト信頼性低下**: 段階的修正による改善
- **カバレッジ目標未達**: 優先度別修正による達成
- **新機能と既存バグの混在**: 優先度別修正による区別明確化

## 8. 現在の開発状況

### 8.1 完了済み
- [x] Phase 0全フェーズ（基盤整備）
- [x] DIパターンによる純粋ロジック分離
- [x] テスト環境の安定化
- [x] ドキュメントの整理・統合
- [x] アーカイブファイルの削除（AIコンテキスト最適化）
- [x] Phase 0.9.5: Button型完全統一（interface_design.mdとの整合性確保）

### 8.2 進行中
- [ ] Phase 0.9.6: カバレッジ計測の再構築
- [ ] 状態遷移システムのテスト対象化
- [ ] 一部テストの失敗修正

### 8.3 新たな課題
- [ ] Phase 0.9.6: カバレッジ計測の再構築（DIパターン対応）
- [ ] 新しいアーキテクチャに対応したカバレッジ計測システムの構築

### 8.4 次のステップ
- [ ] Phase 1.4: 基本タイマー機能の完成
- [ ] 基盤技術の整備
- [ ] UI/UX機能の詳細実装

## 9. AI支援のためのコンテキスト

### 9.1 プロジェクト構造
```
Aimatix/
├── doc/                          # ドキュメント（整理済み）
│   ├── spec/                     # 仕様書
│   ├── design/                   # 設計書
│   ├── guide/                    # ガイド
│   ├── operation/                # 運用・テスト
│   └── project/                  # プロジェクト管理
├── lib/libaimatix/               # 純粋ロジック（DIパターン）
│   ├── include/                  # インターフェース
│   └── src/                      # 実装
├── src/                          # M5Stack依存実装
│   ├── state_transition/         # 状態遷移システム
│   ├── m5stack_adapters.h/cpp    # ハードウェアアダプター
│   └── ...
└── test/                         # テスト環境
    ├── pure/                     # 純粋ロジックテスト
    └── mock/                     # モック環境
```

### 9.2 重要な設計原則
- **責務の明確な分離**: 各ファイルは単一の責務を持つ
- **統一されたボタン管理システム**: 将来的な拡張性を考慮
- **階層化されたデバウンス処理**: ハードウェア・操作・画面遷移レベル
- **Amber CRTテーマ**: 黒/ダークグレー背景、アンバー文字、オレンジ警告
- **DIパターン**: interface_design.mdで定義されたインターフェース設計に準拠

### 9.3 現在の課題と優先度
1. **最高優先度**: カバレッジ計測の再構築（Phase 0.9.6）
2. **高優先度**: 基本タイマー機能の完成（Phase 1.4）
3. **中優先度**: 基盤技術の整備（Phase 1.1-1.3）
4. **低優先度**: UI/UX機能の詳細実装（Phase 2）
5. **最低優先度**: 統合・最適化（Phase 3）

### 9.4 テスト戦略
- **純粋ロジックテスト**: M5Stack依存なし、80%カバレッジ目標
- **統合テスト**: モジュール間の連携テスト
- **実機テスト**: 統合テスト通過後の最終確認のみ
- **カバレッジ計測**: DIパターン対応の新しいシステムが必要（現在破壊状態）
- **インターフェース設計**: interface_design.mdで定義されたIButtonManager等のインターフェースに準拠

---

**最終更新**: 2025年1月  
**現在のフェーズ**: Phase 0.9.6（カバレッジ計測の再構築）  
**次のフェーズ**: Phase 1.4（基本タイマー機能の完成）