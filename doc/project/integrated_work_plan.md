# Aimatix 統合作業計画書（AIフレンドリー版）

## 1. プロジェクト目標・全体像
- 目的: M5Stack Fire用集中タイマーアプリ開発。テスト容易性・品質保証重視。
- アーキテクチャ: DIパターン、純粋ロジックとハード依存の分離。
- テスト戦略: ユニットテスト（test/pure/）、統合テスト（test/integration/）、実機テスト。

---

## 2. フェーズ進捗（Phase番号・チェックボックス整理）

### Phase 0: 基盤・設計・テスト体制
- [x] 0.1: PlatformIO/Unity導入・構造確立
- [x] 0.2: モック・テスト環境構築
- [x] 0.3: DIパターン設計・インターフェース定義
- [x] 0.4: 純粋ロジック実装（TimeLogic, AlarmLogic, InputLogic, SettingsLogic）
- [x] 0.5: インターフェース定義（IButtonManager, ISpeaker, IEEPROM等）
- [x] 0.6: アダプター実装（M5Stack用）
- [x] 0.7: 純粋ロジックテスト・モック実装・自動化
- [x] 0.8: 統合テスト実装
- [x] 0.9: カバレッジ測定・品質保証基盤
- [x] 0.9.1: 状態遷移システム実装
- [x] 0.9.2: 状態遷移テスト
- [x] 0.9.3: 状態遷移統合
- [x] 0.9.4: 状態遷移最適化
- [x] 0.9.5: ButtonType統一

### Phase 1: カバレッジ計測再構築
- [x] 1.1: カバレッジ計測システム設計・実装
- [x] 1.2: スクリプト・設定・CI/CD整備
- [x] 1.3: 純粋ロジック・M5Stack依存両方でカバレッジ計測
- [x] 1.4: 統合カバレッジレポート生成
- [x] 1.5: 品質ゲート＝現状カバレッジ（61%）維持に再設定


#### 【2024/07/19更新】現状を踏まえたPhase 2進行方針

- ButtonManager統合前から「画面真っ暗」等の問題が潜在していた可能性が高い。
- 「壊れていないベースライン」から段階的に再統合する方針に切り替える。
- UI描画（ui.cpp）は流用し、状態管理・設定・ボタン管理のみを段階的に復活させる。
- 各統合ステップで「壊れたら即切り戻し・原因特定」→修正。
- 設定値（settings.lcd_brightness等）の初期化・ロードロジックを最初に見直す。
- updateSystem/handleButtons等の本格統合は、最小構成で動作確認しながら進める。

### Phase 2: 段階的統合・本体接続フロー
- [x] 1. 壊れていないベースライン状態のmain.cppを保存（明度255固定、UIのみ表示）
- [x] 2. settings管理の初期化・ロード部分のみ有効化し、明度設定が正しく動くか確認。他の設定値も段階的に復活
- [x] 3. ボタン管理・状態遷移の最小構成を有効化し、1つずつ動作確認。壊れたら即切り戻し・原因特定
- [ ] 4. test/pure/配下のロジック（TimeLogic, AlarmLogic, ButtonManager等）をmain.cppや状態遷移システムと実際に接続・統合
  - [x] 1. TimeLogicの統合
      - [x] 現在時刻取得・表示のみtest/pure/ロジックに切り替え
      - [x] UIで時刻が正しく表示されるか確認
  - [ ] 2. AlarmLogicの統合
      - [x] アラーム時刻の管理・表示のみtest/pure/ロジックに切り替え
      - [ ] アラーム一覧や次アラーム表示が正しいか確認
      - [ ] **アラーム追加・削除・時刻進行に応じてアラーム一覧や次アラームが動的に変化することを確認**
  - [ ] 3. ButtonManagerの統合
     - [ ] ボタン判定・デバウンス処理をtest/pure/ロジックに切り替え
     - [ ] ボタン反応・長押し/短押し判定が正しいか確認
  - [ ] 4. InputLogic/SettingsLogicの統合
     - [ ] 入力処理や設定保存/ロードをtest/pure/ロジックに切り替え
     - [ ] 設定変更・保存・反映が正しいか確認
  - [ ] 5. 状態遷移システムとの本格統合
    - [ ] すべてのロジックを統合し、画面遷移・アラーム・設定等の一連動作を検証
- [ ] 5. DI/アダプター層で物理層と純粋ロジック層をIButtonManager等で抽象化・接続
- [ ] 6. 状態遷移システム・UIでIButtonManager等の抽象型を利用
- [ ] 7. 統合テスト・結合テスト追加、API設計の有用性・問題点を実証的に検証
- [ ] 8. 統合・運用結果をもとにAPI設計や責務分離の見直し・改善
---

### Phase 3: 基本タイマー機能の完成
- [ ] 3.1: 現在時刻表示の正確性
- [ ] 3.2: アラーム設定・削除の基本動作
- [ ] 3.3: 画面遷移の安定性
- [ ] 3.4: 既存バグ修正
- [ ] 3.5: バリデーション実装

### Phase 4: 高度機能・UI/UX改善
- [ ] 4.1: 電源管理
- [ ] 4.2: Wi-Fi設定
- [ ] 4.3: NTP同期
- [ ] 4.4: UI/UX改善

---

## 3. 重要な現状メモ・コンテキスト

- 現状の品質ゲートは「カバレッジ61%維持」（80%目標は一時保留）
- test/pure/配下の純粋ロジックはmain.cpp等の本体実装と未接続
- Phase 2で「純粋ロジックと本体実装の統合・実運用検証」が最優先
- API設計の有用性・実運用での問題点を統合テストで明確化し、必要に応じて設計改善を行う

---

## 4. 必要な追加コンテキスト（AI向け）

- 各Phaseは「設計→実装→統合→検証→改善」のサイクルで進行
- チェックボックスは「完了済み[x]」「未完了[ ]」で明示
- Phase 2以降は「test/pure/のロジックを本体実装に組み込む」ことが最重要
- 品質ゲート・カバレッジ目標は現状維持基準（61%）で運用中