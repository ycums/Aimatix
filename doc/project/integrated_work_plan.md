# Aimatix 統合作業計画書

## 1. プロジェクト概要

### 1.1 プロジェクト目標
M5Stack Fireを使用した集中タイマーアプリケーションの開発。実機テストを最小限に留め、各フェーズで十分なテストカバレッジを確保する。

### 1.2 現在の状況
- **アーキテクチャ**: DIパターンによる純粋ロジック分離完了
- **テスト環境**: Unityテストフレームワークによる段階的テスト実装
- **カバレッジ計測**: 設計完了、実装準備完了
- **品質保証**: 80%カバレッジ目標の設定

### 1.3 主要課題
- **カバレッジ計測**: 設計完了、実装準備完了
- **統合テスト**: M5Stack依存実装のテスト環境整備
- **実機テスト**: 最小限の実機テスト戦略の確立

## 2. アーキテクチャ概要

### 2.1 DIパターン実装
- **純粋ロジック**: `lib/libaimatix/src/` - M5Stack依存なし
- **インターフェース**: `lib/libaimatix/include/` - 抽象化インターフェース
- **M5Stack依存実装**: `src/` - ハードウェア依存実装
- **アダプター**: `src/m5stack_adapters.cpp/h` - 依存性注入

### 2.2 テスト戦略
- **純粋ロジックテスト**: `test/pure/` - 高速、高カバレッジ
- **統合テスト**: `test/integration/` - M5Stack依存実装テスト
- **実機テスト**: 最小限の基本動作確認

### 2.3 カバレッジ計測システム
- **設計完了**: 詳細設計書、技術仕様書、運用ガイド作成完了
- **実装準備**: スクリプト、設定ファイル、CI/CD統合準備完了
- **品質ゲート**: 80%カバレッジ目標の監視システム

## 3. 完了済みフェーズ

### 3.1 Phase 0.1: 基盤整備
- [x] PlatformIO環境の構築
- [x] Unityテストフレームワークの導入
- [x] 基本的なプロジェクト構造の確立

### 3.2 Phase 0.2: テスト環境構築
- [x] モック環境の実装
- [x] 基本的なテストケースの作成
- [x] テスト実行環境の整備

### 3.3 Phase 0.3: アーキテクチャ設計
- [x] DIパターンの設計
- [x] インターフェース定義
- [x] 依存関係の整理

### 3.4 Phase 0.4: 純粋ロジック実装
- [x] TimeLogicクラスの実装
- [x] AlarmLogicクラスの実装
- [x] InputLogicクラスの実装
- [x] SettingsLogicクラスの実装

### 3.5 Phase 0.5: インターフェース定義
- [x] IButtonManagerインターフェース
- [x] ISpeakerインターフェース
- [x] IEEPROMインターフェース
- [x] 型定義の統一

### 3.6 Phase 0.6: アダプター実装
- [x] M5StackButtonManagerアダプター
- [x] M5StackSpeakerアダプター
- [x] M5StackEEPROMアダプター
- [x] 依存性注入の実装

### 3.7 Phase 0.7: テスト環境整備
- [x] 純粋ロジックテストの実装
- [x] モック実装の完成
- [x] テスト実行の自動化
- [x] 基本的なカバレッジ測定

### 3.8 Phase 0.8: 統合テスト実装
- [x] 統合テスト環境の構築
- [x] M5Stack依存実装のテスト
- [x] エンドツーエンドテストの実装
- [x] テストカバレッジの向上

### 3.9 Phase 0.9: 品質保証基盤
- [x] カバレッジ測定の導入（gcovベース）
- [x] カバレッジ測定の信頼性向上
- [x] time_logicの100%カバレッジ達成
- [x] カバレッジ測定スクリプトの動作確認
- [x] 全モジュールのテストカバレッジ80%以上達成
- [x] カバレッジ測定の仕組みが破壊され、再構築が必要

### 3.10 Phase 0.9.1: 状態遷移システム
- [x] ButtonEventクラスの実装
- [x] SystemStateクラスの実装
- [x] TransitionResultクラスの実装
- [x] StateTransitionクラスの実装
- [x] TransitionValidatorクラスの実装

### 3.11 Phase 0.9.2: 状態遷移テスト
- [x] 状態遷移の単体テスト実装
- [x] 状態遷移の統合テスト実装
- [x] 状態遷移のエラーケーステスト
- [x] 状態遷移のパフォーマンステスト

### 3.12 Phase 0.9.3: 状態遷移統合
- [x] main.cppへの状態遷移システム統合
- [x] UI層への状態遷移システム統合
- [x] 入力層への状態遷移システム統合
- [x] 状態遷移システムの動作確認

### 3.13 Phase 0.9.4: 状態遷移最適化
- [x] 状態遷移のパフォーマンス最適化
- [x] 状態遷移のメモリ使用量最適化
- [x] 状態遷移のエラーハンドリング改善
- [x] 状態遷移のドキュメント整備

### 3.14 Phase 0.9.5: ボタン型統一
- [x] ButtonType列挙型の統一
- [x] インターフェースのButtonType対応
- [x] 実装クラスのButtonType対応
- [x] モック実装のButtonType対応
- [x] テストコードのButtonType対応
- [x] 全環境でのビルド・テスト成功確認

## 4. 現在のフェーズ

### 4.1 Phase 0.9.6: カバレッジ計測の再構築（実装準備完了）
**目標**: DIパターンに対応した新しいカバレッジ計測システムの構築

#### 4.1.1 背景
- DIパターンによる純粋ロジック分離により、以前のカバレッジ計測仕組みが破壊
- 新しいアーキテクチャに対応したカバレッジ計測が必要
- 品質保証の基盤としてカバレッジ計測の復旧が重要

#### 4.1.2 設計完了項目
- [x] **カバレッジ計測システム設計書**: `doc/design/coverage_measurement_system.md`
- [x] **技術仕様書**: `doc/spec/coverage_measurement_spec.md`
- [x] **運用ガイド**: `doc/operation/coverage_measurement_guide.md`
- [x] **システムアーキテクチャ**: DIパターン対応の設計
- [x] **技術実装仕様**: gcov/gcovr、PlatformIO統合
- [x] **運用設計**: CI/CD統合、監視、通知
- [x] **品質ゲート設計**: **現状のカバレッジ（61%）を基準とし、それを維持することを品質ゲートとする**（従来の80%目標から現状維持基準へ変更）

#### 4.1.3 実装準備完了項目
- [x] **スクリプト設計**: `scripts/test_coverage.py`の詳細設計
- [x] **設定ファイル設計**: `coverage_config.json`の仕様
- [x] **PlatformIO設定**: native、unit-test-esp32環境のカバレッジ設定
- [x] **CI/CD統合設計**: GitHub Actions設定
- [x] **品質ゲート設計**: 80%カバレッジ目標の監視

#### 4.1.4 実装対象
- [x] 新しいカバレッジ計測スクリプトの作成
- [x] 純粋ロジックテストのカバレッジ計測設定
- [x] M5Stack依存実装のカバレッジ計測設定
- [x] 統合カバレッジレポートの生成
- [x] **カバレッジ目標の再設定と監視（現状のカバレッジ値を下回らないことを品質ゲートとする）**

#### 4.1.5 修正ファイル
- `scripts/test_coverage.py` (新規作成)
- `coverage_config.json` (新規作成)
- `platformio.ini` (カバレッジ設定の更新)
- `test/` (各テストファイルのカバレッジ設定)

#### 4.1.6 成功基準
- [x] 新しいカバレッジ計測システムの動作確認
- [x] 純粋ロジックとM5Stack依存実装の両方でカバレッジ計測成功
- [x] 統合カバレッジレポートの生成確認
- [x] **現状カバレッジ（61%）の維持を品質ゲートとする再設定完了**

---

#### 【進捗・現状メモ】
- カバレッジ計測システム自体は設計・実装準備が完了し、スクリプト・設定・CI/CDも整備済み。
- しかし、lib/libaimatix/src/配下のButtonManagerやDebounceManager等の「純粋ロジック本体」は、現状main.cpp等の実運用コードから直接は呼ばれていない。
- そのため、API設計がmain.cpp等の実運用フローで本当に役立つかどうかは**未検証**。
- この状態でカバレッジ向上施策（テスト追加・分岐網羅）を進めても、API自体が使い物にならない可能性がある。
- **今後の優先タスク：API設計の有用性をmain.cppや状態遷移システム等で実際に統合・運用し、フィードバックを得ること。**
- カバレッジ向上タスクは「APIの実運用統合・有用性検証」が完了するまで一時保留とする。

## 5. 今後のフェーズ

### 5.1 Phase 1: 基本タイマー機能の完成
**目標**: 基本的なタイマー機能の完成と品質保証

#### 5.1.1 現在時刻表示の正確性確認
- [ ] 1秒間隔での正確な更新
- [ ] 時刻形式の正確性（HH:MM）
- [ ] 表示位置の正確性
- [ ] フォント・色の正確性

#### 5.1.2 アラーム設定・削除の基本動作確認
- [ ] 最大5件の制限確認
- [ ] 重複チェック機能
- [ ] 過去時刻の自動削除
- [ ] 時刻順での自動ソート

#### 5.1.3 画面遷移の安定性確認
- [ ] 全モード間の遷移動作
- [ ] デバウンス処理の効果
- [ ] 警告メッセージの表示

#### 5.1.4 既存バグの修正
- [ ] 警告表示の正常動作
- [ ] Windows環境でのビルド成功
- [ ] テスト環境での実行成功

#### 5.1.5 基本的なバリデーションの実装
- [ ] 時刻入力値の妥当性チェック
- [ ] アラーム数の上限チェック
- [ ] 境界値の正確な処理

### 5.2 Phase 2: 高度機能の実装
**目標**: 電源管理、Wi-Fi設定、NTP同期機能の実装

#### 5.2.1 電源管理機能
- [ ] アイドル時間監視
- [ ] スリープ復帰方法
- [ ] 動作周波数制御
- [ ] バッテリー監視

#### 5.2.2 Wi-Fi設定機能
- [ ] SmartConfig対応
- [ ] 設定保存・読み込み
- [ ] 接続状態監視
- [ ] エラーハンドリング

#### 5.2.3 NTP同期機能
- [ ] NTPサーバー同期
- [ ] 時刻精度向上
- [ ] 同期間隔設定
- [ ] エラー復旧

### 5.3 Phase 3: UI/UX改善
**目標**: ユーザビリティの向上とパフォーマンス最適化

#### 5.3.1 高優先度改善
- [ ] メイン表示画面の完成
- [ ] 入力モードの完成
- [ ] アラーム鳴動画面の完成

#### 5.3.2 中優先度改善
- [ ] アラーム管理画面の完成
- [ ] 設定メニューの完成
- [ ] 警告メッセージシステムの改善

#### 5.3.3 低優先度改善
- [ ] 電源管理機能の詳細実装
- [ ] パフォーマンス最適化
- [ ] エラーハンドリングの統合

## 6. 品質指標

### 6.1 テストカバレッジ目標
- **Unit Testカバレッジ**: 85%
- **統合テストカバレッジ**: 95%
- **実機テスト**: 基本動作確認のみ

### 6.2 パフォーマンス目標
- **メインループ**: 100Hz維持
- **RAM使用量**: 0.5%以下
- **Flash使用量**: 10%以下
- **バッテリー持続時間**: 8時間以上

### 6.3 品質保証目標
- **ビルド成功率**: 100%
- **テスト実行成功率**: 100%
- **カバレッジ計測成功率**: 100%
- **実機テスト成功率**: 95%以上

## 7. リスク管理

### 7.1 技術リスク
- **M5Stackライブラリの制限**: 代替実装の検討
- **メモリ不足**: 最適化手法の適用
- **パフォーマンス劣化**: 段階的な最適化

### 7.2 スケジュールリスク
- **実装遅延**: 優先度の調整
- **テスト遅延**: 並行作業の推進
- **統合問題**: 早期統合テストの実施

### 7.3 品質リスク
- **カバレッジ目標未達**: 優先度別修正による達成
- **実機テスト失敗**: 段階的な実機テスト
- **パフォーマンス問題**: 継続的な最適化

## 8. 次のステップ

### 8.1 即座に実行可能
1. **Phase 0.9.6**: カバレッジ計測の再構築（設計完了、実装準備完了）
2. **カバレッジ計測スクリプト実装**: `scripts/test_coverage.py`
3. **設定ファイル作成**: `coverage_config.json`
4. **PlatformIO設定更新**: カバレッジ設定の追加
5. **CI/CD統合**: GitHub Actions設定

### 8.2 並行実行可能
1. **Phase 1準備**: 基本タイマー機能の設計詳細化
2. **統合テスト強化**: M5Stack依存実装のテスト拡充
3. **ドキュメント整備**: 設計書、仕様書の更新

### 8.3 将来の計画
1. **Phase 1**: 基本タイマー機能の完成
2. **Phase 2**: 高度機能の実装
3. **Phase 3**: UI/UX改善

## 9. 成功指標

### 9.1 短期目標（Phase 0.9.6完了時）
- [ ] カバレッジ計測システムの動作確認
- [ ] 80%カバレッジ目標の達成
- [ ] CI/CD統合の完了
- [ ] 品質ゲートの動作確認

### 9.2 中期目標（Phase 1完了時）
- [ ] 基本タイマー機能の完成
- [ ] 全機能のテストカバレッジ80%以上
- [ ] 実機テストの成功
- [ ] パフォーマンス目標の達成

### 9.3 長期目標（Phase 3完了時）
- [ ] 全機能の完成
- [ ] ユーザビリティの向上
- [ ] パフォーマンスの最適化
- [ ] 品質保証の確立

## 10. 結論

### 10.1 現在の状況
- **アーキテクチャ**: DIパターンによる設計完了
- **テスト環境**: Unityテストフレームワークによる段階的実装
- **カバレッジ計測**: 設計完了、実装準備完了
- **品質保証**: 80%カバレッジ目標の設定

### 10.2 次のアクション
1. **最高優先度**: カバレッジ計測の再構築（Phase 0.9.6）
2. **並行実行**: 基本タイマー機能の設計詳細化
3. **継続実行**: 統合テストの強化

### 10.3 成功要因
- **段階的実装**: 各フェーズでの確実な完了
- **テスト駆動開発**: 品質保証の基盤
- **純粋ロジックテスト**: M5Stack依存なし、80%カバレッジ目標
- **カバレッジ計測**: DIパターン対応の新しいシステム（設計完了）
- **実機テスト最小化**: 効率的な開発プロセス

## 11. AI Agent開発フロー遵守ガイドライン

### 11.1 必須遵守事項

#### 11.1.1 コード変更時の品質保証
- **変更前**: 必ずカバレッジ計測を実行して現状を把握
- **変更中**: 段階的にテストを実行して品質を維持
- **変更後**: 完全なカバレッジ計測で品質を確認

#### 11.1.2 開発フェーズ別品質チェック
```bash
# 開発開始時（必須）
python scripts/test_coverage.py --baseline
python scripts/test_coverage.py --check-env

# 開発中（頻繁に実行）
python scripts/test_coverage.py --quick
python scripts/test_coverage.py --environment native --filter "変更したモジュール名"

# 機能完成時（必須）
python scripts/test_coverage.py --full
python scripts/test_coverage.py --quality-gate-only

# リリース前（必須）
python scripts/test_coverage.py --release --strict
python scripts/test_coverage.py --trend-analysis
```

#### 11.1.3 品質ゲートチェック
- **開発中**: 70%カバレッジ未達の場合は警告を表示
- **機能完成時**: 80%カバレッジ未達の場合は実装継続不可
- **リリース前**: 85%カバレッジ未達の場合はリリース不可

### 11.2 AI Agent品質保証ワークフロー

#### 11.2.1 新機能実装時
1. **設計段階**: テスト戦略の策定
2. **実装段階**: 段階的なテスト実行
3. **完成段階**: 完全なカバレッジ計測
4. **統合段階**: 統合テストの実行

#### 11.2.2 バグ修正時
1. **問題特定**: カバレッジ計測で問題領域の特定
2. **修正実装**: 修正内容のテストケース追加
3. **修正確認**: 修正箇所のカバレッジ確認
4. **回帰テスト**: 既存機能への影響確認

#### 11.2.3 リファクタリング時
1. **事前計測**: 変更前のカバレッジ計測
2. **段階的変更**: 小さな変更単位でのテスト実行
3. **動作確認**: 既存テストの動作確認
4. **最終確認**: 完全なカバレッジ計測

### 11.3 品質保証チェックリスト

#### 11.3.1 日常開発チェックリスト
- [ ] 開発開始時にベースライン計測実行
- [ ] コード変更後にクイックカバレッジ計測実行
- [ ] 新機能追加時にテストケース追加
- [ ] 機能完成時に完全カバレッジ計測実行
- [ ] 品質ゲート通過確認

#### 11.3.2 リリース準備チェックリスト
- [ ] リリース品質カバレッジ計測実行
- [ ] 品質ゲート厳格モード通過確認
- [ ] 履歴データ記録確認
- [ ] 品質トレンド分析確認
- [ ] リリース記録作成

#### 11.3.3 トラブルシューティングチェックリスト
- [ ] カバレッジ計測失敗時の原因特定
- [ ] 品質ゲート未達時の改善計画策定
- [ ] パフォーマンス問題時の最適化実行
- [ ] 環境固有問題の解決確認

### 11.4 AI Agent品質保証ルール

#### 11.4.1 自動実行ルール
- **コード変更検知時**: 自動的にクイックカバレッジ計測実行
- **コミット前**: 品質ゲートチェック実行
- **プルリクエスト時**: 完全カバレッジ計測実行
- **リリース前**: 厳格品質ゲートチェック実行

#### 11.4.2 品質保証ルール
- **カバレッジ低下**: 即座に警告表示、改善計画策定
- **品質ゲート未達**: 実装継続不可、改善必須
- **テスト失敗**: 即座に修正、再テスト実行
- **パフォーマンス劣化**: 最適化実行、基準回復確認

#### 11.4.3 ドキュメント更新ルール
- **設計変更時**: 関連ドキュメントの更新
- **品質基準変更時**: ガイドラインの更新
- **新機能追加時**: 運用ガイドの更新
- **問題解決時**: トラブルシューティングガイドの更新

**現在のフェーズ**: Phase 0.9.6（カバレッジ計測の再構築 - 実装準備完了）