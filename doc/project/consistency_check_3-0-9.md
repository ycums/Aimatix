# 3-0-9: 入力画面で桁送りができる（InputLogic/UIの編集操作拡張）関連ドキュメント整合性確認帳票

## 概要
3-0-9タスクの実装にあたり、関連ドキュメント間の矛盾点を特定し、どちらが正しいかを確認するための帳票です。

---

## 1. 矛盾点の特定

### 1-1. B短押しの動作仕様

#### 矛盾点1: 桁送り動作の定義
**質問票3-0-9.md**:
- B短押しで「カーソルを次へ」移動 → 仕様変更済み
- 桁送り方向: 右から左（3→2→1→0）

**spec.md**:
- B短押し: 桁送り（離した瞬間に判定）
- 桁送り方向: 右から左（3→2→1→0→3）
- 具体例: `__:_1` → `__:1_`, `__:1_` → `_1:0_`, `__:12` → `_1:2_`, `__:99` → `_9:9_`, `99:99` → 拒絶

**state_transition.md**:
- ABS_TIME_INPUT | B短押し | カーソルを次へ | (遷移なし)

#### 矛盾点2: 桁送り失敗時の処理
**質問票3-0-9.md**:
- 桁送り失敗時: エラーメッセージ表示

**spec.md**:
- 桁送り失敗時の明示的な記述なし

**現在の実装（InputLogic.h）**:
- 桁送り機能が未実装（onButtonB()が空）

### 1-2. ボタンヒント表示

#### 矛盾点3: ボタンヒントの文言
**質問票3-0-9.md**:
- A: "+1/+5" B: "Next/Reset" C: "Set/Cancel"

**spec.md**:
- A: "+1/+5" B: "Next/Reset" C: "Set"

**現在の実装（InputDisplayState.h）**:
- showHints("OK", "", "CANCEL")

### 1-3. 設計原則

#### 矛盾点4: 責務分離の実装
**設計ドキュメント（architecture.md, logic_interface.md）**:
- ロジック層はUI遷移や画面制御を一切行わない
- 純粋ロジックのみ担当

**現在の実装（InputDisplayState.h）**:
- onButtonB()が空実装
- 桁送りロジックが未実装

---

## 2. 整合性確認項目

### 2-1. 桁送り動作仕様の統一

| 項目                   | 質問票3-0-9.md      | spec.md               | state_transition.md | 現在の実装 | 正しい仕様 |
| ---------------------- | ------------------- | --------------------- | ------------------- | ---------- | ---------- |
| B短押し動作            | 桁送り              | 桁送り                | カーソルを次へ      | 未実装     | 【選択】   |
| 桁送り方向             | 右から左（3→2→1→0） | 右から左（3→2→1→0→3） | -                   | -          | 【選択】   |
| 全桁入力時の処理       | 拒絶                | 拒絶                  | -                   | -          | 【選択】   |
| 失敗時のフィードバック | エラーメッセージ    | 未記載                | -                   | -          | 【選択】   |

**正しい仕様の選択:**
- [x] 質問票3-0-9.mdの仕様を採用
- [ ] spec.mdの仕様を採用  
- [ ] 両方を統合した新仕様を作成
- [ ] その他（【自由記述】）

### 2-2. ボタンヒント表示の統一

| 項目 | 質問票3-0-9.md | spec.md | 現在の実装 | 正しい仕様 |
|------|----------------|---------|-----------|-----------|
| Aボタン | "+1/+5" | "+1/+5" | "OK" | 【選択】 |
| Bボタン | "Next/Reset" | "Next/Reset" | "" | 【選択】 |
| Cボタン | "Set/Cancel" | "Set" | "CANCEL" | 【選択】 |

**正しい仕様の選択:**
- [x] 質問票3-0-9.mdの仕様を採用
- [ ] spec.mdの仕様を採用
- [ ] 現在の実装を採用
- [ ] その他（【自由記述】）

### 2-3. 設計原則の適用

| 項目 | 設計ドキュメント | 現在の実装 | 正しい方針 |
|------|----------------|-----------|-----------|
| 桁送りロジックの実装場所 | 純粋ロジック層 | 未実装 | 【選択】 |
| UI層の責務 | イベント受信・画面反映 | 部分実装 | 【選択】 |
| テスト容易性 | モック注入可能 | 未対応 | 【選択】 |

**正しい方針の選択:**
- [ ] 設計ドキュメントに完全準拠
- [ ] 現在の実装を基準に調整
- [x] 両方を統合した新方針を作成
- [ ] その他（【自由記述】）

---

## 3. 実装方針の確認

### 3-1. InputLogicへの桁送り機能追加

**実装方針:**
- [ ] InputLogicに`moveCursor()`メソッドを追加
- [ ] 桁送り成功/失敗を戻り値で返す
- [ ] 純粋ロジックとして実装（UI依存なし）
- [ ] 既存の`digits[]`, `entered[]`, `cursor`を活用

### 3-2. UI層での桁送り処理

**実装方針:**
- [ ] InputDisplayStateのonButtonB()でInputLogic.moveCursor()を呼び出し
- [ ] 戻り値に応じてUI反映（成功時のみカーソル位置更新）
- [ ] 失敗時は何もしない（音・視覚的フィードバックなし）
- [ ] コマンド/イベント駆動設計に準拠

### 3-3. テスト方針

**実装方針:**
- [ ] InputLogicの桁送り機能のUnit Testを追加
- [ ] 境界値テスト（全桁入力済み、部分入力等）
- [ ] カバレッジ品質ゲートを上回る
- [ ] TDDアプローチで実装

---

## 4. ドキュメント更新指示

### 4-1. 更新が必要なドキュメント

**仕様ドキュメント:**
- [ ] spec.md: 桁送り失敗時の処理を明確化
- [ ] state_transition.md: アクション文言を統一

**設計ドキュメント:**
- [ ] logic_interface.md: InputLogicの桁送りAPIを追加
- [ ] test_case_policy.md: 桁送りテストケース例を追加

**実装ドキュメント:**
- [ ] InputLogic.h: 桁送りメソッドの実装
- [ ] InputDisplayState.h: onButtonB()の実装

### 4-2. 更新優先度

**高優先度:**
- [x] spec.mdの桁送り失敗時処理の明確化
- [ ] InputLogic.hへの桁送りメソッド追加

**中優先度:**
- [x] logic_interface.mdのAPI仕様追加
- [x] test_case_policy.mdのテスト例追加

**低優先度:**
- [x] state_transition.mdの文言統一
- [x] その他のドキュメント調整

---

## 5. 最終確認

### 5-1. 実装開始前の確認事項

- [ ] 上記の整合性確認が完了している
- [ ] 正しい仕様が確定している
- [ ] 設計原則に準拠した実装方針が決定している
- [ ] テスト方針が明確になっている

### 5-2. 実装完了後の確認事項

- [ ] 全テストが通っている
- [ ] カバレッジが品質ゲートを上回っている
- [ ] 実機での動作確認が完了している
- [ ] ドキュメントが最新状態に更新されている

---

**作成日**: 2025年1月
**作成者**: AI Assistant
**確認者**: 【ユーザー名】
**更新日**: 【更新日】 