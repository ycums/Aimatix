# 【質問票】3-0-11.5: 相対入力モードのバグ修正 実装前確認

本質問票は「3-0-11.5: 相対入力モードのバグ修正」の実装に先立ち、仕様・要件・テスト基準の明確化と合意を目的としています。

---

## 1. バグの詳細確認

### 1-1. バグの現象
- [x] 相対時間→絶対時間の変換時に秒以下が反映されていないバグが発生しているのは正しいですか？
    - [x] はい
    - [ ] いいえ（【自由記述】）
- [x] 具体的な現象は以下の通りですか？
    - [x] now: 15:34:12 & input: __:05 なら expected: 15:39:12
      - actual: 15:39:00（秒が00にリセットされている）
    - [ ] その他（【自由記述】）

### 1-2. 影響範囲
- [x] このバグの影響を受ける機能は？
    - [ ] 相対値入力モード（REL_PLUS_TIME_INPUT）のプレビュー表示
      - [x] プレビューは描画表示されていないため目視での判定不能
    - [x] 相対値入力モードでのアラーム追加
    - [ ] 絶対値入力モード（ABS_TIME_INPUT）
    - [ ] その他（【自由記述】）
- [x] バグが発生する条件は？
    - [x] 現在時刻の秒が0以外の場合
    - [x] 相対値入力モードで時刻を入力した場合
    - [ ] その他（【自由記述】）

---

## 2. 修正方針の確認

### 2-1. 修正対象の特定
- [x] 修正が必要なファイル・関数は？
    - [x] `lib/libaimatix/src/InputLogic.h` の `getRelativeValue()` メソッド
      - [x] ロジック修正も必要だが、関数名も `getAbsoluteValue()` と修正が必要
    - [x] `lib/libaimatix/src/InputDisplayState.h` の相対値計算部分
      - [x] そもそも、 `InputLogic.h` の `getAbsoluteValue()` で計算した絶対値を `InputDisplayState` は 絶対値入力モードと同一のルーチンで表示するべき
    - [ ] その他（【自由記述】）
- [x] 根本原因は？
    - [x] 相対値計算時に `tm_sec = 0` で秒をリセットしている
    - [ ] 時刻変換処理の不備
    - [ ] その他（【自由記述】）

### 2-2. 修正方法
- [x] 修正方法は以下の通りでよいですか？
    - [x] 相対値計算時に現在時刻の秒を保持する
    - [x] `alarm_tm.tm_sec = tm_now->tm_sec;` に変更
    - [x] 関数名を `getRelativeValue()` から `getAbsoluteValue()` に変更
    - [x] InputDisplayStateで絶対値入力モードと同一の表示ルーチンを使用
    - [ ] その他（【自由記述】）
- [x] 修正後の期待動作は？
    - [x] now: 15:34:12 & input: __:05 なら 15:39:12
    - [x] 秒が正しく保持される
    - [ ] その他（【自由記述】）

---

## 3. 仕様・要件の確認

### 3-1. 相対値入力の仕様
- [x] 相対値入力時の秒の扱いは？
    - [x] 現在時刻の秒をそのまま保持する
    - [ ] 秒を00にリセットする
    - [ ] その他（【自由記述】）
- [x] 仕様書での定義は？
    - [x] 相対時刻追加: 現在時刻 + 入力値（秒は保持）
    - [ ] 相対時刻追加: 現在時刻 + 入力値（秒は00）
    - [ ] その他（【自由記述】）

### 3-2. プレビュー表示の仕様
- [x] プレビュー表示の書式は？
    - [x] "HH:MM"形式（秒は表示しない）
    - [ ] "HH:MM:SS"形式
    - [ ] その他（【自由記述】）
      - [x] 仕様について相談したい。
        - [x] "HH:MM:SS"形式 にすると、プレビューを毎秒更新しなければならないが、そこまでする必要はない気がする。
        - [x] あくまでもプレビューなので、値をセットした時点の確定値が正しければ良いと思うのだが。
- [x] プレビュー表示の更新タイミングは？
    - [x] 入力値変更時即座に更新
    - [ ] 一定間隔で更新
    - [ ] その他（【自由記述】）

---

## 4. 実装・設計仕様

### 4-1. 修正対象の実装
- [x] InputLogic::getRelativeValue()の修正内容は？
    - [x] `alarm_tm.tm_sec = 0;` を `alarm_tm.tm_sec = tm_now->tm_sec;` に変更
    - [x] 関数名を `getRelativeValue()` から `getAbsoluteValue()` に変更
    - [x] その他の修正
    - [ ] その他（【自由記述】）
- [x] 修正後のテストは？
    - [x] 既存の相対値計算テストを更新
    - [x] 秒が保持されることを確認するテストを追加
    - [x] 関数名変更に伴うテスト修正
    - [ ] その他（【自由記述】）

### 4-2. 設計原則の遵守
- [x] 修正は以下の設計原則に準拠しますか？
    - [x] 純粋ロジックとして実装（UI依存なし）
    - [x] 既存のインターフェースを維持
    - [x] テスト容易性を確保
    - [x] 設計の一貫性を保つ（絶対値入力モードと同一の表示ルーチン）
    - [ ] その他（【自由記述】）

---

## 5. テスト・完成条件

### 5-1. 修正確認テスト
- [x] 以下のテストケースで修正を確認しますか？
    - [x] 現在時刻が秒を含む場合の相対値計算
    - [x] 現在時刻が秒00の場合の相対値計算
    - [x] 部分入力時の相対値計算
    - [x] 日付跨ぎ時の相対値計算
    - [x] 関数名変更に伴う既存テストの修正
    - [ ] その他（【自由記述】）

### 5-2. 完成判定
- [x] 以下の条件を満たせば「完成」としてよいですか？
    - [x] 相対値入力で秒が正しく保持される
    - [x] プレビュー表示が正しく更新される
    - [x] アラーム追加時に正しい時刻が設定される
    - [x] 既存のテストが全て通る
    - [x] カバレッジが品質ゲートを上回っている
    - [x] Clang-Tidy警告数: 90件 
    - [ ] その他（【自由記述】）

### 5-3. テスト観点
- [x] テストで特に重視すべき観点・パターンがあればご記入ください
    - 【自由記述】
      - 現在時刻の秒が0以外の場合の相対値計算
      - 現在時刻の秒が00の場合の相対値計算
      - 部分入力時の秒保持
      - 日付跨ぎ時の秒保持
      - 境界値テスト（59秒、00秒等）
      - 既存機能への影響確認
      - 関数名変更に伴う既存テストの修正確認

---

## 6. その他・ご要望
- [x] その他、実装・UI・テストに関するご要望・注意点があればご記入ください
    - MUST: 設計は `doc/design/` に準拠させること
    - MUST: 仕様は `doc/spec/` に準拠させること
    - SHOULD: 進行に関しては `guide/developer_guide.md` を参照のこと
    - SHOULD: 可能な限りTDDで進めること
    - 【自由記述】
    - 修正は最小限に留め、既存の動作に影響を与えないこと
    - 秒の保持は相対値入力モードのみに限定すること
    - 絶対値入力モードの動作は変更しないこと
    - 修正後は実機テストで動作確認を行うこと
    - 関数名変更は設計の一貫性を保つための重要な修正であること

---

## 【仕様転記】
過去の質問票（3-0-8, 3-0-9, 3-0-10, 3-0-11）から転記：

### エラーメッセージの言語
- エラー時に表示するメッセージは英語にすること。
  - 実機に日本語フォントが導入されていないため。

### 設計原則
- 純粋ロジック（InputLogic）はUI遷移や画面制御を一切持たず、入力処理のみを担当する。
- UI層は「入力確定」イベントを受けて、ロジック層APIを呼び出し、戻り値やイベント通知をもとにUI反映を行う。
- 必要に応じて、APIの戻り値として「成否」「エラー内容」等を構造体やenumで返す。

### テスト方針
- 可能な限りTDDで進めること
- テストは `pio test -e native` で実行すること
  - 特定テスト実行は `pio test -e native -f pure/test_button_manager_pure`
  - printf デバッグを行うときは `-v` オプションが必要です。
- カバレッジは品質ゲートを上回ること

### 相対値入力の仕様
- 現在時刻からの相対時間入力
- 入力形式: HH:MM（4桁）
- プレビュー表示: "HH:MM"形式（秒は表示しない）
- 日付跨ぎ処理: 24時間を超える場合は翌日として計算
- 確定処理: 現在時刻 + 入力値をアラームとして追加

### 状態遷移テーブル（REL_PLUS_TIME_INPUT）
| 現在モード         | ボタンイベント | アクション   | 次モード           |
|--------------------|----------------|-------------|--------------------|
| REL_PLUS_TIME_INPUT | A短押し        | +1          | (遷移なし)         |
| REL_PLUS_TIME_INPUT | A長押し        | +5          | (遷移なし)         |
| REL_PLUS_TIME_INPUT | B短押し        | 桁送り      | (遷移なし)         |
| REL_PLUS_TIME_INPUT | B長押し        | 入力クリア  | (遷移なし)         |
| REL_PLUS_TIME_INPUT | C短押し        | 確定        | MAIN_DISPLAY       |
| REL_PLUS_TIME_INPUT | C長押し        | NOP         | MAIN_DISPLAY       |

### UI表示仕様
- タイトルバー：上部にモード名とバッテリー残量
- 時刻入力：中央部分に"HH:MM"形式で表示
- プレビュー：下部に相対値計算結果を表示
- ボタンヒント：下部にA: "INC" B: "NEXT" C: "SET"
- フォント：Font7（時刻入力）、Font2（プレビュー・ボタンヒント）
- 色：アンバー色（#FB20）

### 入力仕様
- 初期値：空 (__:__)
- カーソル位置：0=時十, 1=時一, 2=分十, 3=分一
- 初期カーソル位置：3（分一の位）
- 桁送り方向：右から左（3→2→1→0）
- 入力範囲：00:00-23:59
- 部分入力：未入力桁は0として補完

---

**作成日**: 2025年1月
**バージョン**: 1.0.0
**更新日**: 2025年1月 