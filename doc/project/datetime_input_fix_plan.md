# 日時入力機能修正計画書

## 概要
Task 3-0-13で実装した日時手動設定機能の実機テストで発見された問題点を修正するための計画書です。

## 問題点の分類

### 1. 緊急修正が必要な問題（高優先度）

#### 1.1 入力範囲の制限問題
**問題**: 年千の位、年百の位が入力可能になっている
- **現状**: 年千の位（位置0）、年百の位（位置1）が0-9で入力可能
- **仕様**: 年千の位、年百の位は入力不可（固定値"20"）
- **影響**: 不正な年入力が可能になり、バリデーションが機能しない

#### 1.2 カーソル移動の仕様問題
**問題**: 最後の位置で停止する仕様になっている
- **現状**: 分一の位（位置11）でBボタンを押しても移動しない
- **仕様**: 循環方式（最後の位置から最初の位置に戻る）
- **影響**: ユーザビリティの低下

#### 1.3 システム時刻更新の問題
**問題**: 確定時にシステム時刻が更新されていない
- **現状**: commitDateTime()でtime_tを計算するが、実際のシステム時刻更新が行われていない
- **仕様**: 確定時にシステム時刻を更新し、メイン画面に反映される
- **影響**: 設定した時刻が反映されない

### 2. 表示品質の問題（中優先度）

#### 2.1 カーソル表示位置のズレ
**問題**: ネガポジ反転の位置が正確でない
- **現状**: getCursorPixelPosition()の計算が不正確
- **原因**: 文字幅の計算や座標計算の誤差
- **影響**: テストが困難、ユーザビリティの低下

#### 2.2 画面更新のちらつき
**問題**: 不要な描画更新によるちらつき
- **現状**: 値に変更がなくても毎フレーム描画更新
- **原因**: 状態変更の検出が不十分
- **影響**: 視覚的な品質低下

## 修正方針

### Phase 1: 緊急修正（最優先）

#### 1.1 カーソル表示位置の修正（最優先）
**理由**: テストが困難なため、他の修正の前に実施
**対応内容**:
- `DateTimeInputViewImpl::getCursorPixelPosition()`の修正
- 文字幅の正確な計算
- 座標計算の精度向上
- テスト用のデバッグ表示追加

#### 1.2 入力範囲制限の修正
**対応内容**:
- `DateTimeInputState::incrementCurrentDigit()`の修正
- 年千の位、年百の位を入力不可に変更
- カーソル移動で年千の位、年百の位をスキップ
- 初期カーソル位置を年十の位に変更

#### 1.3 カーソル移動の循環化
**対応内容**:
- `DateTimeInputState::moveCursorRight()`の修正
- 最後の位置から最初の位置への循環実装
- 年千の位、年百の位をスキップする循環

#### 1.4 システム時刻更新の実装
**対応内容**:
- `ITimeProvider`に時刻更新機能を追加
- `M5StackTimeProvider`に時刻更新実装
- `DateTimeInputState::commitDateTime()`で実際の時刻更新
- メイン画面での時刻反映確認

### Phase 2: 表示品質の改善

#### 2.1 画面更新の最適化
**対応内容**:
- 状態変更の検出機能追加
- 不要な描画更新の削除
- ちらつき防止の実装

#### 2.2 エラー表示の改善
**対応内容**:
- バリデーションエラー時のエラーメッセージ表示
- エラー状態の視覚的フィードバック

## 実装順序

### Step 1: カーソル表示位置の修正
1. `DateTimeInputViewImpl::getCursorPixelPosition()`の修正
2. 文字幅の正確な計算実装
3. テスト用デバッグ表示の追加
4. 実機テストで位置確認

### Step 2: 入力範囲制限の修正
1. `DateTimeInputState::incrementCurrentDigit()`の修正
2. 年千の位、年百の位を入力不可に変更
3. カーソル移動の修正（スキップ機能）
4. 初期カーソル位置の変更

### Step 3: カーソル移動の循環化
1. `DateTimeInputState::moveCursorRight()`の修正
2. 循環ロジックの実装
3. 年千の位、年百の位のスキップ

### Step 4: システム時刻更新の実装
1. `ITimeProvider`インターフェースの拡張
2. `M5StackTimeProvider` を `DateTimeAdapter` にリネームし、機能を実装
3. `DateTimeInputState::commitDateTime()`の修正
4. メイン画面での時刻反映確認

### Step 5: 表示品質の改善
1. 状態変更検出機能の追加
2. 不要な描画更新の削除
3. エラー表示機能の実装

## テスト戦略

### 1. 単体テスト
- カーソル位置計算のテスト
- 入力範囲制限のテスト
- カーソル移動のテスト
- 時刻更新のテスト

### 2. 実機テスト
- カーソル表示位置の確認
- 入力範囲制限の動作確認
- カーソル移動の動作確認
- システム時刻更新の確認

### 3. 品質確認
- ちらつきの確認
- エラー表示の確認
- ユーザビリティの確認

## 成功指標

### Phase 1完了条件
- [x] カーソル表示位置が正確
- [x] 年千の位、年百の位が入力不可
- [x] カーソル移動が循環方式
- [x] システム時刻が正しく更新される

### Phase 2完了条件
- [x] 画面更新のちらつきが解消
- [x] エラー表示が適切に動作
- [x] ユーザビリティが向上

## リスク管理

### 技術的リスク
- **カーソル位置計算の複雑性**: 文字幅の正確な計算が困難
- **時刻更新の副作用**: 他の機能への影響
- **表示品質の改善**: パフォーマンスへの影響

### 対応策
- 段階的な実装とテスト
- 既存機能への影響を最小化
- パフォーマンスの監視

## スケジュール

### Week 1: Phase 1
- Day 1-2: カーソル表示位置の修正
- Day 3-4: 入力範囲制限の修正
- Day 5: カーソル移動の循環化

### Week 2: Phase 1継続 + Phase 2
- Day 1-2: システム時刻更新の実装
- Day 3-4: 表示品質の改善
- Day 5: 総合テスト

---

**作成日**: 2025年1月  
**バージョン**: 1.0.0  
**更新日**: 2025年1月 